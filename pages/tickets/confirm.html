<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>话费充值</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/Recharge.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
		<style type="text/css">
			.rechargeTitle{margin-top: 0;}
		</style>
		<style type="text/css">
			.mui-bar-nav{box-shadow: none !important;}
			body{background-color: #f3f3f3;}
			.liafter:after{
				content: '';
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(.5);
			}
			#main li{height: 50px;line-height: 50px;padding-left: 20px; padding-right: 20px;background-color: #fff;font-size: 15px;color: #333;}
			/*#main li span{font-size: 20px;color: #999;float: right;margin: 18px 10px 0;}*/
			.aClick:active{background-color: #eee !important;}
			#xieyi{text-align: center;margin-top: 60px;color: #e21919;font-size: 13px;}
			.r-text{
				width: 100px;
				float: left;
				text-align: left;
				font-size: 15px;color: #333;
			}
			.r-value{
				/*float: right;*/
				text-align: right;
				font-size: 15px;color: #333;
				vertical-align: baseline;
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.mui-icon-arrowright{
				position: absolute;
				right: 10px;
				top: 1px;
				color: #999;
				font-size: 20px;
			}
			.quan-box{
				height: 300px;
				margin: 0 8px;
				border-radius: 4px;
				background-color: #fff;
				overflow: scroll;
			}
			.quan-list{
				list-style: none;
				padding: 16px 10px;
			}
			.quan-list li{
				height: 60px;
				background-image: url('../../img/market/youhuihong.png');
				background-repeat: no-repeat;
	            background-origin: top left;
	            background-position: center;
	            background-size: 100% 100%;
	            margin-bottom: 18px;
	            background-color: #fff;
	            color: #fff;
			}
			.quan-list li p{
				color: #fff;
				padding-top: 15px;
				padding-left: 36px;
				font-size: 12px;
			}
			.submit{
				border: none;
				outline: none;
				height: 45px;
				width: 100%;
				background-color: #FF625F;
				color: #fff;
				font-size: 16px;
				letter-spacing: 2px;
			}
		</style>
	</head>
	<body >
		<header class="mui-bar mui-bar-nav fineB">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">确认订单</h1>
			<!--<a href="setup.html" class="fr shoucang sousuo mui-icon"><i class="iconfont icon-fenxiang"></i></a>-->
		</header>
		<script src="../../js/statusBar.js"></script>
		<div id="main" >
			<ul>
				<!--<li class="aClick" id="editdata" style="margin-top: 62px;">
					<p class="r-text">订单号</p>
					<p class="r-value">1232123123123212312</p>
				</li>-->
				<li class="aClick" id="editpw" style="margin-top: 72px;">
					<p class="r-text">手机号码</p>
					<p class="r-value">
						<span id="sjNUm"></span>
					</p>
				</li>
				<li class="aClick" style="margin-top: 1px;">
					<p class="r-text">商品描述</p>
					<p class="r-value" id="spms"></p>
				</li>
				<li class="aClick" style="margin-top: 1px;">
					<p class="r-text">交易金额</p>
					<p class="r-value" style="color: #f60;" id="jyje"></p>
				</li>
				<li class="aClick" id="appupgrade"  style="margin-top: 12px; position: relative;">
					<p class="r-text">电子券</p>
					<p class="r-value" id="selectQuan" style="padding-right: 14px;font-size: 14px;color: #8f8f94">无可用优惠券</p>
					<span class="mui-icon mui-icon-arrowright"></span>
				</li>
			</ul>
			<div style="margin-top: 35px;padding: 0 12px;">
				<button class="submit" id="submitBtnRecharge">确认</button>
			</div>
		</div>
		<div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
		    <!-- 可选择菜单 -->
		    <div class="quan-box">
		    	<ul class="quan-list" id="quanList">
			       
			    </ul>
		    </div>
		    <!-- 取消菜单 -->
		    <ul class="mui-table-view">
		      <li class="mui-table-view-cell">
		        <a href="#sheet1"><b>取消</b></a>
		      </li>
		    </ul>
		</div>
		<!--操作表   支付弹窗-->
		<div id="payChoose" class="mui-popover mui-popover-action mui-popover-bottom closePay">
			<div class="paycontent">
				<ul class="mui-table-view waypay">
					<p><span>支付方式</span></p>
					<li class="">
						<a id="alipay" data-pay="alipay"><img class="aClick2" src="../../img/tickets/zhifubao.png"></a>
					</li>
					<li class="">
						<a id="wxpay" data-pay="wxpay"><img class="aClick2" src="../../img/tickets/weixin.png"> </a>
					</li>
				</ul>
			</div>
		</div>
		<script type="text/javascript">

			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				var idNum = self.idNum;
				var mobileNo = self.mobileNo;
				var rechargeAmount = self.rechargeAmount;
				var userid = self.userid;
				var version = self.version;
				var platform = self.platform;
				var advice = self.advice;
				var yhqId = '';
				
				$("#sjNUm").text(mobileNo)
				$("#jyje").text(advice + '元')
				$("#spms").text('充值： '+rechargeAmount+ ' 元话费')

				$("#appupgrade").click(function(){
					mui('#sheet1').popover('toggle');
				})
				
				$("#submitBtnRecharge").click(function(){
					$("#payChoose").addClass("mui-active");
				})
				
				$(".closePay").click(function() {
					event.stopPropagation();
					$("#payChoose").removeClass("mui-active");
				})
			
				
				var cityNum = plus.storage.getItem('cityNum');
				var oldToken = plus.storage.getItem('oldToken');
				var myuserid = plus.storage.getItem('userid');
				var version = plus.storage.getItem('version');
				var platform  = plus.storage.getItem('platform');
				var pays = {};
				
				
				mui.ajax('http://abcd.zlzmm.com:6789/index.php/api/phonecard',{
					data: {
						userid: myuserid
					},
					type: 'post', //HTTP请求类型
					timeout: 10000, //超时时间设置为10秒
					success:function(data){
//						alert(JSON.stringify(data.data)) 
						if(data.data.length>0){
							$("#quanList").empty()
							$("#selectQuan").html("选择优惠券") 
							data.data.forEach(function(item){
								var str = '<li onclick="selectCard('+item.busno_id+', '+item.busno_sn+')">'
										str+= '<p>话费充值优惠券：'+item.busno_sn+'</p>'
										str+= '</li>'
								$("#quanList").append(str)
							})
						}else{
							$("#selectQuan").html("无可用优惠券喔~")
							var html = '<p style="text-align: center;">无可用优惠券</p>'
							$("#quanList").append(html)
						}
					},
					error: function(xhr, type, errorThrown){
//						alert(errorThrown)
					}
				})
				
				window.selectCard = function(id, name){
					yhqId = id
					$("#selectQuan").html("优惠券:"+ name)
					mui('#sheet1').popover('toggle');
					
				}
				
				
				//系统检测获取支付通道
				plus.payment.getChannels(function(channels) {
					console.log("channel " + JSON.stringify(channels));
					for(var i in channels) {
						var channel = channels[i];
						// 过滤掉不支持的支付通道：暂不支持360相关支付
						if(channel.id == 'qhpay' || channel.id == 'qihoo') {
							continue;
						}
						pays[channel.id] = channel;
						if(channel.id == 'alipay') { //添加支付事件
							document.getElementById('alipay').setAttribute('onclick', 'payfun("alipay")');
						}
						if(channel.id == 'wxpay') {
							document.getElementById('wxpay').setAttribute('onclick', 'payfun("wxpay")');

						}
						checkServices(channel);
					}
				}, function(e) {
					plus.nativeUI.alert("支付失败，请重试", null, "提示");
				});
				
				// 检测是否安装支付服务
				function checkServices(pc) {
					if(!pc.serviceReady) {
						var txt = null;
						switch(pc.id) {
							case "alipay":
								txt = "检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
								break;
							default:
								txt = "系统未安装“" + pc.description + "”服务，无法完成支付，是否立即安装？";
								break;
						}
						//						plus.nativeUI.confirm(txt,function(e){
						//							if(e.index==0){
						//								pc.installService();
						//							}
						//						},pc.description);
					}
				}
				
				window.payfun = function(id) {
					var varpay;
					if(id == 'alipay' || id == 'wxpay') {
						//调用支付功能
						plus.nativeUI.showWaiting();
						if(id == 'alipay') {
							//获取后台返回数据
							gopay(id);

						} else if(id == 'wxpay') { //微信
							gopay(id);
						}
					} else {
						plus.nativeUI.alert("当前环境不支持此支付通道！", null, "提示");
						return;
					}
					
					
					
					function gopay(id) {
						mui.ajax('http://abcd.zlzmm.com:6789/index.php/api/recharge', {
								data: {
									id:idNum,
									mobileNo: mobileNo,
									rechargeAmount: rechargeAmount,
									userid: userid,
									payType: id,
									version:version,
									platform:platform,
									token: oldToken,
									busno_id: yhqId,
									},
									type: 'post', //HTTP请求类型
									headers: {
										"token": oldToken
									},
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
										console.log(JSON.stringify(data))
//										alert(JSON.stringify(data)) 
										//记录缓存 
										var Recording = JSON.parse(plus.storage.getItem('Recording')) || [];
										if(Recording.length){
											mui.each(Recording,function (index,element) {
												if(element == mobileNo){
													Recording.splice(index,1);
													Recording.unshift(mobileNo);
													return false;
												}
												if(index == Recording.length-1){
													Recording.unshift(mobileNo);
												}
											})
										}else{
											Recording.unshift(mobileNo);
										}
										plus.storage.setItem("Recording",JSON.stringify(Recording));
										//记录缓存结束
										console.error(data);
//																alert(JSON.stringify(data))
										plus.nativeUI.closeWaiting()
//																alert("----- 请求订单成功 -----" + JSON.stringify(data));
//																var orderCost = data.data.BillData.data.orderCost; //总价
//																var saleAmount = data.data.BillData.data.saleAmount;//实际价格
//																var subject = data.data.BillData.data.itemName;//名称
//																var billId = data.data.BillData.data.billId;//订单号
//																var newOrderID = data.data.new_qianmi_order_id;

//																console.log("new_qianmi_order_id "+newOrderID+"billId "+billId+"noiftyData "+JSON.stringify(data.data.PaymentData))
										var varpay;
										if(id == 'wxpay') {
//																	varpay = {
//																		"appid": data.data.PaymentData.appid,
//																		"noncestr": data.data.PaymentData.noncestr,
//																		"package": "Sign=WXPay",
//																		"partnerid": data.data.PaymentData.partnerid,
//																		"prepayid": data.data.PaymentData.prepayid,
//																		"timestamp": parseInt(data.data.PaymentData.timestamp),
//																		"sign": data.data.PaymentData.sign
//																	};
											varpay = {
												"appid": data.data.appid,
												"noncestr": data.data.noncestr,
												"package": "Sign=WXPay",
												"partnerid": data.data.partnerid,
												"prepayid": data.data.prepayid,
												"timestamp": parseInt(data.data.timestamp),
												"sign": data.data.sign
											};
											console.log(JSON.stringify(data))
											//微信
											plus.payment.request(pays[id], varpay, function(result) {
												console.log("----- 支付成功 -----");
												$("#payChoose").removeClass("mui-active");
												var result = JSON.stringify(result)
												//修改状态
//																		mui.ajax(serverUrl+'/api/qianmi/paybill',{
//																			data:{new_qianmi_order_id:newOrderID,billId:billId,userid:myuserid,noiftyData:result},
//																			dataType:'json',//服务器返回json格式数据
//																			type:'post',//HTTP请求类型
//																			timeout:10000,//超时时间设置为10秒；
//																			headers:{"token":oldToken},
//																			success:function(data){
//																				plus.nativeUI.closeWaiting()
//																				 plus.nativeUI.alert("支付成功");
//																				  setTimeout(function(){
//																				 	openview({
//																						view:"../tickets/phone-record-de.html",
//																						extrasobj:{qianmiOrderID:newOrderID,Amount:rechargeAmount}
//																					})
//																				 },1000)
//																			},
//																			error:function(xhr,type,errorThrown){
//																				//异常处理；
//																				console.log(type);
//																			}
//																		});
											}, function(e) {
												console.log("----- 支付失败 -----");
//																		alert(JSON.stringify("[" + e.code + "]：" + e.message));
												console.log("[" + e.code + "]：" + e.message);
												plus.nativeUI.alert("支付失败");
											});
										} else {
											//支付宝
											console.log(JSON.stringify(data))
											varpay = data.data;
											console.log("----------------")
											console.log(JSON.stringify(varpay))
											plus.payment.request(pays[id], varpay, function(result) {
												console.log("----- 支付成功 -----", JSON.stringify(result));
												plus.nativeUI.closeWaiting();
												plus.nativeUI.alert("支付成功");
												$("#payChoose").removeClass("mui-active");
												var result = JSON.stringify(result)
//																		//修改状态
//																		mui.ajax(serverUrl+'/api/qianmi/paybill',{
//																			data:{new_qianmi_order_id:newOrderID,billId:billId,userid:myuserid,noiftyData:result},
//																			dataType:'json',//服务器返回json格式数据
//																			type:'post',//HTTP请求类型
//																			timeout:10000,//超时时间设置为10秒；
//																			headers:{"token":oldToken},
//																			success:function(data){
//																				plus.nativeUI.closeWaiting()
//																				 plus.nativeUI.alert("支付成功");
//																				  setTimeout(function(){
//																				 	openview({
//																						view:"../tickets/phone-record-de.html",
//																						extrasobj:{qianmiOrderID:newOrderID,Amount:rechargeAmount}
//																					})
//																				 },1000)
//																			},
//																			error:function(xhr,type,errorThrown){
//																				//异常处理；
//																				console.log(type);
//																			}
//																		});
											}, function(e) {
												console.log("----- 支付失败 -----");
												console.log("[" + e.code + "]：" + e.message);
												plus.nativeUI.closeWaiting();
												plus.nativeUI.alert("支付失败");
											});
										}
									},
									error: function(xhr, type, errorThrown) {
										//异常处理; 
										console.log(type);
										console.log("----- 请求订单失败 -----");
										console.log(xhr.status);
										plus.nativeUI.closeWaiting();
										plus.nativeUI.alert("获取订单信息失败！");
									}
								});

						}

					}
				
				
			})
		</script>
		<script type="text/javascript">
			//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
			//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
			mui.plusReady(function () {
				var startTime, endTime, stayTime, flagback = 0;
				startTime = new Date().getTime();
				var old_back = mui.back;
				//改写返回键返回的函数，返回时传页面停留时间
				mui.back = function(){
					endTime = new Date().getTime();//返回时间
					stayTime = Math.ceil((endTime - startTime) / 1000);
					console.log('购物中心'+stayTime);
					plus.statistic.eventDuration( "paymentBill", stayTime);
					//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
					old_back();
				}
				plus.webview.currentWebview().addEventListener( "popGesture", function(){
					flagback++;
					if(flagback == 1){
						endTime = new Date().getTime();
						stayTime = Math.ceil((endTime - startTime) / 1000);
						plus.statistic.eventDuration( "paymentBill", stayTime);
						//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
					}
				}, false );
			});
		</script>
	</body>
</html>
