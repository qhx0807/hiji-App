<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>申请退货</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		<link href="../../css/zyUpload.css" rel="stylesheet" />
		<style type="text/css">
			.mui-bar{
				height: 50px;
				box-shadow: none;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			#main{
				margin-top: 50px;
			}
			
			.guess-like,dl.list{
				border-bottom: 1px solid #eee;
				background-color: #EFEFF4;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			
			/*这一页*/
			.guess-like{
				padding-top:50px;
			}
			.react >div p{
				line-height: 50px !important;
			}
			dl.list {
				border-top: none;
				margin-top: 4%; 
			}
			.react{
				padding: 0 .15rem !important;
			}
			dl.list dt, dl.list dd{
				background-color: #fff;
			}
			.lineL{
				border-left: 1px solid #EFEFF4;
			}
			.phone{
				border: none;
			}
			dl.list dt, dl.list dd{
				border-bottom: 1px solid #EFEFF4;
			}
			#showCityPicker2,#payWayPicker{
				position: absolute;
				right: 10px;
				line-height: 49px;
				border: none;
				padding: 0;
				text-align: right;
				width: 75%;
				color: #666;
				background-color: rgba(0,0,0,0);
			}
			.react input{
				height: 50px;
				font-size: 14px;
				width: 100%;
			}
			#cityResult2,#payWay{
				line-height: 50px;
				font-size: 14px;
				display: inline-block;
				float: left;
				width: 100%;
				margin-right: 50px;
				color: #666;
				padding-left: 15px;
			}
			.goods{
				display: inline-block;
			}
			
			button, input, optgroup, select, textarea {
			 font: inherit; 
			 color: inherit; 
			}
			input[type=text]{
				border: none;
				margin-bottom: 0;
				color: #666;
			}
			.mui-icon{
				color: #666;
			}
			/*图片上传*/
	    	*{margin: 0;padding: 0;box-sizing: border-box;}
	    	.clearfix:after {content: ""; display: block; clear:both;}
	    	.uppics{text-align: center;border-bottom: 1px solid rgba(0,0,0,0.1);overflow-y: hidden;background-color: #fff;}
	    	.uppics div.onepic{height: 120px;padding: 0 !important;padding-top: 31px !important;font-size: 14px;}
		    .uppics div.onepic img{width: 50px;}
		    .uppics div.onepic input{width: 0;height: 0;position: absolute;outline: none;}
		    #uppics2{text-align: left;white-space: nowrap;overflow-x: scroll;}
		    #uppics2 div{display: inline-block;width: 120px;height:120px;vertical-align: middle;position: relative;text-align: center;padding: 10px;
		    background-color: #eee;margin-right: 6px;}
		    #uppics2 .onepic{width: 120px;background-color: #fff;}
		    #uppics2 .picimg{width: 100%;}
		    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
		    .tiny{
		    	font-size: 12px;
		    	line-height: 20px;
		    }
		    
		    #price{
		    	padding-left: 15px;
		    	color: #666;
		    }
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">申请退货退款</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="guess-like">
			<dl class="list" id="goodsList">
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p>退货原因</p>
				       	</div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<button id='payWayPicker' type='button'><span class="mui-icon mui-icon-arrowdown"></span></button>
							<div id='payWay' class="ui-alert">请选择退货原因</div>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p>退款金额</p>
				       </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<p id="price"><span></span><sub>（不可修改）</sub></p>
				        </div>
					</a>
				</dd>
				<dd class="goodsItem">
					<a class="react mui-row">
						<div class="mui-col-sm-3 mui-col-xs-3">
							<p>退货说明</p>
				       </div>
				        <div class="mui-col-sm-9 mui-col-xs-9">
				        	<input type="text" id="sendMobile" class="phone" placeholder="最多200字"/>
				        </div>
					</a>
				</dd>
			</dl>
		</div>
		<!--上传图片-->
		<div class="uppics clearfix">
	        <div class="onepic" >
	            <input type="file" id="file_input"/> 
	            <img src="../../img/zhaoxiangji.svg">
	            <p>上传凭证</p>
	            <p class="tiny">(最多3张)</p>
	        </div>
	    </div>
		<!--上传图片结束-->
	     <div class="renting-footer renting-footertwo clearfloat" onclick="send()">
			<ul>
				<li>提交申请</li>
			</ul>
		</div>
	</body>
	<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/mui.poppicker.js"></script>
	<script src="../../js/app.js"></script>
	<!--<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>-->
	<script>
		(function($, doc) {
			$.init();
			$.ready(function() {
				
				//退货原因选择
				var payWayPicker = new $.PopPicker();
				payWayPicker.setData([{
					value: 1,
					text: '质量原因'
				}, {
					value: 2,
					text: '颜色/款式/图案与描述不符'
				}, {
					value: 3,
					text: '假冒品牌'
				}, {
					value: 4,
					text: '效果不好/不喜欢'
				}, {
					value: 5,
					text: '材质、面料与商品描述不符'
				}, {
					value: 6,
					text: '大小尺寸与商品描述不符'
				}, {
					value: 7,
					text: '卖家发错货'
				}, {
					value: 8,
					text: '其他'
				}]);
				var paywayPicker = doc.getElementById('payWayPicker');
				var payResult = doc.getElementById('payWay');
				paywayPicker.addEventListener('tap', function(event) {
					payWayPicker.show(function(items) {
						payResult.innerText = items[0].text;
//						doc.getElementById('receiveAddress').name = items[0].value;
						//返回 false 可以阻止选择框的关闭
						//return false;
					});
				}, false);
			});
		})(mui, document);
	</script>
	<script type="text/javascript">
	//选择图片
	var onepic = document.getElementsByClassName('onepic')[0];
    var uppics = document.getElementsByClassName('uppics')[0];
    var p = document.getElementById('p');
    var time1 = null;
    var Apic = [];//存放图片数组
    var Indexes = 0;//当前删除
    onepic.onclick = function(){
    	var file_input = document.getElementById('file_input');
    	if(Apic.length<=4){
    		if(Apic.length ==4){
    			file_input.style.display = 'none';
    		}else{
    			file_input.style.display = 'inline-block';
    		}
			
        uppics.id = 'uppics2';
        var imgnode = document.createElement("div");
        clearInterval(time1);
        time1 = setInterval(function(){
            console.log('加载中');
            if (file_input.files[0]) {
                clearInterval(time1);
                var reader = new FileReader();
                Apic.push(file_input.files[0]);
                var picname = file_input.files[0].name;
                reader.readAsDataURL(file_input.files[0]); 
                reader.onload = function(e){
                    imgnode.innerHTML = '<img class="picimg1 '+picname+'" src="../../img/shanchu.svg"/><img class="picimg" src="'+this.result+'"/>';
                    document.getElementsByClassName('picimg1')[Indexes].onclick = function(){
                        this.parentNode.parentNode.removeChild(this.parentNode);
                        var dename = this.className.slice(8);
                        for (var i = 0; i < Apic.length; i++) {
                            if (Apic[i].name == dename) {
                               Apic.splice(i,1);
                            }
                        }
                        Indexes--;
                    }
                    Indexes++;
                }
                uppics.appendChild(imgnode);
                file_input.value = '';
            }
        },500)
       }else{
       	file_input.style.display = 'none';
       	mui.toast('最多选择五张');
       }
    }
	//选择图片结束
	
	//上传部分
	mui.plusReady(function(){
		var orderId = plus.webview.currentWebview().orderId;
		var oldToken = plus.storage.getItem('oldToken');
		var userId = plus.storage.getItem('userid');
		var price = plus.webview.currentWebview().price;
		$('#price span').html(price);
		
//		点击提交申请
		window.send = function(){
			var buyer_reason = $('#payWay').html();
			var refund_reason = $('#sendMobile').val();
//					
			var formD = new FormData();
			for (var j=0; j<Apic.length; j++) {
//				console.log('添加评论图片');
				formD.append('pic',Apic[j]);
			} 
			formD.append('orderId',orderId); 
			formD.append('userId',userId);
			formD.append('returns_type',1); 
			formD.append('refund_selection',1);//1 仅退款
			formD.append('buyer_reason',buyer_reason);
			formD.append('refund_reason',refund_reason);
			var xhr = new XMLHttpRequest(); 	
			xhr.open('POST',serverUrl+'/api/mall/applyofrefund');
			xhr.onreadystatechange = function(){ 
				if (xhr.readyState===4) {
					if (xhr.status===200) {
						var dataobj = JSON.parse(xhr.responseText);
//      					console.log(dataobj);
						if(dataobj.errno == 0){
							mui.toast('发布成功');	
							//触发跳转页面刷新
							plus.nativeUI.showWaiting('跳转中 ...',{width:'100px',height:'80px'});//显示等待框
							mui.fire(plus.webview.getWebviewById('sc-order'),'refresh');//打开指定页面
							mui.fire(plus.webview.getWebviewById('orderDetail'),'refresh');//打开指定页面
							plus.webview.getWebviewById('../market/ruturnList.html').close();
							var time1 = setTimeout(function(){
								plus.webview.currentWebview().close();//关闭当前页面
								plus.nativeUI.closeWaiting();
							},1000)
						}else{
							mui.toast('发布失败');	
						}
					}
				}
	        }
			xhr.setRequestHeader("token",oldToken);
			xhr.send(formD);
		}

	})
</script>
</html>