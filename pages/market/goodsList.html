<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>商品列表</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
		<script src=" ../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>

		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			/*这一页*/
			.grade-eject, .Category-eject, .Sort-eject{
				height: 120px;
			}
			div.screening>ul{padding: 5px 5px;}
			div.screening>ul>li{
				border-left: none!important;
			}
			div.screening>ul{
				border-bottom:1px solid #eee;
			}
			dl.list dt, dl.list dd,dl.list{
				border-bottom: 0;
				margin: 0 5px;
				position: relative;
			}
			dl.list dt:not(:last-child):after, dl.list dd:not(:last-child):after,dl.list:not(:last-child):after{
				content: '';
				position: absolute;
				bottom: 0;
				left: 0;
				width: 100%;
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .dealcard-block-right:after{
				content: '';
				position: absolute;
				bottom: 0;
				display: none;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .title, .cinemacard .title{
				color: #999;
				font-size: 12px !important;
			}
			.dealcard .strong, .dealcard .strong{
				color: #999;
				font-size: 20px !important;
				line-height: 30px;
			}
			.dealcard .title, .dealcard .price{
				height: 30px;
				margin: 5px 0;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			.dealcard .title span{
				top: 0;
				left: 0;
				position: relative;
			}
			.bage{
				width: 100%;
			}
			dl.list .dd-padding, dl.list dt, dl.list dd>.react {
				padding: 10px;
				margin: 10px 0;
			}
			.dealcard .dealcard-brand, .cinemacard .cinemacard-brand{
				font-size: 16px;
			}
			.dealcard .dealcard-brand{
				width: 100%;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				display: block;
			}
			.dealcard .title span, .dealcard .price span {
				font-size: .12rem;
			}
			.dealcard .dealcard-img{
				width: 30%;
				height: auto !important;
				max-height: 106px !important;
				margin-top: -10px;
				border-radius: 0 !important;
			}
			.dealcard .dealcard-block-right {
				padding-left: 10px;
				float: right;
				width: 70%;
				max-height: 106px;
				overflow: hidden;
			}
			.imgbox{
				background-image: none;
			}
			.dealcard-img img {
				max-width: 100%;
				max-height: 106px;
			}
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			.Regional{
				background-image: none !important;
			}
			#main{padding-top: 46px !important;}
			.guess-like{padding-top: 0 !important;}
			#screendiv{
				position: fixed;left: 0;top: 50px;height: 400px;width: 100%;background-color: #fff;
				z-index: 30;color: #555;overflow-y: scroll;padding-bottom: 50px;
			}
			.mui-bar{z-index: 40 !important;}
			#Maskdiv{position: fixed;left: 0px;top: 50px;height: 100%;width: 100%;background-color: rgba(0,0,0,0.4);
				z-index: 20;}
			.badyhide{position: fixed;height: 100%;width:100%; top: 0;left: 0;overflow: hidden;}
			.screenin{padding: 10px;}
			.screenin h4{    font-size: 14px;
			    padding-left: 3px;
			    margin: 4px 1px;}
			.screenla{display: inline-block;position: relative;margin: 5px 2px;}
			.screenla label, .screenla span{
			    display: inline-block;
			    text-align: center;
			    padding: 7px 10px;
			    margin: 2px;
			}
			.screenla span{border: 1px solid #d2cece;
			    border-radius: 3px;
			    box-sizing: border-box;}
			.screenla label{position: absolute; width: 100%;height: 100%;border: none;box-shadow: none;}
			.screenla input{position: absolute; width: 0; height: 0;border: none;}
			.screenla input:checked~span{
				background-color: rgba(230, 31, 31, 0.82);
				color: #fff;
				border: 1px solid rgba(230, 31, 31, 0.82);
			}
			.screenin:after{
				content: '';
				display: block;
				height: 1px;
				background-color: #eee;
				-webkit-transform: scaleY(.5);
			}
			.screenfoot{position:fixed;z-index:31;top: 406px;left: 0; width:100%;height: 45px;line-height: 45px;background-color: #eee;font-size: 14px;}
			.screenfoot span{float: right;padding: 0 15px;}
			#upload{min-height: 30px;line-height: 10px;}
			#upload img{width: 40px;margin-top: -10px;padding: 4px !important;}
			.goodsItem{background-color: #fff};

			.screening,.Sort-height{position: relative;background: none;top:98px!important;}
			#Categorytw,#Sort-Sort{position: absolute;margin-top:8px;height: auto;}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{border-bottom: none!important;position: relative;}
			.grade-eject>ul>li:after, .Category-eject>ul>li:after, .Sort-eject>ul>li:after{content: '';
				display: block;
				height: 1px;
				background-color: #eee;
				-webkit-transform: scaleY(.5);right: 5px;}
			div.screening>ul>li{
				background: url(../../img/localLife/xiala.png) no-repeat 68% center;
    				background-size: 12%;
			}
		</style>
	</head>
	<body class="">

		<header class="mui-bar mui-bar-nav" id="header">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize" style="padding-left: 10px;" ></a>
		    <h1 class="mui-title" id="">商品列表</h1>
			<a class="fr mui-icon" id="screenbtn" style="font-size: 15px;padding-right: 14px;padding-top: 2px;">筛选</a>
		</header>
		<div id="Maskdiv" style="display: none;"></div>
		<div class="screenfoot" id="screenfoot" style="display: none; top:406px;transform: -webkit-translate3d(0px, -401px, 0px);transition: -webkit-transform 0.3s ease-out;"><span id="determine">确定</span></div>
		<div id="screendiv" style="top:50px;transform: -webkit-translate3d(0px, -401px, 0px);transition: -webkit-transform 0.3s ease-out;">
			<div class="screenin" id="screenin1">
				<h4>品牌</h4>
				<div id="pingpaidiv">
					<div class="screenla">
						<label for="sss"></label>
						<input type="radio" checked="" name="state" id="sss" />
						<span id="span1">不限</span>
					</div>
				</div>
				<script type="text/html" id="pingpai">
					<%for(var i=0; i<list.length; i++){%>
						<%if(list[i].brand){%>
							<div class="screenla">
								<label for=""></label>
								<input type="radio" name="state" id="" />
								<span id=""><%= list[i].brand%></span>
							</div>
						<%}%>
					<%}%>
				</script>

				<div id="" style="margin-bottom: 20px;"></div>
			</div>
		</div>
		<script type="text/javascript">
			(function(){//兼容关闭方法
				mui('body')[0].className = '';
				mui('#Maskdiv')[0].style.display = 'none';
				mui('#screendiv')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
				mui('#screenfoot')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
			})();
		</script>

	 	<div class="screening" id="screeningdiv" style="top: 50px;">
		    <ul>
		        <li class="Brand">综合 &nbsp;&nbsp</li>
		        <li class="Regional" id="Salesvolume">销量</li>
		        <li class="Sort" id="goodsprice">价格 &nbsp;&nbsp</li>
		    </ul>
		</div>

		<div class="Category-eject">
		    <ul class="Category-w" id="Categorytw">
		        <li id="Newping">新品</li>
		        <li id="evaluate">评价</li>
		    </ul>
		</div>
		<div class="Sort-eject Sort-height">
		    <ul class="Sort-Sort" id="Sort-Sort">
		        <li id="Hightolow">从高到低</li>
		        <li id="lowtoHigh">从低到高</li>
		    </ul>
		</div>
		<script src="../../js/statusBar.js"></script><!--状态栏-->


		<div id="main">
			<div class="guess-like">
				<dl class="list" id="goodsList" >
					<!--列表loading-->
					<div id="loadingdiv" style="text-align: center;font-size: 14px;height:30px;background-color: #f2f1ee;
						line-height: 30px;color: #666;-webkit-transition: all .3s;">
						<img style="width: 25px;margin-top: -3px;" src="../../img/loading2.svg"/> 拼命加载中...
					</div>
					<!--列表loading结束-->
				</dl>
			</div>
			<div class="upload text-center text-xs gray" id="upload"></div>
			<div id="nulldiv" style="text-align:center;margin-top: 40%;font-size: 14px;color: #999;display: none;">
				<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
				<br />
				没有相关信息
			</div>
		</div>

		<!--模板渲染数据-->
		<script id="goodsList-detail" type="text/html">
			<%if(list.length==0){%>
				<div style="font-size:14px;color:gray;padding: 10px;text-align: center;">暂无数据,看看别的吧</div>
			<%}else{%>
				<% for(var i=0;i<list.length;i++){ %>
				<dd class="goodsItem aClick">
					<a class="react" onclick="goInfo(<%= list[i].goods_id %>)">
						<div class="dealcard">
							<div class="dealcard-img imgbox">
								<% if(list[i].thumb && list[i].thumb != ' '){%>
									<img src="<%=myurl%><%= list[i].thumb %>"/>
								<% }else{%>
									<img data="<%=myurl%><%= list[i].thumb %>" src="../../img/nopic.svg"/>
								<% }%>
							</div>
							<div class="dealcard-block-right">
								<div class="dealcard-brand single-line"><%= list[i].title %></div>
								<div class="title text-block bage">
									品牌: <%= list[i].brand %>
								</div>
								<div class="price mui-row">
									<div class="mui-col-sm-4 mui-col-xs-4">
										<span class="strong-color">￥</span><span class="strong"><%= list[i].price %></span>
									</div>
									<span class="mui-col-sm-4 mui-col-xs-4 middle Lgray">评价<%= list[i].comments %>条</span>
									<span class="mui-col-sm-4 mui-col-xs-4 right Lgray">已售<%= list[i].sales %></span>
								</div>
							</div>
						</div>
					</a>
				</dd>
			<% } %>
			<%}%>

		</script>
	</body>

	<script type="text/javascript">
		/*  滚动加载,修复点
		 * 1,定义全局变量can1,can2,传至 滚动加载中
		 * 2,定义实到,应到变量是全局
		 * 3,其他见代码
		 */
		var Spagenum;//实到页数
		var Ypagenum;//应到页数

		$('.Sort').click(function(){
			if(!$('.Sort-eject').hasClass("grade-w-roll")){
				$('.Sort-eject').addClass("grade-w-roll")
			}else{
				$('.Sort-eject').removeClass("grade-w-roll")
			}
		})

		mui.plusReady(function(){
			//plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			//获取缓存
			var oldToken = plus.storage.getItem('oldToken'),
		 		cityNum = plus.storage.getItem('cityNum');
			//获取页面传值 商品分类id
			var goodcatId = plus.webview.currentWebview().goodscatId;
			var dfid = plus.webview.currentWebview().dfid;
			var can1 = 'sales',can2 = 'desc',can3 = '';
			//显示品牌信息
			mui.ajax(serverUrl+'/api/mall/mallbrand',{
				data:{categoryid:goodcatId},
				type:'post',
				timeout:5000,
				headers:{"token":oldToken,'city':cityNum},
				success:function(data,type,xhr){
					console.log('品牌返回',data);
					if(data.errno == 0){
						var objdata = {};
						objdata.list = data.data;
						var html=template("pingpai",objdata);
						document.getElementById("pingpaidiv").innerHTML += html;



					}
				}
			});
			//按照选择排序
			window.order = function(orderType,sequence,brand){
				document.getElementById("goodsList").innerHTML = loadstr;
				Spagenum = 2;//实到页数
				Ypagenum = 1;//应到页数
				can1 = orderType,can2 = sequence,can3 = brand;
				var pagenum = 10,CcurrentPage = 1,sequence1 = sequence;
				mui('#nulldiv')[0].style.display = 'none';
				//plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
					data:{
						currentPage:CcurrentPage,
						numsPerPage:pagenum,
						categoryid:goodcatId,
						recommend:'',
						differentiate:dfid,
						storeid:'',
						brand:can3,
						keyword:'',
						order_type:can1,
						desc:can2
					},
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},
					success:function(data,type,xhr){
					console.log('列表返回0',data);
					if(data.errno == 0){
						console.log('总条数'+data.data.return.totalPages);
						if(data.data.return.data.length){
							var objdata = {};
							objdata.myurl = serverimgUrlE;
							objdata.list = data.data.return.data;
							var html=template("goodsList-detail",objdata);
							document.getElementById("goodsList").innerHTML += html;
							mui("#upload")[0].innerHTML = "";
						}else{
							mui("#upload")[0].innerHTML = "";
							mui('#nulldiv')[0].style.display = 'block';
						}

						//滚动到底部加载
						function getScrollTop(){//滚动条在Y轴上的滚动距离
						　　var scrollTop = 0, bodyScrollTop = 0, documentScrollTop = 0;
						　　if(document.body){
						　　　　bodyScrollTop = document.body.scrollTop;
						　　}
						　　if(document.documentElement){
						　　　　documentScrollTop = document.documentElement.scrollTop;
						　　}
						　　scrollTop = (bodyScrollTop - documentScrollTop > 0) ? bodyScrollTop : documentScrollTop;
						　　return scrollTop;
						}
						function getScrollHeight(){//文档的总高度
						　　var scrollHeight = 0, bodyScrollHeight = 0, documentScrollHeight = 0;
						　　if(document.body){
						　　　　bodyScrollHeight = document.body.scrollHeight;
						　　}
						　　if(document.documentElement){
						　　　　documentScrollHeight = document.documentElement.scrollHeight;
						　　}
						　　scrollHeight = (bodyScrollHeight - documentScrollHeight > 0) ? bodyScrollHeight : documentScrollHeight;
						　　return scrollHeight;
						}
						function getWindowHeight(){//浏览器视口的高度
						　　var windowHeight = 0;
						　　if(document.compatMode == "CSS1Compat"){
						　　　　windowHeight = document.documentElement.clientHeight;
						　　}else{
						　　　　windowHeight = document.body.clientHeight;
						　　}
						　　return windowHeight;
						}
						window.onscroll = function(){
						　　if(getScrollTop() + getWindowHeight() == getScrollHeight()){
								if(Spagenum<=data.data.return.totalPages && Spagenum==Ypagenum+1){//实到页数小于等于总页数时发起请求,并且实到=应到
									mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									Ypagenum++;//满足加载情况,应到页数+1
									console.log('发起请求,实到'+Spagenum+'页');
									console.log('发起请求,应到'+Ypagenum+'页');
									mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
										data:{
											currentPage:Spagenum,
											numsPerPage:pagenum,
											categoryid:goodcatId,
											recommend:'',
											differentiate:dfid,
											storeid:'',
											brand:can3,
											keyword:'',
											order_type:can1,
											desc:can2
										},
										type:'post',
										timeout:5000,
										headers:{"token":oldToken},
										success:function(data,type,xhr){
											console.log('列表返回',data);
											if(data.errno == 0){
												var objdata = {};
												objdata.myurl = serverimgUrlE;
												objdata.list = data.data.return.data;
												var html=template("goodsList-detail",objdata);
												document.getElementById("goodsList").innerHTML+=html;
											}
											mui("#upload")[0].innerHTML = " ";
											Spagenum++;//加载成功,当前页+1
											console.log('成功+1,实到'+Spagenum);
											console.log('成功+1,应到'+Spagenum);
										},
										error:function(xhr,type,errorThrown){
											Ypagenum--;//失败是应到-1
											mui.toast("当前网络不好请重试");
											mui("#upload")[0].innerHTML = "";
										}
									});
								}else if(Spagenum == data.data.return.totalPages+1){//当前页不小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "到底了";
								}
						　　}
						};//滚动加载


					}else{
						mui("#upload")[0].innerHTML = "";
						mui('#nulldiv')[0].style.display = 'block';
					}
					closeLoad();//关闭列表loading
				},
				error:function(xhr,type,errorThrown){
					closeLoad();//关闭列表loading
					mui("#upload")[0].innerHTML = "";
					mui('#nulldiv')[0].style.display = 'block';
				}
				});

				$('.Category-eject').removeClass('grade-w-roll');
				$('.Sort-eject').removeClass('grade-w-roll');
				$('.grade-eject').removeClass('grade-w-roll');
			}
			order(can1,can2,can3);//初始化

			//筛选
			var screenin1s = mui('#screenin1')[0].getElementsByClassName('screenla');
			var upclose = function(){//关闭方法
				mui('body')[0].className = '';
				mui('#Maskdiv')[0].style.display = 'none';
				mui('#screendiv')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
				mui('#screenfoot')[0].style.webkitTransform = 'translate3d(0, -401px, 0)';
			}
			mui('#screenbtn')[0].addEventListener('tap',function(){
				if(mui('body')[0].className == 'badyhide'){
					upclose();
				}else{//展开
					mui('body')[0].className = 'badyhide';
					mui('#Maskdiv')[0].style.display = 'block';
					mui('#screendiv')[0].style.webkitTransform = 'translate3d(0, 0, 0)';
					mui('#screenfoot')[0].style.webkitTransform = 'translate3d(0, 0, 0)';
				}
			})
			//筛选确定
			var nowstr = '';
//			mui('#determine')[0].onclick = function(){
//				upclose();
//				for(var i=0; i<screenin1s.length; i++){
//					var nowinput = screenin1s[i].getElementsByTagName('input')[0];
//					if(nowinput.checked == true){
//						nowstr = screenin1s[i].getElementsByTagName('span')[0].innerHTML;
//						break;
//					}
//				}
//				if(nowstr != '不限'){
//					order(can1,can2,nowstr);//初始化
//				}else{
//					nowstr = '';
//					order(can1,can2,nowstr);//初始化
//				}
//			}
			//点击即搜索
	 		var ulNode=document.getElementById("pingpaidiv");
	 		ulNode.addEventListener('click',function(e){
		 		if(e.target&&e.target.nodeName.toUpperCase()=="INPUT"){
		 			nowstr = e.target.parentNode.childNodes[5].innerHTML;
		 			if(nowstr != '不限'){
						order(can1,can2,nowstr);//初始化
					}else{
						nowstr = '';
						order(can1,can2,nowstr);//初始化
					}
					upclose();
		 		}
	 		},false);


			//其他筛选方法
			var clickFlag = false;
			mui('#Salesvolume')[0].onclick = function(){//销量
				if(clickFlag){
					clickFlag = false;
					order('sales','desc',nowstr);//从高到低
				}else{
					clickFlag = true;
					order('sales','asc',nowstr);
				}

			}
			mui('#Newping')[0].onclick = function(){//新品
				clickFlag = true;
				order('create_time','desc',nowstr)
			}
			mui('#evaluate')[0].onclick = function(){//评价
				clickFlag = true;
				order('comments','desc',nowstr)
			}
			mui('#Hightolow')[0].onclick = function(){//从高到低
				clickFlag = true;
				order('price','desc',nowstr);
			}
			mui('#lowtoHigh')[0].onclick = function(){//从低到高
				clickFlag = true;
				order('price','asc',nowstr);
			}

			//跳转详情
			window.goInfo =  function(goodsId){
				 openview({
				 	view:"mall-detail.html",
				 	extrasobj:{goodsId:goodsId}
				 })
			}
		})();
	</script>
	<script type="text/javascript">
		//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
		//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
		mui.plusReady(function () {
			var startTime, endTime, stayTime, flagback = 0;
			startTime = new Date().getTime();
			var old_back = mui.back;
			//改写返回键返回的函数，返回时传页面停留时间
			mui.back = function(){
				endTime = new Date().getTime();//返回时间
				stayTime = Math.ceil((endTime - startTime) / 1000);
				console.log('购物中心'+stayTime);
				plus.statistic.eventDuration( "specialBarClass", stayTime);
				//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				old_back();
			}
			plus.webview.currentWebview().addEventListener( "popGesture", function(){
				flagback++;
				if(flagback == 1){
					endTime = new Date().getTime();
					stayTime = Math.ceil((endTime - startTime) / 1000);
					plus.statistic.eventDuration( "specialBarClass", stayTime);
					//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				}
			}, false );
		});
	</script>
</html>