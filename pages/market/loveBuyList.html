<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>爱 购 列 表 </title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
		<script src=" ../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript" ></script>
		
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript" ></script>
		<style type="text/css">
			/*这一页*/
			 .grade-w-roll{
			 	top: 50px!important;
			 }
			div.screening>ul>li{
				border-left: 1px solid #eee !important;
			}
			div.screening>ul{
				border-bottom:1px solid #eee; 
			}
			dl.list dt, dl.list dd,dl.list{
				border-bottom: 0;
				margin: 0 5px;
				position: relative;
			}
				.gocart{
				position: fixed;
				right: 0.2rem;
				bottom: 0.2rem;
				height: 0.5rem;
				width: 0.5rem;
				background-color: #f53c42;
				border-radius: 50%;
				border: 0;
				box-sizing: border-box;
				z-index: 999;
				padding: 0;
				text-align: center;
				line-height: 0.5rem;
				box-shadow: 0px 0px 2px 2px rgba(208, 145, 145, 0.4);
			}
			.gocart img{
				width: 60%;
			} 
			dl.list dt:not(:last-child):after, dl.list dd:not(:last-child):after,dl.list:not(:last-child):after{
				content: '';
				position: absolute;
				bottom: 0;
				left: 0;
				width: 100%;
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .dealcard-block-right:after{
				content: '';
				position: absolute;
				bottom: 0;
				display: none;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(0.5);
			}
			.dealcard .title, .cinemacard .title{
				color: #999;
				font-size: 12px !important;
			}
			.dealcard .strong, .dealcard .strong{
				color: #999;
				font-size: 20px !important;
				line-height: 30px;
			}
			.dealcard .title, .dealcard .price{
				height: 30px;
				margin: 5px 0;
			}
			.right{
				text-align: right;
			}
			.middle{
				text-align: center;
			}
			.strong-color{
				color: #f53c42 !important;
			}
			.Lgray{
				font-size: 12px !important;
				color: #999 !important;
				margin-top: 14px;
			}
			.mui-badge-blue, .mui-badge-primary{
				background-color: #fff;
				border: 1px solid #999;
				color: #999 !important;
			}
			.dealcard .title span{
				top: 0;
				left: 0;
				position: relative;
			}
			.bage{
				width: 100%;
			}
			dl.list .dd-padding, dl.list dt, dl.list dd>.react {
				padding: 10px;
				margin: 10px 0;
			}
			.dealcard .dealcard-brand, .cinemacard .cinemacard-brand{
				font-size: 16px;
			}
			.dealcard .dealcard-brand{
				width: 100%; 
				display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;
				min-height: 40px; 
				line-height: 20px;
				
			}
			.dealcard .title span, .dealcard .price span {
				font-size: .12rem;
			}
			.dealcard .dealcard-img{
				width: 30%;
				height: auto !important;
				max-height: 106px !important;
				margin-top: -10px;
				border-radius: 0 !important;
			}
			.dealcard .dealcard-block-right {
				padding-left: 10px;
				float: right;
				width: 70%;
				max-height: 106px;
				overflow: hidden;
			}
			.imgbox{
				padding: 10px;
				background-image: none;
			}
			.dealcard-img img {
				max-width: 100%;
				max-height: 106px;
			}
			.moreone{
				line-height: 50px;
			}
			dl.list .db>.react{
				padding: 0;
				margin: 0;
			}
			dl.list .db{
				height: 50px;
			}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{
				line-height: 40px;
			}
			.Regional{
				background-image: none !important; 
			}
			.guess-like{
				padding-top: 0;
			}
			.mui-bar-nav.mui-bar .mui-icon{margin-left: 0 !important;}
			
		</style>
	</head>
	<body>
		 
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">跨境优品</h1>
			<a href="javascript:;" style="line-height: 50px;color:white;" class="fr brand">分类</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		
		<div class="gocart"><img src="../../img/center/gocart.svg" alt="" /></div> 
		<div id="container">
			<div id="main">
				  
			    <!-- Category -->
				<div class="Category-eject">
				    <ul class="Category-w" id="Categorytw">
				         
				    </ul>
				    <script type="text/html" id="fcid">
				    	<li onclick="Categorytw(this)">全部品牌</li>
				    	<%for(var i=0;i< list.length;i++){%>
				    		 <li onclick="Categorytw(this)" data-id = "<%= list[i].catid%>"><%= list[i].catname%></li>
				    		<%}%>
				       
				         
				    </script>
				    <ul class="Category-t" id="Categoryt">
				      
				    </ul>
				    <script type="text/html" id="scid"> 
				    	<%for(var i=0;i< list.length;i++){%>
				    		 <li onclick="Categoryt(this)" data-id = "<%= list[i].catid%>"><%= list[i].catname%></li>
				    		<%}%>
				       
				         
				    </script>
				    <ul class="Category-s" id="Categorys">
				        
				    </ul>
				    <script type="text/html" id="tcid"> 
				    	<%for(var i=0;i< list.length;i++){%>
				    		 <li onclick="Categorys(this)" data-id = "<%= list[i].catid%>"><%= list[i].catname%></li>
				    		<%}%>
				       <li onclick="Categorys(this)">其他</li>
				         
				    </script> 
				</div>
				
				
				<script type="text/javascript">
						var immersed = 20;
					 
						var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
						if(ms&&ms.length>=3){ // 当前环境为沉浸式状态栏模式
						    immersed=parseFloat(ms[2]);// 获取状态栏的高度
						}  
						$(".Category-eject").css("margin-top",immersed+"px"); 
				</script>
				 
				</div>  
				<div class="guess-like">
					<dl class="list" id="goodsList">
						 
					</dl>
				</div>
			</div>
		<!--模板渲染数据-->
		<script id="goodsList-detail" type="text/html">
			<%if(list.length==0){%>
			<%}else{%>
				<% for(var i=0;i<list.length;i++){ %>
					
					<%if(list[i].num>=10){%>
						<dd class="goodsItem">
							<a class="react" onclick="goInfo(<%= list[i].open_iid%>,'<%=list[i].bussinesno%>',3,'<%= list[i].thumb%>')">
								<div class="dealcard">
									<div class="dealcard-img imgbox" >
		 
										<img src="<%= list[i].thumb%>" onerror="javascript:this.src='../../img/zhaoxiangji.svg';"/>
		
									</div>
									<div class="dealcard-block-right">
										<div class="dealcard-brand single-line"><%= list[i].title %></div>
										 
										<div class="price mui-row">
											<div class="mui-col-sm-4 mui-col-xs-4">
												<span class="strong-color">￥</span><span class="strong"><%= list[i].price %></span>
												<span style="margin-left: 15px;">库存:<%=list[i].num%></span>
												
											</div>
											
										</div>
									</div>
								</div>
							</a>
						</dd>
					<%}%>
			<% } %>
			<%}%>
			
		</script>
		<div class="upload text-center text-xs gray" id="upload"></div>
		<div id="nulldiv" style="text-align:center;margin-top: 5px;font-size: 14px;color: #999;display: none;">
			没有更多了
		</div>
	</body>
	<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
	 
	<script type="text/javascript"> 
		mui.plusReady(function(){
			//去购物车
			document.getElementsByClassName("gocart")[0].addEventListener('tap',function () {
				openview({
					view: "../cart.html",
					id:'cart',
					extrasobj: {
						pageId: "detail"
					}
				})
				var list = plus.webview.getWebviewById('cart');
				//触发列表界面的自定义事件（refresh）,从而进行数据刷新
				mui.fire(list, 'refresh');
			});
			//获取缓存
			var oldToken = plus.storage.getItem('oldToken'); 
		 		plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			var Spagenum = 2; //实到页数
			var Ypagenum = 1; //应到页数
			//切换分类
			var pid = 0;
			$(".brand").on("tap",function(){ 
				$(".Category-eject").toggleClass("grade-w-roll");
				if($(".Category-eject").hasClass("grade-w-roll")){
					mui.ajax(serverUrl+'/api/mall/igocategory',{
						data:{pid:pid},
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"token":oldToken},	 
						success:function(data,type,xhr){
							  
							if(data.errno == 0){
								if(data.data.length != 0){
									var tyepdata ={};
									tyepdata.list = data.data;
									var html=template("fcid",tyepdata);
									document.getElementById("Categorytw").innerHTML=html;
								}  
								
								//点击一级分类
								 $(".Category-w>li").click(function(){
							        $(".Category-t").css("left","33.48%");
							           //获取二级分类
								        mui.ajax(serverUrl+'/api/mall/igocategory',{
											data:{pid:$(this).attr("data-id")},
											dataType:'json',
											type:'post',
											timeout:10000,
											headers:{"token":oldToken},	 
											success:function(data,type,xhr){ 
												if(data.errno == 0){
													if(data.data.length != 0){
														var tyepdata ={};
														tyepdata.list = data.data;
														var html=template("scid",tyepdata);
														document.getElementById("Categoryt").innerHTML=html;
														
														//点击二级分类
														 	$(document).ready(function(){
															  $(".Category-t>li").click(function(){
															      $(".Category-s").css("left","66.96%");
															      //获取三级分类
															       mui.ajax(serverUrl+'/api/mall/igocategory',{
																		data:{pid:$(this).attr("data-id")},
																		dataType:'json',
																		type:'post',
																		timeout:10000,
																		headers:{"token":oldToken},	 
																		success:function(data,type,xhr){ 
																			if(data.errno == 0){
																				if(data.data.length != 0){
																					var tyepdata ={};
																					tyepdata.list = data.data;
																					var html=template("tcid",tyepdata);
																					document.getElementById("Categorys").innerHTML=html;
																				}
																			}
																		},
																		error:function(xhr,type,errorThrown){
																				plus.nativeUI.closeWaiting();//关闭等待框 
																			}
																		})
															  });
															  
															  
															});
															window.Categoryt = function(tbj){
															    var arr = document.getElementById("Categoryt").getElementsByTagName("li");
															    for (var i = 0; i < arr.length; i++){
															        var a = arr[i];
															        a.style.background = "";
															    };
															    tbj.style.background = "#fff"
															}
													}
												}
											},
											error:function(xhr,type,errorThrown){
												plus.nativeUI.closeWaiting();//关闭等待框 
											}
										})
							    });
								window.Categorytw = function(wbj){
									 
								    var arr = document.getElementById("Categorytw").getElementsByTagName("li");
								    for (var i = 0; i < arr.length; i++){
								        var a = arr[i];
								        a.style.background = "";
								    };
								    wbj.style.background = "#eee";
								   
								}
								
								
							}
							
						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting();//关闭等待框
							mui("#upload")[0].innerHTML = ""; 
							mui('#nulldiv')[0].style.display = 'block';
						}
					});
				}
			})
			var category = plus.webview.currentWebview().pid;
	 		getsecid(category); 
			//获取二级分类
			function getsecid(pid){
				mui.ajax(serverUrl+'/api/mall/igocategory',{
					data:{pid:pid},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){  
						if(data.errno == 0){
							if(data.data.length != 0){
								//请求三级分类 
								for(var j=0;j<data.data.length;j++){
									getthird(data.data[j].catid)
								}
							}
						}
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();//关闭等待框 
					}
				})
			}
			
			//三级分类
			function getthird(catid){
				mui.ajax(serverUrl+'/api/mall/igocategory',{
					data:{pid:catid},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){ 
						if(data.errno == 0){ 
							if(data.data.length != 0){
								//渲染列表
								for(var j=0;j<data.data.length;j++){
									getList(data.data[j].catid,"all")
								}
							}
						}
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();//关闭等待框 
					}
				})
			}
			var curid;
			function getList(category_id,alllist){
				curid = category_id;
				//数据渲染
				var currentPage =1, numsPerPage = 50;
				mui.ajax(serverUrl+'/api/mall/igogoodslist', {
					data: {
						categoryid: category_id,
						currentPage: currentPage,
						numsPerPage: numsPerPage
					},
					dataType:'json',
					type:'post',
					timeout:15000,
					headers:{"token":oldToken},	 
					success:function(data,type,xhr){
						console.log("列表数据",data)
						plus.nativeUI.closeWaiting() 
						if(data.errno == 0) {
//							if(data.data && data.data.length){
								var bannerArray = data.data.data; //{img1:dd,img2:aa,img3,cc}   
								for(var i in bannerArray) { 
									bannerArray[i].price = Math.floor(bannerArray[i].price*100)/100;
										if(bannerArray[i].thumb.indexOf('net.') > -1) {
											bannerArray[i].thumb = bannerArray[i].thumb.replace(/net./g, 'net')
										} 
								}
								var objdata = {};
								objdata.list = bannerArray;
								
								var html=template("goodsList-detail",objdata);
								if(alllist){
									document.getElementById("goodsList").innerHTML+=html;
								}else{ 
									document.getElementById("goodsList").innerHTML=html;
								}
								mui("#upload")[0].innerHTML = "";
			                    //上滑加载
			                   	$(window).scroll(function(){ 
									　　var scrollTop = $(this).scrollTop();
									　　var scrollHeight = $(document).height();
									　　var windowHeight = $(this).height();
									　　if(scrollTop + windowHeight == scrollHeight){ 
											if(Spagenum <= data.data.totalPages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
										
											mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";  
											Ypagenum++; //满足加载情况,应到页数+1
											console.log('发起请求,实到' + Spagenum + '页');
											console.log('发起请求,应到' + Ypagenum + '页');
											mui.ajax(serverUrl+'/api/mall/igogoodslist', {
												data: {
													categoryid: category_id,
													currentPage: Spagenum,
													numsPerPage:numsPerPage
												},
												dataType:'json',//服务器返回json格式数据
												type:'post',//HTTP请求类型 
												timeout:15000,//超时时间设置为10秒；	
												headers:{"token":oldToken}, 
												success:function(data){
													if(data.errno == 0) { 
														var bannerArray = data.data.data; //{img1:dd,img2:aa,img3,cc}   
														for(var i in bannerArray) { 
																bannerArray[i].price = Math.floor(bannerArray[i].price*100)/100;
																if(bannerArray[i].thumb.indexOf('net.') > -1) {
																	bannerArray[i].thumb = bannerArray[i].thumb.replace(/net./g, 'net')
																} 
														}
														var objdata = {};
														objdata.list = bannerArray;
														var html=template("goodsList-detail",objdata);
														document.getElementById("goodsList").innerHTML+=html;
													}
													mui("#upload")[0].innerHTML = " "; 
													Spagenum++; //加载成功,当前页+1
													console.log('成功+1,实到' + Spagenum);
													console.log('成功+1,应到' + Spagenum);
												},
												error:function(xhr,type,errorThrown){ 
													Ypagenum--; //失败是应到-1
													mui.toast("当前网络不好请重试");
													mui("#upload")[0].innerHTML = "";
												}
											});
									 	} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
											mui("#upload")[0].innerHTML = "到底了";
										}
									  }
									});//加载下一部分结束
//									}
									if($('#goodsList dd').length == 0){
										document.getElementById("goodsList").innerHTML='<div style="padding: 30px;text-align: center;font-size: 14px">暂无商品</div>';
									}
							 
						}
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();//关闭等待框
						mui("#upload")[0].innerHTML = ""; 
						mui('#nulldiv')[0].style.display = 'block';
					}
				});
				 
			}
			
			//点击三级分类
			window.Categorys = function(sbj){
			    var arr = document.getElementById("Categorys").getElementsByTagName("li");
			    for (var i = 0; i < arr.length; i++){
			        var a = arr[i];
			        a.style.borderBottom = "";
			    };
			    sbj.style.borderBottom = "solid 1px #ff7c08";
			    $(".Category-eject").removeClass("grade-w-roll");
			    getList(sbj.getAttribute("data-id"));
			}
			//跳转详情
			window.goInfo =  function(goodsId,shopid,differentiate,img){  
				 openview({
				 	view:"yphDetail.html",
				 	id:"yphDetail",
				 	extrasobj:{goodsId:goodsId,shopId:shopid,differentiate:differentiate}
				 })
			}
			
		})();
		
		
	</script>
	<script type="text/javascript">
		//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
		//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
		mui.plusReady(function () {
			var startTime, endTime, stayTime, flagback = 0;
			startTime = new Date().getTime();
			var old_back = mui.back;
			//改写返回键返回的函数，返回时传页面停留时间 
			mui.back = function(){
				endTime = new Date().getTime();//返回时间
				stayTime = Math.ceil((endTime - startTime) / 1000);   
				console.log('购物中心'+stayTime); 
				plus.statistic.eventDuration( "loveToGogoodsClass", stayTime);
				//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				old_back(); 
			}
			plus.webview.currentWebview().addEventListener( "popGesture", function(){
				flagback++;
				if(flagback == 1){
					endTime = new Date().getTime();
					stayTime = Math.ceil((endTime - startTime) / 1000);  
					plus.statistic.eventDuration( "loveToGogoodsClass", stayTime);
					//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				}
			}, false );
		});
	</script> 

</html>