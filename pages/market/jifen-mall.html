<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>积分商城</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../css/one.css">
		<script src="../../js/jquery-1.8.2.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/hmt.js" type="text/javascript"></script>
	</head>
	<style type="text/css">
		.single-line{
			font-size: 0.16rem!important;
		}
		.rcdPadding{
				position: relative;
				display: inline-block;
				padding-top: 100%;
				width: 100%;
				overflow: hidden;
			}
			.rcdPadding img{
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%!important;
				bottom: 0;
			}
		.dealcard, .cinemacard {
			position: relative;
			/* box-sizing: border-box; */
			    margin: 0 0 0.2rem 0;
		}
		/*加载*/
			#upload{
				text-align: center;margin-bottom: 15px;margin-top:15px;font-size: 12px;
			}
			#upload img{width: 60px;margin-top: -27px;}
		.jifenbtn{
			margin-top: -0.05rem;
		    background-color: #f53c42;
		    border: none;
		    color: white;
		}
		.topjf{
			background-color: #F53C42;
		    color: white;
		    padding: 0.3rem 0 0.4rem;
		    text-align: center;
		     margin-bottom: 0.1rem;
			}
			.topjf img{
				width: 0.2rem;
				vertical-align: bottom;
			}
			.topL{
				padding: 0.3rem 0.7rem 0;
			}
			.topL span{
				display: inline-block;
				width: 50%;
				border: 1px solid white;
				padding: 0.1rem 3%;
			}
			.topL span:first-child{
				border-right: 0;
				border-radius: 15px 0 0 15px;
			}
			.topL span:last-child{
				border-radius: 0 15px 15px 0;
			}
			.jftit{
				font-size: 0.16rem;
				white-space: nowrap;
				overflow: hidden;
				line-height: 1.5;
				text-overflow: ellipsis;
				text-align: center!important;
				margin-top: 5px;
			}
			.small{
				display: inline-block;
				width: 100%;
				margin: auto;
				text-align: center!important;
				margin: 5px 0;
				color: #f53c42;
				font-size: 0.15rem;
			}
			.small img{
				width: 0.15rem;
			}
			.jgbutton .box{
				margin-bottom: 0.15rem;
				/*box-shadow: 0px 0px 1px rgba(0,0,0,0.1);*/
			}
			#main{margin-top: 0 !important;}
			header{
				background-image: none;
			}
	</style>
	<body style="background-color: white;">
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">积分商城</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main" style="padding-top: 0 !important;">
			<div class="topjf">
				<img src="../../img/market/jftop.svg"alt="" /><span id="jf" style="font-size: 0.4rem;"></span>
				<div class="topL">
					<span onclick="goMX()">收支明细</span><span onclick="goRd()">兑换记录</span>
				</div>
			</div>
			<div class="sy_recmd_list_box">
				<ul>
					<div id="goodsList"></div>
					<script type="text/html" id="goodsList-detail">
						<%if(list.length==0){%>
							<div style="font-size:14px;color:gray;padding: 10px;text-align: center;">暂无数据,看看别的吧</div>
						<%}else{%>
							<% for(var i=0;i<list.length;i++){ %>
							<li class="sy_recmd_list jgbutton" data-id="<%= list[i].goods_id %>">
								<div class="box">
									<div class="pub_img">
										<a class="rcdPadding">
											<%if(list[i].thumb){%>
												<img src="<%=myurl%><%= list[i].thumb %>"></a>
												<%}else{%>
													<img src="../../img/market/mhot2.jpg"></a>
													<%}%>
											</div>
										<div class="pub_wz">
											<h3 class="jftit"><%= list[i].title %></h3>
											<div class="small"><img src="../../img/market/jifen.svg"alt="" />&nbsp;<%= list[i].price %></div>
										      	 
										</div>
									</div>

								</li>

							<% } %>
							<%}%>
						</script>
						<div class="clearfloat"></div>
						<div class="upload text-center text-xs gray" id="upload"></div>
						<div id="nulldiv" style="text-align:center;margin-top: 40%;font-size: 14px;color: #999;display: none;">
							<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
							<br />
							没有相关信息
						</div>
					</ul>
					<div class="clear"></div>
				</div>
			</div>
		</div>
	</body>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		 mui("#main").on('tap','.jgbutton',function(){
            	var goodsid = this.getAttribute('data-id');
            	openview({
            		view:"jifen_detail.html",
            		id:"jifen_detail",
            		extrasobj:{goodsId:goodsid}
            	})
            })
		 function goMX(){
		 	openview({
        		view:"../personal/jfguanli.html",
        		id:"jfguanli",
        	})
		 }

		 function goRd(){
		 	openview({
        		view:"jifen-order.html",
        		id:"jifen-order",
        	})
		 }
	 mui.plusReady(function(){
	 			var myuserid = plus.storage.getItem('userid');
					var oldtoken = plus.storage.getItem('oldToken');
	        plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
			//获取积分
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},
				success:function(data,type,xhr){
					var intergral=0;
					console.log('获取用户数据返回'+JSON.stringify(data));
					if(data.errno == 0){
						   intergral = data.data[0].intergral;
						   if(intergral==null){
						   	intergral=0;
						   }
						 document.getElementById("jf").innerHTML = intergral;
					}else{
						mui.toast('获取用户信息失败');
						console.log(data.errmsg);

					    plus.nativeUI.closeWaiting()
					}

				},
				error:function(xhr,type,errorThrown){
					console.log('响应失败  !');
				}
			});

			//获取积分商品
				var pagenum =6,CcurrentPage = 1;
				plus.nativeUI.showWaiting('加载中 ...',{width:'100px',height:'80px'});//显示等待框
				mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
					data:{currentPage:CcurrentPage,numsPerPage:pagenum,categoryid:'',recommend:'',differentiate:2,storeid:'',brand:'',keyword:'',order_type:'',desc:''},
					type:'post',
					timeout:10000,
					headers:{"token":oldtoken},
					success:function(data,type,xhr){
					if(data.errno == 0){
						if(data.data.return.data.length){
							var objdata = {};
							objdata.myurl = serverimgUrl;
							data.data.return.data.price = parseInt(data.data.return.data.price);
							objdata.list = data.data.return.data;

							var html=template("goodsList-detail",objdata);
							document.getElementById("goodsList").innerHTML=html;
							mui("#upload")[0].innerHTML = "";
							plus.nativeUI.closeWaiting();
							//滚动到底部加载
						$(window).scroll(function(){
						　　var scrollTop = $(this).scrollTop();
						　　var scrollHeight = $(document).height();
						　　var windowHeight = $(this).height();
						　　if(scrollTop + windowHeight == scrollHeight){
								//加载下一部分
							  var nowpage = ++CcurrentPage;
								if(nowpage<=data.data.return.totalPages){//当前页小于等于总页数时请求下一页
									mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
									console.log('可以请求数据');
									mui.ajax(serverUrl+'/api/mall/mallgooodslist',{
										data:{currentPage:CcurrentPage,numsPerPage:pagenum,categoryid:'',recommend:'',differentiate:2,storeid:'',brand:'',keyword:'',order_type:'',desc:''},
										type:'post',
										timeout:10000,
										headers:{"token":oldtoken},
										success:function(data,type,xhr){
											console.log(JSON.stringify(data));
											if(data.errno == 0){
												var objdata = {};
												objdata.myurl = serverimgUrl;
												objdata.list = data.data.return.data;
												var html=template("goodsList-detail",objdata);
												document.getElementById("goodsList").innerHTML+=html;
												mui("#upload")[0].innerHTML = "上滑加载 ";
											}else{
												--CcurrentPage;//请求失败,继续请求当前页
												mui.toast("获取数据失败");
											}
											plus.nativeUI.closeWaiting();//关闭等待框
										},
										error:function(xhr,type,errorThrown){
											--CcurrentPage;//请求失败,继续请求当前页
											mui.toast("当前网络不好请重试");
										}
									});
								}else{
									mui("#upload")[0].innerHTML = "到底了";
								}
								//加载下一部分结束
							　　}
						});

						}else{
							document.getElementById("#upload")[0].innerHTML = "";
							document.getElementById('#nulldiv')[0].style.display = 'block';
							plus.nativeUI.closeWaiting()
						}

					}else{
						mui.toast('没有数据');
					}
					plus.nativeUI.closeWaiting();//关闭等待框
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();//关闭等待框
					mui.toast('没有数据');
				}
				});
	 })
	</script>
</html>
