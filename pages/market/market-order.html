<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商品订单确认 </title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/Recharge.css">
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<style type="text/css">
			.mui-bar {
				height: 50px;
				box-shadow: 0px 1px #eee!important;
			}

			.mui-title,
			.mui-icon {
				line-height: 50px;
			}

			.mui-bar .mui-icon {
				padding: 0;
			}

			#main {
				margin-top: 50px;
			}
			/*这一页*/

			.kv-line-r>h6,
			.kv-line-r>.kv-k {
				font-size: 13px;
			}

			.boxs {
				margin-bottom: 10px;
			}

			.boxs li {
				border-top: 0;
			}

			.boxstwo li a {
				width: 100%;
			}

			.mui-icon-location {
				width: 100%;
				text-align: center;
				margin-left: -7px;
			}

			.mui-col-sm-9 {
				padding-left: 15px;
			}

			.ico_arrow {
				position: absolute;
				top: 0;
				margin: 23px 0;
			}

			.phoneNum {
				float: right;
			}

			strong p {
				padding: 5px 10% 5px 0;
				line-height: 20px;
				color: #333;
			}

			.address {
				text-overflow: ellipsis;
				white-space: nowrap;
				overflow: hidden;
			}

			.middle-icon {
				padding: 4px 0;
			}

			.addBtn {
				background-color: #ff9100 !important;
				border: 1px solid #ff9100 !important;
			}

			.mui-numbox {
				width: 100px;
				height: 30px;
				padding: 0 30px;
			}

			.mui-numbox .mui-btn {
				width: 30px;
			}

			.addTitle {
				line-height: 30px;
			}

			.quanc {
				width: 0.3rem;
				margin-right: 0.1rem;
				display: none;
			}

			dl.list .dd-paddingtwo {
				padding: .08rem .15rem .08rem .15rem;
			}

			.addTitle img {
				width: 100%;
			}

			dl.list {
				border: 1px solid #eee;
			}

			dl.list dt,
			dl.list dd {
				border-bottom: 0px solid #eee;
				position: relative;
			}

			dl.list dt:after,
			dl.list dd:after {
				content: '';
				display: block;
				height: 1px;
				-webkit-transform: scaleY(0.3);
				background-color: rgba(0, 0, 0, 0.1);
				position: absolute;
				width: 100%;
				bottom: 0;
				left: 0;
			}

			dl.list dt:last-child:after,
			dl.list dd:last-child:after {
				height: 0;
			}

			.price {
				color: #ff5f32;
				line-height: 28px;
				font-size: 16px;
			}

			.kv-line-r>p span {
				color: #ff5f32;
			}

			.price sub {
				bottom: 0;
			}

			.num {
				float: right;
				color: #333;
			}

			p,
			h6 {
				color: #333;
			}

			.postWrap {
				background: #fff url(../../img/market/post.png) no-repeat bottom;
				background-size: 100%;
			}

			.boxstwo li a {
				margin: 10px 0;
			}

			#container {
				padding-bottom: 50px;
			}

			.goods p {
				padding: 3px 0;
				line-height: 20px;
			}

			.goodsDetail {
				font-size: 12px;
				color: #999;
				line-height: 15px !important;
			}

			.tips {
				margin-bottom: 0 !important;
				border: none !important;
				font-size: 14px;
				line-height: 16px;
			}

			.tipsWrap,
			.ztWrap {
				padding: 0 0.15rem !important;
			}

			.tipsWrap input,
			.ztWrap input {
				padding: 0 !important;
			}

			.tipsWrap h6,
			.ztWrap h6 {
				line-height: 40px;
				margin-right: 0;
			}

			.tipsWrap h6 .goods,
			.ztWrap h6 .goods {
				padding-left: 0;
			}

			dl.list dd dl {
				padding-left: 0;
			}

			dl.list dd dl>.dd-padding,
			dl.list dd dl dd>.react,
			dl.list dd dl>dt {
				padding: 0.15rem;
			}

			.goodsWrap {
				background-color: #fafafa;
			}

			.comm_btn {
				margin: 0;
				height: 50px;
				line-height: 50px;
				padding: 0;
				width: 100%;
				text-align: center;
			}

			.fixed .btn {
				border: none !important;
				bottom: 0;
				right: 0;
				width: 25%;
			}

			.fixed p {
				width: 75%;
				text-align: right;
			}

			.priceWrap {}

			.priceWrap p {
				text-align: right !important;
				display: block;
				font-size: 16px;
				width: 100%;
			}

			.priceWrap p sub {
				bottom: 0;
			}

			#coupon .mui-checkbox,
			.checkQuan .mui-checkbox,
			.waypay .mui-checkbox {
				position: absolute;
				top: 50%;
				margin-top: -18px;
				right: 0;
			}

			.mui-checkbox input[type=checkbox]:checked:before,
			.mui-radio input[type=radio]:checked:before {
				color: rgb(245, 60, 66);
			}

			.mui-card {
				margin: 0;
			}

			.checkQuan {
				padding: 2px 15px;
				border: 1px solid #f53c42;
				border-radius: 5px;
				line-height: 18px;
				margin: 5px 0;
				position: relative;
			}

			.checkQuan .mui-col-sm-3 {
				width: 28%;
				padding: 12px 5px;
			}

			.checkQuan .mui-col-sm-9 {
				width: 72%;
				padding: 12px 15px;
				border-left: 1px dotted #f53c42;
			}

			.cred {
				color: #f53c42;
			}

			.dateLimit {
				font-size: 12px;
			}

			#sfzin {
				width: -moz-calc(100% - 70px)!important;
				width: -webkit-calc(100% - 70px)!important;
				width: calc(100% - 70px)!important;
				font-size: 12px;
				padding: 0;
				text-align: right;
				background: none;
				height: auto;
				margin: 0;
				line-height: 12px;
				border: none;
			}

			.sf:after {
				height: 0px!important;
			}

			.mui-checkbox.mui-left label {
				padding-right: 15px;
				padding-left: 46px;
				padding-top: 14px;
			}

			.mui-radio input[type=radio]:before {
				font-size: 20px;
			}

			.mui-radio input[type=radio] {
				top: -20px;
			}

			.charge {
				color: coral;
			}

			.choosewl {
				position: relative;
				width: 100vw;
				left: 50%;
				right: 50%;
				margin-left: -50vw;
				margin-right: -50vw;
				padding: inherit!important;
			}

			.choosewl.mui-active a {
				background: #EEEEEE;
			}

			.dlc div {
				width: 100%;
				font-size: 0.12rem;
				line-height: 2;
				position: relative;
			}

			.dlc div:not(:last-of-type):after {
				position: absolute;
				right: 0;
				bottom: 0;
				content: '';
				left: 0;
				height: 1px!important;
				-webkit-transform: scaleY(0.3);
				-webkit-transform-origin: bottom;
				background-color: #D1D2D4;
			}

			.wlway {
				padding-right: 15px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">订单</h1>
		</header>
		<script src="../../js/statusBar.js"></script>
		<!--状态栏-->
		<div id="container">
			<div id="main">
				<form class="wrapper-list">
					<ul class="boxs boxstwo postWrap">
						<div id="add_info"></div>
						<script type="text/html" id="addrTpl">
							<%if(obj.length==0){%>
							<li onclick="goAddr()">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<p style="line-height: 50px;">请选择收货地址</p>
										<p class="address"></p>
										<div class="fr"><i class="ico_arrow middle-icon"></i></div>
									</div>
								</div>
							</li>
							<%}else{%>
							<li onclick="goAddr()" id="addid" data-id="<%=obj[0].id%>" data-name="<%=obj[0].person%>" data-address="<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%>" data-phone="<%=obj[0].phone%>">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<strong>
											<p>收货人：<%=obj[0].person%><span class="phoneNum"><%=obj[0].phone%></span></p>
											<p class="address">收货地址：<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%></p>
											<div class="fr"><i class="ico_arrow middle-icon"></i></div>
										</strong>
									</div>
								</div>
							</li>

							<%}%>
						</script>

					</ul>
					<div id="orderTpl"></div>
					<script type="text/html" id="orderData">
						<%for(var i =0;i<goodsList.length;i++){%>
						<dl class="list">
							<dd class="dd-padding kv-line-r">
								<h6><img src="../../img/market/shop.png" style="width: 0.2rem;vertical-align: middle;" alt="" />
									<%if(goodsList[i].order_type == 0){%>
										<%=goodsList[i].store_id%>
									<%}else{%>
										<%=goodsList[i].stores.store_name%>
									<%}%>
								</h6>
							</dd>
							<%for(var j =0;j<goodsList[i].goods_Data.length;j++){%>
							<dd class="dd-padding kv-line-r mui-row goodsWrap">
								<% if(goodsList[i].goods_Data[j].youpin){%>
								<h6 class="addTitle mui-col-sm-4 mui-col-xs-4" id="aigou"><img src="<%=goodsList[i].goods_Data[j].youpin.thumb%>" onerror="javascript:this.src='../../img/market/none.png';"/></h6>
								<%}else{%>
								<h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="<%=myurl%><%=goodsList[i].goods_Data[j].thumb%>" onerror="javascript:this.src='../../img/market/none.png';"/></h6>

								<%}%>
								<div class="clearfloat fr mui-col-sm-8 mui-col-xs-8 goods">
									<p>
										<%=goodsList[i].goods_Data[j].title%>
									</p>
									<p class="goodsDetail">
										<%if(goodsList[i].goods_Data[j].differentiate != 0){%>
											<%if(goodsList[i].goods_Data[j].stend1 && goodsList[i].goods_Data[j].value1){%>
												<%=goodsList[i].goods_Data[j].stend1%>:
												<%=goodsList[i].goods_Data[j].value1%>;
											<%}%>
											<%if(goodsList[i].goods_Data[j].stend2 && goodsList[i].goods_Data[j].value2){%>
												<%=goodsList[i].goods_Data[j].stend2%>:
												<%=goodsList[i].goods_Data[j].value2%>;
											<%}%>
											<%if(goodsList[i].goods_Data[j].stend3 && goodsList[i].goods_Data[j].value3){%>
												<%=goodsList[i].goods_Data[j].stend3%>:
												<%=goodsList[i].goods_Data[j].value3%>;
											<%}%>
											<%if(goodsList[i].goods_Data[j].stend4 && goodsList[i].goods_Data[j].value4){%>
												<%=goodsList[i].goods_Data[j].stend4%>:
												<%=goodsList[i].goods_Data[j].value4%>;
											<%}%>
										<%}%>
									</p>
									<p class="price"><sub>￥</sub>
										<span class="pricemoney"><%=goodsList[i].goods_Data[j].price_total%></span> <span class="num">x<span class="numint"><%=goodsList[i].goods_Data[j].nums%></span></span>
									</p>
									<%if(goodsList[i].order_type!=0 && goodsList[i].GoodsFavourablePrice && goodsList[i].GoodsFavourablePrice[j].favourablePrice){%>
									<small style="color: coral;font-size: 0.12rem;" class="goodrd">商品优惠<sub>-￥</sub> <%=goodsList[i].GoodsFavourablePrice[j].favourablePrice%></small>
									<%}%>

									<%if(goodsList[i].order_type == 0){%>
									<samll style="font-size:0.1rem;color: gray;">税费
										<span class='taxmoney'><%=goodsList[i].goods_Data[j].tax%></span> </samll>
									<%}%>
								</div>
							</dd>
							<%}%>
							<%if(goodsList[i].order_type!=0 && goodsList[i].StoreFavourablePrice.favourablePrice){%>
							<dd class="dd-padding kv-line-r mui-row ztWrap" data-id="<%=goodsList[i].store_id%>">
								<h6 class="addTitle mui-col-sm-3 mui-col-xs-3">店铺优惠</h6>

								<div class="clearfloat fr mui-col-sm-9 mui-col-xs-9 goods">
									<span class="fr storereduce" style="line-height: 40px;color: coral;" id="<%=goodsList[i].store_id%>">￥<%=goodsList[i].StoreFavourablePrice.favourablePrice%></span>
								</div>
							</dd>
							<%}%>
							<%if((goodsList[i].order_type==0 && goodsList[i].actualPrice>=88 && !goodsList[i].postAge.postage) || (goodsList[i].total_goods_weight == 0 && goodsList[i].order_type!=0 && goodsList[i].postAge.express_id != -2) || ((goodsList[i].postAge.maxNums == 1 || goodsList[i].postAge.maxMoney == 1) && goodsList[i].postAge.express_id != -2)){%>
								<dd class="dd-padding kv-line-r postfeeWrap ddwl">
									<h6>配送方式</h6>
									<p class="jifen">包邮</p>
								<%}else{%>
								<%if(goodsList[i].order_type==0){%>
								<dd class="dd-padding kv-line-r postfeeWrap ddwl">
									<h6>配送方式</h6>
									<p class="jifen">EMS ￥
										<%=goodsList[i].postAge.postage%>
									</p>
									<%}else if((goodsList[i].postAge.maxNums == 1 || goodsList[i].postAge.maxMoney == 1 || goodsList[i].total_goods_weight == 0) && goodsList[i].postAge.express_id == -2){%>
									<dd class="dd-padding kv-line-r postfeeWrap ddwl">
										<h6>配送方式</h6>
										<p class="jifen">自提
										</p>
										<%}else{%>
									<dd class="dd-padding kv-line-r postfeeWrap ddwl" style="padding: 0.1rem 0.15rem;">
										<li class="mui-table-view-cell mui-collapse choosewl">
											<a class="mui-navigate-right getwl" data-id='0' data-weight='<%=goodsList[i].total_goods_weight%>' data-storeid="<%=goodsList[i].store_id%>" data-igetShopId="<%=goodsList[i].order_type%>" href="#">
												<%if(goodsList[i].postAge.postage){%>
													<h6 style="display: inline-block;font-size: 13px;">配送方式</h6><span class="fr wlway jifen">运费 ￥<%=goodsList[i].postAge.postage%></span></a>
												<%}else if(goodsList[i].postAge.express_id == -2){%>
													<h6 style="display: inline-block;font-size: 13px;">配送方式</h6><span class="fr wlway jifen">自提</span></a>
												<%}else{%>
													<h6 style="display: inline-block;font-size: 13px;">配送方式</h6><span class="fr wlway jifen">选择物流</span></a>
												<%}%>

											<div class="mui-collapse-content dlc" data-shopmoney="<%=goodsList[i].actualPrice%>">
											</div>
										</li>
										<%}%>
										<%}%>

									</dd>
									<%if(goodsList[i].order_type==0 ){%>
									<dd class="dd-padding kv-line-r postfeeWrap">
										<h6>购买即同意<span onclick="gosearule()" style="color: orangered;"> 《跨境电商购物协议》</span></h6>
									</dd>
									<%}%>
									<%if(goodsList[i].order_type!=0){%>
									<dd class="dd-padding kv-line-r mui-row ztWrap" data-id="<%=goodsList[i].store_id%>">
										<input type="hidden" class="isziti" value="0" data-id='' />
										<h6 class="addTitle mui-col-sm-3 mui-col-xs-3">是否自提</h6>
										<%%>
										<div class="clearfloat fr mui-col-sm-9 mui-col-xs-9 goods">
										<%if(goodsList[i].postAge.express_id == -2){%>
											<div class="mui-checkbox ddRadio"><input name="checkbox<%=i%>" data-shopId="<%=goodsList[i].store_id%>" data-postfee="0" class="groupCheck" type="checkbox" checked="" style="right: 5px;"></div>
										<%}else{%>
											<div class="mui-checkbox ddRadio"><input name="checkbox<%=i%>" data-shopId="<%=goodsList[i].store_id%>" data-postfee="0" class="groupCheck" type="checkbox" style="right: 5px;"></div>
										<%}%>
										</div>
									</dd>
									<%if(shopaddress[i] && goodsList[i].postAge.express_id == -2){%>
									<dd class="dd-padding kv-line-r mui-row ztWrap ztaddress">
										<h6 class="addTitle mui-col-sm-3 mui-col-xs-3">自提地址：<%=shopaddress[i]%></h6>
									</dd>
									<%}%>

									<%}%>
									<dd class="dd-padding kv-line-r mui-row tipsWrap" data-id="<%=goodsList[i].store_id%>">
										<h6 class="addTitle mui-col-sm-2 mui-col-xs-2">备注：</h6>
										<div class="clearfloat fr mui-col-sm-10 mui-col-xs-10 goods">
											<input type="text" id="" value="" placeholder="选填（对本次交易的说明）" class="tips" style="bottom: 1px;" />
										</div>
									</dd>
									<dd class="kv-line-r dd-padding priceWrap">
										<p>
											小计:<b style="color: #ff5f32;">￥</b></sub>
											<span class="J_total-price groupMoney" data-id="0"><%=goodsList[i].actualPrice%></span>
										</p>
									</dd>
						</dl>

						<%}%>
						<div class="fixed">
							<p>合计：<span class="show_delivery_fee">￥<span id="submit_order"><%=PriceCalculValue%></span></span>
							</p>
							<span class="fr btn">
								<a onclick="goPay()" class="comm_btn">提交订单</a>
							</span>
						</div>
					</script>

					<dl class="list">

						<div id="quanData"></div>
						<script type="text/html" id="quanTpl">
							<%if(allLi.length!=0){%>

							<dd>
								<div class="mui-card">
									<ul class="mui-table-view">

										<li class="mui-table-view-cell mui-collapse">
											<a class="mui-navigate-right" style="border-bottom: 1px solid #eee;padding: 15px;" href="#">抵用券 <b class="minuMoney cred" style="display: none;">-￥<span id="minuMoney"></span></b><span class="fr" style="margin-right: 15px;">选择</span></a>
											<div class="mui-collapse-content">
												<% for(var i=0;i<allLi.length;i++){ %>
												<%if(allLi[i].typeid==1){%>

													<div class="checkQuan mui-row" data-cid="<%=allLi[i].user_coupon_id%>" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].coupon_amount%>">
														<div class="mui-col-sm-3">
															<div>￥<big><b><%=allLi[i].coupon_amount%></b></big></div>
															<div><small>全场通用</small></div>
														</div>
														<div class="mui-col-sm-9">
															<div class="cred"><big><%=allLi[i].name%></big> 全场通用抵扣<span><%=allLi[i].coupon_amount%></span></div>
															<div class="dateLimit">
																<%=allLi[i].begin_date%> ~
																<%=allLi[i].end_date%>内有效</div>
														</div>
														<div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
													</div>

												<%}else if(allLi[i].typeid==3){%>
													<div class="checkQuan mui-row" data-cid="<%=allLi[i].user_coupon_id%>" data-amount="<%=allLi[i].coupon_amount[0]%>" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].coupon_amount[1]%>">
														<div class="mui-col-sm-3">
															<div>￥<big><b><%=allLi[i].coupon_amount[1]%></b></big></div>
															<div><small>全场通用</small></div>
														</div>
														<div class="mui-col-sm-9">
															<div class="cred"><big><%=allLi[i].name%></big> 全场满¥<%=allLi[i].coupon_amount[0]%>减<span>¥<%=allLi[i].coupon_amount[1]%></span></div>
															<div class="dateLimit">
																<%=allLi[i].begin_date%> ~
																<%=allLi[i].end_date%>内有效</div>
														</div>
														<div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
													</div>
												<%}else{%>
													<div class="checkQuan mui-row" data-cid="<%=allLi[i].user_coupon_id%>" data-amount="<%=allLi[i].coupon_amount[0]%>" data-id="<%=allLi[i].typeid%>" data-minus="<%=allLi[i].coupon_amount[1]%>">
														<div class="mui-col-sm-3">
															<div><big><b><%=allLi[i].coupon_amount[1]*10%></b></big>折</div>
															<div><small>满<%=allLi[i].coupon_amount[0]%>通用</small></div>
														</div>
														<div class="mui-col-sm-9">
															<div class="cred"><big><%=allLi[i].name%></big> <span><%=allLi[i].coupon_amount[1]*10%></span>折</div>
															<div class="dateLimit">
																<%=allLi[i].begin_date%> ~
																<%=allLi[i].end_date%>内有效</div>
														</div>
														<div class="mui-checkbox"><img src="../../img/market/xuanze.png" class="quanc" data-id="<%=allLi[i].user_coupon_id%>" alt="" /></div>
													</div>
												<%}%>
												<%}%>
											</div>
										</li>
									</ul>
								</div>

							</dd>

							<%}%>

						</script>

						<div id="coupon"></div>
						<script type="text/html" id="couponTpl">
							<%if(intergral!=0){%>
							<dd class="dd-padding kv-line-r">
								<h6>总HI豆<span id="totalJfen" style="color: #F14A43;" id="totalJfen"><%=intergral%></span>个<span id="itMinus" style="color: #ff5f32;display:;"></span></h6>
								<div id="changeJf" class="mui-checkbox"><input name="checkbox" class="groupCheck" type="checkbox"></div>
							</dd>
							<%}else{%>
							<dd class="dd-padding kv-line-r">
								<h6>无可用HI豆</h6>
								<div class="mui-checkbox"><input name="checkbox" disabled class="groupCheck" type="checkbox"></div>
							</dd>
							<%}%>

						</script>

					</dl>
				</form>
			</div>
			<input type="hidden" name="hiddenValue" id="hiddenValue" value="" />
			<input type="hidden" name="hiddenValue" id="hiddencouponid" value="" />
			<input type="hidden" name="hiddenValue" id="hiddencuoponValue" value="" />
			<input type="hidden" name="hiddenValue" id="noHidou" value="" />
			<!--操作表   支付弹窗-->
			<div id="payChoose" class=" mui-popover mui-popover-action mui-popover-bottom closePay">
				<div class="paycontent" style="width: 280px;">
					<ul class="mui-table-view waypay">
						<p><span>支付方式</span></p>
						<li class="">
							<a id="alipay" data-pay="alipay"><img class="aClick2" src="../../img/tickets/zhifubao.png"></a>
						</li>
						<li class="">
							<a id="wxpay" data-pay="wxpay"><img class="aClick2" src="../../img/tickets/weixin.png"> </a>
						</li>
						<li class="" id="duihuanLi" style="display: none;">
							<a id="duihuan" data-pay="duihuan"><img class="aClick2" src="../../img/tickets/eui.png"> </a>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</body>
	<script src="../../js/app.js"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script type="text/javascript">
		mui.init({
			beforeback: function() {
				//获得列表界面的webview
				var list = plus.webview.getWebviewById('cart');
				mui.fire(list, 'refresh');
				return true;
			}
		});
		var id_card;
		//海关协议
		window.gosearule = function() {
			openview({
				view: "seaRule.html",
				id: "seaRule"
			})
		}
		$(".paycontent").click(function() {
			event.stopPropagation()
		})
		$(".closePay").click(function() {
			event.stopPropagation();
			$("#payChoose").removeClass("mui-active");
		})

		var myuserid, allGroup = 0,
			quan = 0,
			jf = 0,
			orderSubmitData = [],
			arr = [],
			arrNum = [],
			arrMoney = [],
			shopID = [],
			igetShopId = [],
			shopaddress = [],
			totalPay = 0,
			shopMoney = [],
			storeWeight = [],
			goodsreduce = [],
			storereduce = [],
			deliveryarr = [];
		var pays = {};
		mui.plusReady(function() {
			window.addEventListener('readdstorage', function(event) {
				orderAdd()
			});
			window.addEventListener('refresh2', function(event) {
				plus.webview.currentWebview().reload()
			});
			//订单缓存
			var orderStorage = JSON.parse(plus.storage.getItem('$orderStorage') || '[]');
			//获取缓存
			myuserid = plus.storage.getItem('userid');
			var oldtoken = plus.storage.getItem('oldToken');
			var version  = plus.storage.getItem('version');
			var platform  = plus.storage.getItem('platform');
			//获取收货地址
			var balance = 0;
			var qGoods
			var qPreice = 0;
			var qCoupon = null;
			var addressid
			
			orderAdd();
			var arr = []
			orderStorage.forEach(function(item){
				arr.push(item.goodsId)
			})

			mui.ajax("http://abcd.zlzmm.com:6789/index.php/Api_goods/cartinfo", {
				data: {
					user_id: myuserid,
					goods: arr,
				},
				dataType: 'json',
				type: 'post',
				timeout: 10000,
				success:function(data, type, xhr){
//					alert(JSON.stringify(data))
					if(data.code==0 && data.result.balance){
						balance = Number(data.result.balance)
						$("#duihuanLi").css("display", "inline-block")
					}
				}, 
				error: function(xhr, type, errorThrown){
					console.log("ssssssssss"+errorThrown)
				}
			})
			
			
			
			function orderAdd() {
				mui.ajax(serverUrl + '/api/useraccount/addresslist', {
					data: {
						userid: myuserid,
						state: 1
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"token": oldtoken
					},
					success: function(data, type, xhr) {
						if(data.errno == 0) {
							var addrObj = {};
							if(plus.storage.getItem("$addressStorage") != null) {
								addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorage"));
							} else {
								addrObj.obj = data.data;
							}
							document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
							plus.storage.removeItem("$addressStorage")

						}
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						mui.toast("网络不好请重试")
					}
				});
			}

			//订单数据模板
			var data = {};
			//			data.goodsList = orderStorage;

			for(var i = 0; i < orderStorage.length; i++) {
				orderStorage[i].goodsDelivery = Math.floor(parseFloat(orderStorage[i].goodsDelivery * orderStorage[i].goodsnum) * 100) / 100;

			}

			for(var i = 0; i < orderStorage.length; i++) {
				shopID.push(orderStorage[i].shopId);
				arr.push(orderStorage[i].shopName);
				shopaddress.push(orderStorage[i].goodsaddress)
			}
			shopID = shopID.unique1();

			for(var i = 0; i < shopID.length; i++) {
				//分组 金额 和 数量  分组商品优惠小计
				var igetShopIdNum = '',
					groupWeight = 0,
					groupMoneynoreduce = 0;
				for(var j = 0; j < orderStorage.length; j++) {
					if(shopID[i] == orderStorage[j].shopId) {
						if(orderStorage[j].igetShopId == '0') {
							igetShopIdNum = 0;
						} else {

							igetShopIdNum = 1;
						}
						if(!orderStorage[j].goodweight || orderStorage[j].goodweight == ' ') {
							orderStorage[j].goodweight = 0;
						}
						deliveryFee = parseFloat(orderStorage[j].goodsDelivery);
						groupMoneynoreduce += parseFloat(orderStorage[j].goodsPrice) * parseFloat(orderStorage[j].goodsnum) + deliveryFee;
						groupWeight += parseFloat(orderStorage[j].goodweight) * parseFloat(orderStorage[j].goodsnum);

					}
				}

				igetShopId.push(igetShopIdNum);
				shopMoney.push({
					id: shopID[i],
					money: parseFloat(groupMoneynoreduce).toFixed(2)
				})
				storeWeight.push({
					shopid: shopID[i],
					weight: parseFloat(groupWeight).toFixed(2)
				})

			}
			//分商店  订单数据 小计
			for(var i = 0; i < shopID.length; i++) {
				var orderList = {};
				orderList.storeid = shopID[i];

				orderList.express_id = '';
				orderList.goodsData = [];
				for(var j = 0; j < orderStorage.length; j++) {

					if(orderStorage[j].shopId == shopID[i]) {

						var newgoodobj = {};
						newgoodobj.goodsid = orderStorage[j].goodsId;
						newgoodobj.goods_property = orderStorage[j].goods_property;
						newgoodobj.goodText = orderStorage[j].goodText;
						newgoodobj.nums = orderStorage[j].goodsnum;
						orderList.goodsData.push(newgoodobj)
					}

				}
				orderSubmitData.push(orderList);
			}

			//商品重量为0 包邮  爱购88包邮  满减包邮
			for(var j = 0; j < igetShopId.length; j++) {
				if(igetShopId[j] == '0') {
					if(shopMoney[j].money >= 88) {
						orderSubmitData[j].express_id = '-1';
					} else {
						orderSubmitData[j].express_id = '0';
					}
				} else {
					if(storeWeight[j].weight == 0) {
						orderSubmitData[j].express_id = '-1';
					}
				}
			}

			//获取积分  和 身份证
			getInfo();

			function getInfo() {
				mui.ajax(serverUrl + '/api/useraccount/userinfo', {
					data: {
						"userid": myuserid
					},
					type: 'post',
					timeout: 10000,
					headers: {
						"token": oldtoken
					},
					success: function(data, type, xhr) {
						var intergral = 0;
						//					console.log('获取用户数据返回'+JSON.stringify(data));
						if(data.errno == 0) {
							intergral = data.data[0].intergral;
							//							intergral = 0; 暂时关闭积分抵扣
							id_card = data.data[0].id_card;

							if(intergral == null) {
								intergral = 0;
							}

							document.getElementById("coupon").innerHTML = template('couponTpl', {
								intergral: intergral,
								intergralreduce: ''
							});
//							$('#changeJf').hide();
//							$('#itMinus').show().html(' '+'抢购商品不能使用HI豆')
//							$('#itMinus').show()
						} else {
							mui.toast('获取用户信息失败');
							console.log(data.errmsg);
						}
						$("#coupon .mui-checkbox").unbind("click").click(function() {
							if($(this).find("input").prop('checked') == true) {
								$('#itMinus').show();
								jf = parseFloat(intergral / 100);
							} else {
								$('#itMinus').hide();
								jf = 0;
							}
							calculate();
						})
					},
					error: function(xhr, type, errorThrown) {}
				});
			}

			//积分使用
			var isIntergal = 0;
			calculate();

			function calculate() {
				//				mui.toast('计算开始');
				plus.nativeUI.showWaiting();
				var yourSFZ = $('#sfzin').val();
				//地址
				addressid = $("#addid").attr("data-id");
				//买家留言
				var noticeData = [];
				//优惠券id
				var coupon_id = '';

				$(".quanc").each(function() {
					if($(this).css("display") == "block") {
						coupon_id = $(this).attr("data-id");
						qCoupon = $(this).attr("data-id");
					}
				})
				if($("#coupon").find("input[type='checkbox']:checked").length == 1) {
					isIntergal = 1
				} else {
					isIntergal = 0;
				}
				//					alert(isIntergal)
				var goodsdata = JSON.stringify(orderSubmitData);
				qGoods = JSON.stringify(orderSubmitData);
				var notice = JSON.stringify(noticeData);

				gopay();

				function gopay() {
					console.log('goodsdata',goodsdata)
												console.log(myuserid  + addressid + goodsdata + coupon_id + isIntergal)
					mui.ajax(serverUrl + '/api/mall/neworder', {
						data: {
							userid: myuserid,
							address_id: 1,
							payType: 'alipay',
							storeData: goodsdata,
							coupon_id: coupon_id,
							isIntergal: isIntergal,
							isCalculation: 1
						},
						type: 'post', //HTTP请求类型
						headers: {
							"token": oldtoken
						},
						timeout: 300000, //超时时间设置为10秒；
						success: function(data) {
							console.error('计算返回', data);
							if(data.errno == 0) {
								var dataObj = {};
								if(data.data.nowIntergal && data.data.nowIntergal.intergral){
									var jian = Math.floor(data.data.nowIntergal.intergral * 100) / 100
										$('#itMinus').html('本次交易最多抵用'+jian + '元')
								}
								for(var i = 0; i < data.data.Params.goodsData.length; i++) {
									data.data.Params.goodsData[i].actualPrice = Math.floor(data.data.Params.goodsData[i].actualPrice * 100) / 100;
									 
									if(!data.data.Params.goodsData[i].postAge.postage) {
										data.data.Params.goodsData[i].postAge.postage = 0;
									}else{
										data.data.Params.goodsData[i].postAge.postage = Math.floor(data.data.Params.goodsData[i].postAge.postage * 100) / 100;
									}
									for(var j = 0; j < data.data.Params.goodsData[i].goods_Data.length; j++) {
										if(data.data.Params.goodsData[i].goods_Data[j].youpin) {
											data.data.Params.goodsData[i].goods_Data[j].youpin = JSON.parse(data.data.Params.goodsData[i].goods_Data[j].youpin);
										}
										if(data.data.Params.goodsData[i].goods_Data[j].tax_rate) {
											data.data.Params.goodsData[i].goods_Data[j].tax = Math.floor(data.data.Params.goodsData[i].goods_Data[j].tax_rate/100 * (data.data.Params.goodsData[i].goods_Data[j].price * data.data.Params.goodsData[i].goods_Data[j].nums + data.data.Params.goodsData[i].postAge.postage) * 100) / 100;
										}
										data.data.Params.goodsData[i].goods_Data[j].price_total = Math.floor((data.data.Params.goodsData[i].goods_Data[j].price + data.data.Params.goodsData[i].goods_Data[j].Floating_price) * 100) / 100;
									}
									 
									if(data.data.Params.goodsData[i].postAge.maxMoney || data.data.Params.goodsData[i].postAge.maxNums){
										orderSubmitData[i].express_id = '-1';
									}
									if(data.data.Params.goodsData[i].postAge.express_id){
										orderSubmitData[i].express_id = data.data.Params.goodsData[i].postAge.express_id;
									}
								}
								dataObj.shopaddress = shopaddress;
								dataObj.goodsList = data.data.Params.goodsData;
								dataObj.myurl = serverimgUrlE;
								dataObj.PriceCalculValue = Math.floor(data.data.PriceCalculValue * 100) / 100;
								qPreice = Math.floor(data.data.PriceCalculValue * 100) / 100;
								var recommentType = dataObj.goodsList[0].goods_Data[0].recommentType;
//								alert(recommentType)
								if(recommentType == 1){
									$('#noHidou').val(1);
									$('#changeJf').hide(); 
									$('#itMinus').show().html(' '+'抢购商品不能使用HI豆')
									
								}
								if(dataObj.goodsList[0].goods_Data[0].youpin){
									var igo = 1
								}
								if($('#hiddenValue').val() == ''){
									$('#hiddenValue').val(dataObj.PriceCalculValue)
								}
//
								//获取优惠券
								var d = new Date();
								var str = d.getFullYear() + "-" + (d.getMonth() + 1) + "-" + d.getDate();
								str = formatDate(str, "yyyy.MM.dd");
								mui.ajax(serverUrl + '/api/useraccount/mycoupon', {
									data: {
										userid: myuserid
									},
									dataType: 'json',
									type: 'post',
									timeout: 10000,
									headers: {
										"token": oldtoken
									},
									success: function(data, type, xhr) {
										console.log("抵用券 ", data)
										var allC = {};
										var tpldata = [];

										for(var i = 0; i < data.data.user_coupon.length; i++) {

											if(data.data.user_coupon[i].user_coupon_state == 1 && (data.data.user_coupon[i].typeid == 1 || data.data.user_coupon[i].typeid == 2 || data.data.user_coupon[i].typeid == 3) && !data.data.user_coupon[i].applicableType && recommentType != 1) {

												if(data.data.user_coupon[i].end_date != null) {
													data.data.user_coupon[i].end_date = formatDate(data.data.user_coupon[i].end_date, "yyyy.MM.dd");
												}
												if(data.data.user_coupon[i].begin_date != null) {
													data.data.user_coupon[i].begin_date = formatDate(data.data.user_coupon[i].begin_date, "yyyy.MM.dd");
												}
												if(data.data.user_coupon[i].begin_date <= str && str <= data.data.user_coupon[i].end_date) {
													if(data.data.user_coupon[i].typeid == 2 || data.data.user_coupon[i].typeid == 3) {
														if(data.data.user_coupon[i].coupon_amount.split(",")[0]<=parseFloat($('#hiddenValue').val())){
															data.data.user_coupon[i].coupon_amount = [data.data.user_coupon[i].coupon_amount.split(",")[0], data.data.user_coupon[i].coupon_amount.split(",")[1]]
															tpldata.push(data.data.user_coupon[i]).typeid
														}
													}else {
														tpldata.push(data.data.user_coupon[i]).typeid
													}

												}

											}

											if(data.data.user_coupon[i].user_coupon_state == 1 && (data.data.user_coupon[i].typeid == 1 || data.data.user_coupon[i].typeid == 2 || data.data.user_coupon[i].typeid == 3) && ((igo ==1 && data.data.user_coupon[i].applicableType == 1)||(recommentType ==7 && data.data.user_coupon[i].applicableType == 7)||(recommentType == 2 && data.data.user_coupon[i].applicableType == 2)||(recommentType == 3 && data.data.user_coupon[i].applicableType == 3) || (recommentType == 4 && data.data.user_coupon[i].applicableType == 4) || (recommentType == 5 && data.data.user_coupon[i].applicableType == 5) || (recommentType == 6 && data.data.user_coupon[i].applicableType == 6))) {
												if(data.data.user_coupon[i].end_date != null) {
													data.data.user_coupon[i].end_date = formatDate(data.data.user_coupon[i].end_date, "yyyy.MM.dd");
												}
												if(data.data.user_coupon[i].begin_date != null) {
													data.data.user_coupon[i].begin_date = formatDate(data.data.user_coupon[i].begin_date, "yyyy.MM.dd");
												}
												if(data.data.user_coupon[i].begin_date <= str && str <= data.data.user_coupon[i].end_date) {
													if(data.data.user_coupon[i].typeid == 2 || data.data.user_coupon[i].typeid == 3) {
														if(data.data.user_coupon[i].coupon_amount.split(",")[0]<=parseFloat($('#hiddenValue').val())){
															data.data.user_coupon[i].coupon_amount = [data.data.user_coupon[i].coupon_amount.split(",")[0], data.data.user_coupon[i].coupon_amount.split(",")[1]]
															tpldata.push(data.data.user_coupon[i]).typeid
														}
													}else {
														tpldata.push(data.data.user_coupon[i]).typeid
													}

												}

											}
										}
										allC.allLi = tpldata;
										console.log('tpldata', tpldata)
										var html = template('quanTpl', allC);
										document.getElementById('quanData').innerHTML = html;
										$('.checkQuan').each(function(){
											if($(this).attr("data-cid") == $('#hiddencouponid').val()){
												$(this).find(".quanc").css("display", "block");
												$(".minuMoney").css("display", "");
												$("#minuMoney").html($('#hiddencuoponValue').val());
											}
										})
										plus.nativeUI.closeWaiting();

										//优惠券计算
										$(".checkQuan").click(function() {

											var qid = $(this).attr("data-id");
											var qminus = $(this).attr("data-minus");
											$(this).siblings().find(".quanc").css("display", "none");
											quan = 0;
											if($(this).find(".quanc").css("display") == "block") {
												$(this).find(".quanc").css("display", "none");
												$("#minuMoney").html(0);
												$(".minuMoney").css("display", "none");
												$('#hiddencouponid').val('');
												$('#hiddencuoponValue').val('');
											} else {
												$(this).find(".quanc").css("display", "block");
												if(qid == 1) {
													quan = parseFloat(qminus)
												}
												if(qid == 2) {
													quan = parseFloat($('#hiddenValue').val() * (1 - parseFloat(qminus))).toFixed(2);
												}
												if(qid == 3) {
													quan = parseFloat(qminus);
												}
												$('#hiddencouponid').val($(this).attr("data-cid"));
												$('#hiddencuoponValue').val(quan);
												$("#minuMoney").html(quan);
												$(".minuMoney").css("display", "inline-block");

											};
											calculate();

										})


									},
									error: function(xhr, type, errorThrown) {
										mui.toast("网络不好请重试!")
									}
								});
								var totalJfen = parseInt($('#totalJfen').html());
//								if((totalJfen / 100) >= Math.floor(data.data.PriceCalculValue * 100) / 100) {
//									if(!$("#coupon").find("input[type='checkbox']:checked").length == 1) {
//										$('#itMinus').html((Math.floor(data.data.PriceCalculValue * 100 - 0.01) / 100) + '元')
//									}
//								} else {
//									if(!$("#coupon").find("input[type='checkbox']:checked").length == 1) {
//										$('#itMinus').html(totalJfen / 100 + '元')
//									}
//
//								}

								var html = template('orderData', dataObj);
								document.getElementById('orderTpl').innerHTML = html;
								plus.nativeUI.closeWaiting();

								$('.checkQuan').each(function() {
									if($(this).attr('data-id') == 2 && $(this).attr('data-amount') > dataObj.PriceCalculValue) {
										$(this).remove();
									}
								})
								
								




								//物流选择
								$('.getwl').on('tap', function() {
									var businid = $(this).attr('data-storeid');
									var storeWeight = $(this).attr('data-weight');
									var shopmoney = $(this).parentsUntil("#orderTpl").find('.groupMoney').html();
									console.log(businid + ' ' + storeWeight + ' ' + shopmoney);
									if($(this).attr('data-id') == 0) {
										var wlct = $(this).next();
										mui.ajax(serverUrl + '/api/mall/expresslist', {
											data: {
												businid: businid
											},
											dataType: 'json',
											type: 'post',
											headers: {
												token: oldtoken
											},
											timeout: 10000,
											success: function(data, type, xhr) {
												console.log("物流", data);
												var wlhtml = '';
												//								console.log("youhuo "+JSON.stringify(data.data))
												for(var i = 0; i < data.data.length; i++) {
													var countpostfee = parseInt(data.data[i].basicsPrice);
													if(data.data[i].beyondKg == 0) {
														data.data[i].beyondKg = 1;
													}
													var overWeight = (parseFloat(storeWeight) - parseFloat(data.data[i].basicsKg)) / parseInt(data.data[i].beyondKg);
													if(overWeight > 0) {
														overWeight = Math.ceil(overWeight);
														countpostfee = parseInt(data.data[i].basicsPrice) + overWeight * parseInt(data.data[i].beyondPrice)
													}

													wlhtml += '<div data-charge="' + countpostfee + '" data-epid="' + data.data[i].express_id + '" data-id="0">' + data.data[i].expressName + '<span class="charge fr">￥' + countpostfee + '</span></div>'
												}
												if(!wlhtml) {
													wlhtml = "商家暂未填写物流"
												}
												wlct.html(wlhtml);
												$(".dlc div").click(function() {

													if($(this).attr("data-id") == 0) {
														if($(this).parent().prev().find(".wlway").html() == "自提") {
															$(this).parentsUntil("#orderTpl").find(".ztWrap input[type='checkbox']").removeAttr("checked")
														}
														$(this).parent().prev().find(".wlway").html($(this).html());

														for(var i = 0; i < orderSubmitData.length; i++) {
															if(orderSubmitData[i].storeid == businid) {
																orderSubmitData[i].express_id = $(this).attr('data-epid');

															}
														}
													}
													$(this).siblings().attr("data-id", 0);
													$(this).attr("data-id", 1);
													$(".choosewl").removeClass("mui-active");
													calculate();
												})
											},
											error: function(xhr, type, errorThrown) {
												plus.nativeUI.closeWaiting();
												mui.toast("网络不好请重试")
											}
										})

									}
									$(this).attr('data-id', 1);
								})

								//自提 or 配送  更新 邮费 和 分组价格 和 总价
								$("dd .ddRadio").each(function() {
									$(this).find("input[type='checkbox']").click(function() {

										var dataPostfee = parseFloat($(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val());
										var shopid = $(this).attr('data-shopId');
										//alert($(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").attr('data-id'))
										if($(this).prop('checked') == true) {
											var curPost = parseFloat($(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html());
											$(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html(parseFloat(curPost - dataPostfee).toFixed(2));
											$(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('自提');
											$(this).parentsUntil("#orderTpl").find("dd.ztaddress").css("display","")
											for(var i = 0; i < orderSubmitData.length; i++) {
												if(orderSubmitData[i].storeid == shopid) {
													orderSubmitData[i].express_id = '-2';
													break;
												}
											}
											calculate();
											$(this).parentsUntil("#orderTpl").find('.dlc div').attr("data-id",0);
											$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(0)
										} else {
											var curPost = parseFloat($(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html());
											$(this).parentsUntil("#orderTpl").find("dd.priceWrap .groupMoney").html(parseFloat(curPost + dataPostfee).toFixed(2));
											for(var i = 0; i < orderSubmitData.length; i++) {
												if(orderSubmitData[i].storeid == shopid) {

													if(storeWeight[i].weight == 0){
														$(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('包邮');
														orderSubmitData[i].express_id = '-1';
														$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").attr('data-id', '-1');
													}else{
														$(this).parentsUntil("#orderTpl").find("dd.postfeeWrap .jifen").html('选择物流');
														orderSubmitData[i].express_id = '';
														$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").attr('data-id', '');
													}
													break;
												}
											}
											$(this).parentsUntil("#orderTpl").find("dd.ztaddress").css("display","none")
											calculate();
											$(this).parentsUntil("#orderTpl").find('.dlc div').attr("data-id",0);
											$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(0);
										}

									})
								})
//								$('#changeJf').unbind("click").click(function() {
//									calculate();
//								})
							}else{
								plus.nativeUI.closeWaiting();
								var tot = 1;
								if(data.errmsg && tot == 1){
									tot++;
									mui.toast(data.errmsg)
								}
								
							}
						},
						error: function(xhr, type, errorThrown) {
							//异常处理；
							console.log(type);
							console.log("----- 请求订单失败 -----");
							console.log(xhr.status);
							plus.nativeUI.closeWaiting();
							plus.nativeUI.alert("获取订单信息失败！");
						}
					});

				}
		}
			
			$("#duihuan").click(function(){
				if(qCoupon){
					mui.toast('特殊兑换不能使用优惠券！')
					return false
				}
				if(isIntergal==1){
					mui.toast('特殊兑换不能使用积分折扣！')
					return false
				}
				if(qPreice > balance){
					mui.toast("余额不足，无法兑换")
					return false
				}
				var a = { 
					user_id: myuserid, 
					address_id: addressid,
					payType: 'wxpay',
					storeData: qGoods,
					balance: qPreice,
					version:version,
					platform:platform,
					token: oldtoken,
				}
				console.log(JSON.stringify(a))
				plus.nativeUI.showWaiting();
				mui.ajax("http://abcd.zlzmm.com:6789/index.php/Api_goods/orderdone", {
					data: { 
						user_id: myuserid, 
						address_id: addressid,
						payType: 'wxpay',
						storeData: qGoods,
						balance: qPreice,
						version:version,
						platform:platform,
						token: oldtoken,
					},
					headers: {
						"token": oldtoken
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					success:function(data, type, xhr){
//						alert(JSON.stringify(data))
						plus.nativeUI.closeWaiting();
						if(data.code == 0){
							mui.toast('兑换成功！')
							var cartStorage = JSON.parse(plus.storage.getItem('$cartStorage') || '[]');
							//删除 购物车里 提交的这一条数据
							for(var i = 0; i < qGoods.length; i++) {
								for(var j = 0; j < cartStorage.length; j++) {
									if(qGoods[i].goodsId == cartStorage[j].goodsId && qGoods[i].goodText == cartStorage[j].goodText) {
										cartStorage.splice(j, 1)
									}
								}
							}
							plus.storage.setItem("$cartStorage", JSON.stringify(cartStorage))
							openview({
								view: "../personal/sc-order.html",
								id: "sc-order",
								extrasobj:{
									showShare:true,
									order_uuid: data.resultAccessToken,
								}
							})
							setTimeout(function() {
								if(plus.webview.getWebviewById("market-order")) {
									plus.webview.getWebviewById("market-order").close();
								}
							}, 200) 
						}else{
							mui.toast('兑换失败')
						}
					},
					error: function(xhr, type, errorThrown){
						plus.nativeUI.closeWaiting();
						mui.toast(errorThrown)
						console.log("ssssssssss"+errorThrown)
					}
				})
			})

			//系统检测获取支付通道
			plus.payment.getChannels(function(channels) {
				console.log("channel " + JSON.stringify(channels));
				for(var i in channels) {
					var channel = channels[i];
					// 过滤掉不支持的支付通道：暂不支持360相关支付
					if(channel.id == 'qhpay' || channel.id == 'qihoo') {
						continue;
					}
					pays[channel.id] = channel;
					if(channel.id == 'alipay') { //添加支付事件
						document.getElementById('alipay').setAttribute('onclick', 'payfun("alipay")');
					}
					if(channel.id == 'wxpay') {
						document.getElementById('wxpay').setAttribute('onclick', 'payfun("wxpay")');

					}
					checkServices(channel);
				}
			}, function(e) {
				plus.nativeUI.alert("支付失败，请重试", null, "提示");
			});

			// 检测是否安装支付服务
			function checkServices(pc) {
				if(!pc.serviceReady) {
					var txt = null;
					switch(pc.id) {
						case "alipay":
							txt = "检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
							break;
						default:
							txt = "系统未安装“" + pc.description + "”服务，无法完成支付，是否立即安装？";
							break;
					}
					//						plus.nativeUI.confirm(txt,function(e){
					//							if(e.index==0){
					//								pc.installService();
					//							}
					//						},pc.description);
				}
			}
			//系统检测获取支付通道结束

			//goPay
			window.goPay = function() {
				if($("#addid").length != 0) {

					var yourSFZ = $('#sfzin').val();
					//地址
					addressid = $("#addid").attr("data-id");
					//买家留言
					var noticeData = [];
					$(".tipsWrap").each(function() {
						var notice = $(this).find("input").val();
						for(var i = 0; i < orderSubmitData.length; i++) {
							if(orderSubmitData[i].storeid == $(this).attr("data-id")) {
								orderSubmitData[i].notice = notice;
							}
						}
						if(notice != '') {
							var noticeObj = {};
							noticeObj.shopId = $(this).attr("data-id");
							noticeObj.notice = notice;
							noticeData.push(noticeObj)
						}

					});

					//优惠券id
					var coupon_id = '';
					$(".quanc").each(function() {
						if($(this).css("display") == "block") {
							coupon_id = $(this).attr("data-id");
						}
					})
					//积分使用
					var isIntergal = 0;
					if($("#coupon").find("input[type='checkbox']:checked").length == 1) {
						isIntergal = 1
					} else {
						isIntergal = 0;
					}
					var goodsdata = JSON.stringify(orderSubmitData);
					console.log("goodsdata 445", goodsdata)
					var notice = JSON.stringify(noticeData);
					//获取总价
					var payTotal = parseFloat($("#submit_order").html()).toFixed(2);
					//							alert($("#aigou").length)
					if($("#aigou").length != 0) {
						getInfo();
						if(id_card) {
							tijiao()
						} else {
							mui.confirm('购买跨境优品需要身份证号哦？', '提示', ['取消', '确定'], function(e) {
								if(e.index == 1) {
									openview({
										view: "../personal/setup.html",
										extrasobj: {
											pageid: "setup"
										}
									})
								}

							})
						}
					} else {
						tijiao()
					}

					function tijiao() {
						var flag = 0;
						console.log('orderSubmitData', orderSubmitData)
						for(var i = 0; i < orderSubmitData.length; i++) {
							if(orderSubmitData[i].express_id == '') {
								mui.toast("还有商品未选择配送方式哦");
								flag = 1;
							}
						}
						if(!flag) {
							$("#payChoose").addClass("mui-active");
						}
					}
					// 支付方法
					window.payfun = function(id) {
						var varpay;
						if(id == 'alipay' || id == 'wxpay') {
							//调用支付功能
							plus.nativeUI.showWaiting();
							if(id == 'alipay') {
								//获取后台返回数据
								gopay(id);

							} else if(id == 'wxpay') { //微信
								gopay(id);
							}
						} else {
							plus.nativeUI.alert("当前环境不支持此支付通道！", null, "提示");
							return;
						}

						function gopay(id) {
							console.log('goodsdata', JSON.parse(goodsdata))
							console.log(myuserid + id + addressid + goodsdata + coupon_id + isIntergal)
							mui.ajax(serverUrl + '/api/mall/neworder', {
								data: {
									userid: myuserid,
									payType: id,
									address_id: addressid,
									storeData: goodsdata,
									coupon_id: coupon_id,
									isIntergal: isIntergal,
									version:version,
									platform:platform,
								},
								type: 'post', //HTTP请求类型
								headers: {
									"token": oldtoken
								},
								timeout: 300000, //超时时间设置为10秒；
								success: function(data) {
									console.error('支付返回', data);
									$("#payChoose").removeClass("mui-active");
									//plus.nativeUI.closeWaiting()
									
									if(data.errno == 0) {
										//购物车 缓存
										var cartStorage = JSON.parse(plus.storage.getItem('$cartStorage') || '[]');
										//删除 购物车里 提交的这一条数据
										for(var i = 0; i < orderStorage.length; i++) {
											for(var j = 0; j < cartStorage.length; j++) {
												if(orderStorage[i].goodsId == cartStorage[j].goodsId && orderStorage[i].goodText == cartStorage[j].goodText) {
													cartStorage.splice(j, 1)
												}
											}
										}
										plus.storage.setItem("$cartStorage", JSON.stringify(cartStorage))
										var list = plus.webview.getWebviewById('cart.html');
										mui.fire(list, 'refresh');
										mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');
										mui.toast(data.errmsg);
										var varpay;
										var AccessToken = data.data.AccessToken;
										if(id == 'wxpay') {
											varpay = {
												"appid": data.data.payData.appid,
												"noncestr": data.data.payData.noncestr,
												"package": "Sign=WXPay",
												"partnerid": data.data.payData.partnerid,
												"prepayid": data.data.payData.prepayid,
												"timestamp": parseInt(data.data.payData.timestamp),
												"sign": data.data.payData.sign
											};
											//微信
											//alert(JSON.stringify(varpay));
											//alert(JSON.stringify({id:data.data.AccessToken,userid:myuserid}));
											plus.payment.request(pays[id], varpay, function(result) {
												plus.nativeUI.showWaiting();
												var resultStr = JSON.stringify(result);
												console.log("----- 支付成功 -----");
												//plus.nativeUI.closeWaiting();
												//修改订单状态
												//alert(JSON.stringify({id:data.data.AccessToken,appPayValue:resultStr,userid:myuserid}));
												mui.ajax(serverUrl + '/api/mall/confirmpurchase', {
													data: {
														id: data.data.AccessToken,
														appPayValue: resultStr,
														userid: myuserid
													},
													type: 'post', //HTTP请求类型
													headers: {
														"token": oldtoken
													},
													timeout: 10000, //超时时间设置为10秒；
													success: function(data) { 
														mui.toast(data.errmsg)
														console.log("修改状态成功");
														mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');
														//											关闭 订单页
														openview({
															view: "../personal/sc-order.html",
															id: "sc-order",
															extrasobj:{
																showShare:true,
																order_uuid:AccessToken,
															}
														})
														setTimeout(function() {
															if(plus.webview.getWebviewById("market-order")) {
																plus.webview.getWebviewById("market-order").close();
															}
														}, 2000)
													},
													error: function(xhr, type, errorThrown) {
														mui.toast('支付失败');
													}
												});
	
											}, function(e) {
												console.log("----- 支付失败 -----");
												console.log("[" + e.code + "]：" + e.message);
												plus.nativeUI.alert("支付失败");
											});
										} else {
											//支付宝
											varpay = data.data.payData;
										 
											plus.payment.request(pays[id], varpay, function(result) {
												plus.nativeUI.showWaiting();
												var resultStr = JSON.stringify(result);
												console.log("----- 支付成功 -----", JSON.stringify(result));
												var oldtoken = plus.storage.getItem('oldToken');
												 
												//修改订单状态
												mui.ajax(serverUrl + '/api/mall/confirmpurchase', {
													data: {
														id: data.data.AccessToken,
														appPayValue: resultStr,
														userid: myuserid
													},
													dataType: 'json',
													type: 'post', //HTTP请求类型
													headers: {
														"token": oldtoken
													},
													timeout: 10000, //超时时间设置为10秒；
													success: function(data) {
														mui.toast(data.errmsg)
														console.log("修改状态成功",data);
														mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');

														//											关闭 订单页
														openview({
															view: "../personal/sc-order.html",
															id: "sc-order",
															extrasobj:{
																showShare:true,
																order_uuid:AccessToken,
															}
														})
														setTimeout(function() {
															if(plus.webview.getWebviewById("market-order")) {
																plus.webview.getWebviewById("market-order").close();
															}
														}, 2000)
	
													},
													error: function(xhr, type, errorThrown) {
														console.log("修改状态失败")
														mui.toast('支付失败');
													}
												});
	
											}, function(e) {
												console.log("----- 支付失败 -----");
												console.log("[" + e.code + "]：" + e.message);
												//					console.log("["+e.code+"]："+e.message);
												plus.nativeUI.closeWaiting();
												plus.nativeUI.alert("支付失败");
											});
										}
										
									}else{
										mui.toast(data.errmsg)
										plus.nativeUI.closeWaiting();
									} 
								},
								error: function(xhr, type, errorThrown) {
									//异常处理；
									console.log(type);
									console.log("----- 请求订单失败 -----");
									console.log(xhr.status);
									plus.nativeUI.closeWaiting();
									plus.nativeUI.alert("获取订单信息失败！");
								}
							});

						}

					}

				} else {
					plus.nativeUI.closeWaiting()
					mui.toast("您还未选择收货地址哟！")
				}

			}

		})

		//进入地址页面
		function goAddr() {
			openview({
				view: "../personal/address.html",
				extrasobj: {
					pageid: "market-order",
					userId: myuserid
				}
			})
		}

		function queryStr(str) {
			var r = str.slice(1).split("&"),
				e = {};
			return r.forEach(function(r) {
				var t;
				r && (t = r.split("="), 2 === t.length && (e[t[0]] = t[1]))
			}), e
		}
		//数组去重
		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
	</script>

</html>