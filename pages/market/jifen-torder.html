<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>商品订单确认</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css"> 
		<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" src="../../js/jquery.min.js"></script> 
		<style type="text/css">
			.mui-bar {
				height: 50px;
				box-shadow: none;
			}  
			
			.mui-title,
			.mui-icon {
				line-height: 50px;
			}
			
			.mui-bar .mui-icon {
				padding: 0;
			}
			
			#main {
				margin-top: 50px;
			}
			/*这一页*/
			
			.kv-line-r>h6,
			.kv-line-r>.kv-k {
				font-size: 13px;
			}
			
			.boxs {
				margin-bottom: 10px;
			}
			.boxs li{
				border-top: 0;
			}
			.boxstwo li a {
				width: 100%;
			}
			
			.mui-icon-location {
				width: 100%;
				text-align: center;
				margin-left: -7px;
			}
			
			.mui-col-sm-9 {
				padding-left: 15px;
			}
			
			.ico_arrow {
				position: absolute;
				top: 0;
				margin: 23px 0;
			}
			
			.phoneNum {
				float: right;
			}
			
			strong p {
				padding: 5px 10% 5px 0;
				line-height: 20px;
				color: #333;
			}
			
			.address {
				text-overflow: ellipsis;
				white-space: nowrap;
				overflow: hidden;
				width: ;
			}
			
			.middle-icon {
				padding: 4px 0;
			}
			
			.addBtn {
				background-color: #ff9100 !important;
				border: 1px solid #ff9100 !important;
			}
			
			.mui-numbox {
				width: 100px;
				height: 30px;
				padding: 0 30px;
			}
			
			.mui-numbox .mui-btn {
				width: 30px;
			}
			
			.addTitle {
				line-height: 30px;
			}
			.quanc{
				
				width:0.3rem;
				margin-right: 0.1rem;
				display: none;
			}
			dl.list .dd-paddingtwo {
				padding: .08rem .15rem .08rem .15rem;
			}
			
			.addTitle img {
				width: 100%;
			}
			
			dl.list {
				border: 1px solid #eee;
			}
			
			dl.list dt,
			dl.list dd {
				border-bottom: 0px solid #eee;
				position: relative;
			}
			dl.list dt:after,
			dl.list dd:after{
				content: '';display: block;height: 1px;-webkit-transform: scaleY(0.3);background-color: rgba(0,0,0,0.1);position: absolute;width: 100%;bottom: 0;left: 0;
			}
			dl.list dt:last-child:after,
			dl.list dd:last-child:after{
				height: 0;
			}
			.price {
				color: #ff5f32;
				line-height: 28px;
				font-size: 16px;
			}
			
			.kv-line-r>p span {
				color: #ff5f32;
			}
			
			.price sub {
				bottom: 0;
			}
			
			.num {
				float: right;
				color: #333;
			}
			
			p,
			h6 {
				color: #333;
			}
			
			.postWrap {
				background: #fff url(../../img/market/post.png) no-repeat bottom;
				background-size: 100%;
			}
			
			.boxstwo li a {
				margin: 10px 0;
			}
			
			#container {
				padding-bottom: 50px;
			}
			
			.goods p {
				padding: 3px 0;
				line-height: 20px;
			}
			
			.goodsDetail {
				font-size: 12px;
				color: #999;
				line-height: 15px !important;
			}
			
			.tips {
				margin-bottom: 0 !important;
				border: none !important;
				font-size: 14px;
				line-height: 16px;
			}
			
			.tipsWrap,.ztWrap {
				padding: 0 0.15rem !important;
			}
			
			.tipsWrap input,.ztWrap input {
				padding: 0 !important;
			}
			
			.tipsWrap h6,.ztWrap h6 {
				line-height: 40px;
				margin-right: 0;
			}
			
			.tipsWrap h6 .goods,.ztWrap h6 .goods {
				padding-left: 0;
			}
			
			dl.list dd dl {
				padding-left: 0;
			}
			
			dl.list dd dl>.dd-padding,
			dl.list dd dl dd>.react,
			dl.list dd dl>dt {
				padding: 0.15rem;
			}
			
			.goodsWrap {
				background-color: #fafafa;
			}
			
			.comm_btn {
				margin: 0;
				height: 50px;
				line-height: 50px;
				padding: 0;
				width: 100%;
				text-align: center;
			}
			
			.fixed .btn {
				border: none !important;
				bottom: 0;
				right: 0;
				width: 25%;
			}
			
			.fixed p {
				width: 75%;
				text-align: right;
			}
			
			.priceWrap {}
			
			.priceWrap p {
				text-align: right !important;
				display: block;
				font-size: 16px;
				width: 100%;
			}
			
			.priceWrap p sub {
				bottom: 0;
			}
			.mui-checkbox{
				position: absolute;
				/*top: 50%;*/ 
				right: 0;
			}
			.mui-checkbox input[type=checkbox]:checked:before, .mui-radio input[type=radio]:checked:before {
			    color: rgb(245, 60, 66);
			}
			.mui-card{
				margin: 0;
			}
			.checkQuan{
				padding: 2px 15px;
			    border: 1px solid #f53c42;
			    border-radius: 5px;
			    line-height: 18px;
			    margin: 5px 0;
			    position: relative;
			}
			.checkQuan .mui-col-sm-3{
				width: 28%;
				padding: 12px 5px;
    			border-right: 1px dotted #f53c42;
			}
			.checkQuan .mui-col-sm-9{
				width: 72%;
				    padding: 12px 15px;
			}
			.cred{
				color:#f53c42 ;
			}
			.dateLimit{
				font-size: 12px;
			}
			#sfzin{
				width: -moz-calc(100%-70px)!important;
				width: -webkit-calc(100%-70px)!important; 
				width: calc(100%-70px)!important;
				font-size: 12px;
			    padding: 0;
			    text-align: right;
			    background: none;
			    outline: none;
			    height: auto;
			    margin: 0;
			    line-height: 12px;
			    border: none;
			} 
			.sf:after{
				height: 0px!important;
			}
		 
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">订单确认</h1>  
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">
			<div id="main">
				<form class="wrapper-list">
					<ul class="boxs boxstwo postWrap">
						<div id="add_info"></div>
						<script type="text/html" id="addrTpl">
							<%if(obj.length==0){%>
							<li onclick="goAddr()">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<p style="line-height: 50px;">请选择收货地址</p>
										<p class="address"></p>
										<div class="fr"><i class="ico_arrow middle-icon"></i></div>
									</div>
								</div>
							</li>
							<%}else{%>
							<li onclick="goAddr()" id="addid" data-id="<%=obj[0].id%>" data-name="<%=obj[0].person%>" data-address="<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%>" data-phone="<%=obj[0].phone%>">
								<div class="mui-row orderRow">
									<div class="mui-col-sm-1 mui-col-xs-1">
										<span class="mui-icon mui-icon-location middle-icon"></span>
									</div>
									<div class="mui-col-sm-11 mui-col-xs-11">
										<strong>									
											<p>收货人：<%=obj[0].person%><span class="phoneNum"><%=obj[0].phone%></span></p>
											<p class="address">收货地址：<%=obj[0].province%><%=obj[0].city%><%=obj[0].area%><%=obj[0].address%></p>
											<div class="fr"><i class="ico_arrow middle-icon"></i></div>
										</strong>
									</div>
								</div>
							</li>

							<%}%>
						</script>

					</ul>
					<div id="orderTpl"></div>
					<script type="text/html" id="orderData">
						<%for(var i =0;i<cates.length;i++){%>
						<dl class="list">
							<dd class="dd-padding kv-line-r">
								<h6><img src="../../img/market/shop.png" style="width: 0.2rem;vertical-align: middle;" alt="" /> <%=cates[i]%></h6>
							</dd>
							<%for(var j =0;j<goodsList.length;j++){%>
							<% if(goodsList[j].shopName ==  cates[i]){%>
							<dd class="dd-padding kv-line-r mui-row goodsWrap"> <!--onclick="goInfo('<%=goodsList[j].goodsId%>')"-->
								<% if(goodsList[j].goodsImg){%>
								<h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="<%=myUrl%><%=goodsList[j].goodsImg%>" onerror="javascript:this.src='../../img/market/none.png';"/></h6>
								<%}else{%>
							<h6 class="addTitle mui-col-sm-4 mui-col-xs-4"><img src="../../img/market/none.png"/></h6>

									<%}%>
								<div class="clearfloat fr mui-col-sm-8 mui-col-xs-8 goods">
									<p>
										<%=goodsList[j].goodsName%>
									</p>
									<p class="goodsDetail">
										<%=goodsList[j].goodText%>
									</p>
									<p class="price"><sub><img src="../../img/market/jifen.svg" style="width: 0.14rem;" alt="" /></sub>
										<%=goodsList[j].goodsPrice%> <span class="num">×1</span></p>
									 
								</div>
							</dd>
							<%}%>
							<%}%>
							 
								<dd class="dd-padding kv-line-r mui-row ztWrap" data-id="<%=shopID[i]%>">
									<input type="hidden" class="isziti" value="0"/>
									<h6 class="addTitle mui-col-sm-3 mui-col-xs-3">是否自提：</h6>
									<div class="clearfloat fr mui-col-sm-9 mui-col-xs-9 goods">
	 									<div class="mui-checkbox ddRadio"><input name="checkbox" class="groupCheck" type="checkbox"></div> 
									</div>
								</dd>
							<dd class="dd-padding kv-line-r mui-row tipsWrap" data-id="<%=shopID[i]%>">
								<h6 class="addTitle mui-col-sm-1 mui-col-xs-2">备注：</h6>
								<div class="clearfloat fr mui-col-sm-11 mui-col-xs-10 goods">
									<input type="text" id="" value="" placeholder="选填（对本次交易的说明）" class="tips" />
								</div>
							</dd>
						 
						</dl>

						<%}%>
						
					</script>
					
						 
				</form>
			</div>
			<div class="fixed">
				 
				<span class="fr btn">
					<a onclick="goPay()" class="comm_btn">立即兑换</a>
				</span>
			</div>
		</div>
	</body>
	<script src="../../js/app.js"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script type="text/javascript"> 
			mui.init({
				beforeback: function() {
		
					//获得列表界面的webview
					var list = plus.webview.getWebviewById('cart.html'); 
						mui.fire(list,'refresh');
						return true;
				}
			});
		var myuserid,allGroup=0,quan=0,jf=0,orderSubmitData=[],arr =[],arrNum=[],arrMoney =[],arrpostFee=[],shopID=[];;
		mui.plusReady(function() {
//			plus.storage.removeItem('$addressStorage')
			window.addEventListener('readdstorage', function(event) {
				orderAdd()
			});
			//订单缓存
			var orderStorage = JSON.parse(plus.storage.getItem('$orderStorage') || '[]');
			  console.log("orderStorage   "+plus.storage.getItem('$orderStorage'))
				//获取缓存
			  myuserid = plus.storage.getItem('userid'); 
			var oldtoken = plus.storage.getItem('oldToken');
			
			
			plus.nativeUI.showWaiting('加载中 ...', {
				width: '100px',
				height: '80px'
			});
			
			orderAdd();
			function orderAdd(){
			 
				mui.ajax(serverUrl + '/api/useraccount/addresslist', {
				data: {
					userid: myuserid,
					state: 1
				},
				dataType: 'json',
				type: 'post',
				timeout: 1000,
				headers: {
					"token": oldtoken
				},
				success: function(data, type, xhr) {
					if(data.errno == 0) { 
						plus.nativeUI.closeWaiting()
						var addrObj = {};
						if(plus.storage.getItem("$addressStorage")!=null){
							addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorage")); 
						}else{
							addrObj.obj = data.data; 
						}
							
						document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
						plus.storage.removeItem("$addressStorage")
						
					}
				},
				error: function(xhr, type, errorThrown) {
					plus.nativeUI.closeWaiting();
					mui.toast("网络不好请重试")
				}
			});
			}
			
			
			//订单数据模板
						var data = {};
						data.goodsList = orderStorage;
						for(var i = 0; i < orderStorage.length; i++) {
							arr.push(orderStorage[i].shopName);
						} 
						data.cates = arr.unique1();
						for(var i = 0; i < orderStorage.length; i++) {
							shopID.push(orderStorage[i].shopId);
						} 
						
						shopID = shopID.unique1();  
						data.shopID = shopID;
						for(var i= 0;i<data.shopID.length;i++){
							//分组邮费小计
							var groupPostfee=0; 
							 for(var j = 0;j<orderStorage.length;j++){
							 	if(data.shopID[i] == orderStorage[j].shopId){
							 		if(data.shopID[i] == 0){
							 			groupPostfee+=parseFloat(orderStorage[j].goodsPostfee);
							 		}else{
							 			if(orderStorage[j].goodsPostfee!=0){
									 		groupPostfee=parseFloat(orderStorage[j].goodsPostfee);
									 		break;
									 	}else{
									 		groupPostfee = 0;
									 	}
							 		}
							 	}
							 	
							 }
							 arrpostFee.push(parseFloat(groupPostfee).toFixed(2));
						}
						 
						for(var i= 0;i<data.cates.length;i++){
							//分组 金额 和 数量 小计
							var groupNum=0,groupMoney=0;
							 for(var j = 0;j<orderStorage.length;j++){
							 	if(orderStorage[j].shopName ==  data.cates[i]){
							 		groupNum+=parseFloat(1);
							 		groupMoney+=parseFloat(orderStorage[j].goodsPrice)*parseFloat(1); 
							 	} 
							 } 
							 arrNum.push(groupNum);
							 arrMoney.push(parseFloat(groupMoney)+parseFloat(arrpostFee[i]));
						}
						
						//分组商品总价
						for(var i=0;i<arrMoney.length;i++){
							allGroup+=parseFloat(arrMoney[i])
							
						}
						
						//分商店  订单数据 小计
						
						for(var i= 0;i<shopID.length;i++){ 
							var orderList={};
							    orderList.storeid=shopID[i];
							    orderList.postFee = arrpostFee[i];
							    orderList.totalNum = arrNum[i];
							    orderList.totalMoney = arrMoney[i];
							    orderList.goodsData =[]; 
						 	for(var j = 0;j<orderStorage.length;j++){
						 	 if(orderStorage[j].shopId == shopID[i]){
						 	 	
						 	 	orderList.goodsData.push(orderStorage[j])
						 	 }
						 	 
						 	}
							 orderSubmitData.push(orderList);
						}
						
						
						data.arrpostFee=arrpostFee;
						data.arrNum=arrNum;
						data.arrMoney=arrMoney; 
						data.myUrl = serverimgUrl;
						var html = template('orderData', data);
						document.getElementById('orderTpl').innerHTML = html;
					 
 				//自提 or 配送  更新 邮费 和 分组价格 和 总价 
				        $("dd .ddRadio").each(function(){  
				        	$(this).find("input[type='checkbox']").click(function(){  
				        			var isZt = $(this).val();
					        		var dataPostfee= parseFloat($(this).attr("data-postfee"));  
					        			if($(this).prop('checked')==true){  
					        			$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(1)
					        			}else{ 
					        				$(this).parentsUntil("#orderTpl").find("dd.ztWrap input[type='hidden']").val(0)
					        			} 
					        		 
				        		
				        	})
				        })
		 
				window.goPay=function(){ 
					if($("#addid").length!=0){
						var yourSFZ = $('#sfzin').val();
						 
							plus.nativeUI.showWaiting('加载中 ...', {
								width: '100px',
								height: '80px'
							});
							//地址
							var MYaddress = {};
							var addressid =$("#addid").attr("data-id");
							MYaddress.people = $("#addid").attr("data-name");
							MYaddress.addressNow = $("#addid").attr("data-address");
							MYaddress.phoneNow =  $("#addid").attr("data-phone");
							//买家留言
							var noticeData=[];  
							$(".tipsWrap").each(function(){
								var notice = $(this).find("input").val();
								for(var i=0;i<orderSubmitData.length;i++){
									orderSubmitData[i].sendAddress = MYaddress; 
									if(orderSubmitData[i].storeid == $(this).attr("data-id")){
											if(orderSubmitData[i].goodsData[0].diffrentiate == 2){ 
											orderSubmitData[i].order_type = 4; 
									} 
									    if(orderSubmitData[i].storeid == 0 ){
											orderSubmitData[i].isBySelf = 0;
										}else{
											 var isBySelfDIV = document.getElementsByClassName("ztWrap");
											 for(var m=0;m<isBySelfDIV.length;m++){
											 	var thisShopID = isBySelfDIV[m].getAttribute("data-id");
											 	if(orderSubmitData[i].storeid == thisShopID){
											 		var isBySelf = isBySelfDIV[m].getElementsByClassName("isziti")[0].value; 
											 		if(isBySelf == 0){
											 			orderSubmitData[i].isBySelf = 0;
											 		}else{
											 			orderSubmitData[i].isBySelf = 1;
											 			orderSubmitData[i].postFee = 0;
											 		}
											 	}
											 }
										}
									
										orderSubmitData[i].notice = notice;
									}
								}
								if(notice!=''){
									var noticeObj={};
									noticeObj.shopId = $(this).attr("data-id");
									noticeObj.notice = notice;
									noticeData.push(noticeObj)
								}
								
								
							});
							 
							
							//优惠券id
							var coupon_id='';
							$(".quanc").each(function(){
								if($(this).css("display")=="block"){
									coupon_id =$(this).attr("data-id");
								}
							}) 
							 
							var goodsdata = JSON.stringify(orderSubmitData); 
							var notice = JSON.stringify(noticeData); 
							//提交
							console.log("orderSubmitData 1234ewrew"+JSON.stringify(orderSubmitData))
			 					mui.ajax(serverUrl+'/api/mall/neworder',{
									data:{userid:myuserid,addressid:addressid,paytotal:0,goodsdata:goodsdata,notice:notice,coupon_id:'',isIntergal:1},
									dataType:'json',
									type:'post',
									timeout:1000,
									headers:{"token":oldtoken},	 
									success:function(data,type,xhr){ 
									 
										plus.nativeUI.closeWaiting(); 
										if(data.errno==0){
											var payMent = data.data.payment;
											var order_id=  data.data.order_id; 
//											plus.webview.currentWebview().close();
											openview({
												view:"jifen-success.html",
											 
											}) 
										}else{
											plus.nativeUI.closeWaiting() 
										}
									},
									error:function(xhr,type,errorThrown){
										plus.nativeUI.closeWaiting()
										console.log('响应失败  !');
									}
								}); 
//						
					}else{ 
						plus.nativeUI.closeWaiting()
						mui.toast("您还未选择收货地址哟！")
					}
					 
					
				}
				
		})
		
		//进入地址页面
		function goAddr(){ 
			openview({
				view:"../personal/address.html",
				extrasobj:{pageid:"market-order",userId:myuserid}
			})
		}
		
		//数组去重
		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
		
		//格式化时间戳
		function formatDate(v, format) {
		    if (!v) return "";
		    var d = v;
		    if (typeof v === 'string') {
		        if (v.indexOf("/Date(") > -1)
		            d = new Date(parseInt(v.replace("/Date(", "").replace(")/", ""), 10));
		        else
		            d = new Date(Date.parse(v.replace(/-/g, "/").replace("T", " ").split(".")[0]));//.split(".")[0] 用来处理出现毫秒的情况，截取掉.xxx，否则会出错
		    }
		    var o = {
		        "M+": d.getMonth() + 1,  //month
		        "d+": d.getDate(),       //day
		        "h+": d.getHours(),      //hour
		        "m+": d.getMinutes(),    //minute
		        "s+": d.getSeconds(),    //cond
		        "q+": Math.floor((d.getMonth() + 3) / 3),  //quarter
		        "S": d.getMilliseconds() //millisecond
		    };
		    if (/(y+)/.test(format)) {
		        format = format.replace(RegExp.$1, (d.getFullYear() + "").substr(4 - RegExp.$1.length));
		    }
		    for (var k in o) {
		        if (new RegExp("(" + k + ")").test(format)) {
		            format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
		        }
		    }
		    return format;
		};

	</script>

</html>