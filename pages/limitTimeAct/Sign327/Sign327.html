<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>签到领券</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link href="../../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../../css/config.css"/>
		<script type="text/javascript" src="../../../js/mui.min.js"></script>
		<style type="text/css">
			.mui-bar-nav.mui-bar .mui-icon{margin-left: 0;}
			#isLogin{margin-top: 50px;padding: 10px;margin-top: 50%;text-align: center;}
			#isLoginBtn{margin: 0 auto;display: block;margin-top: 15px;border: 1px solid #d97171;color: #d45252;font-size: 16px;}
			.answerCon{margin-top: 50px;}

			/*.timeOnly{text-align: center;padding: 10px;}
			.timeOnly .p1{font-size: 14px;color: #777;}
			.timeOnly .p2{font-size: 30px;color: #fff;}
			body{background: url(../../../img/limitTimeAct/27yuanxiao/yuanxiaoBG.jpg) 0 50px no-repeat;background-size: 100%;}
			.answerlists{position: relative; width: 90%;height: 90vw; margin: 0 auto;margin-top: 8%;background-color: #fdd45d;border-radius: 50%;
			    overflow: hidden;padding: 13%;}
			.answerlists .h41{font-size: 17px;color: #444;margin-bottom: 6%;line-height: 22px;}
			.answerlists .mui-table-view{background-color: #fdd45d;}
			.answerlists .mui-table-view:after, .answerlists .mui-table-view:before, .answerlists .mui-table-view-cell:after{background-color: #fff;}
			.answerlists .mui-table-view-cell:after{left: 0px;}
			.mui-table-view-radio .mui-table-view-cell .mui-navigate-right:after{font-size: 40px;right: -8px;color: #29337b;}
			.mui-table-view-radio .mui-table-view-cell { padding-right: 0px; }
			.mui-table-view-radio .mui-table-view-cell>a:not(.mui-btn) { margin-right: 0px;padding: 5px;}
			.mui-table-view-cell>a:not(.mui-btn){white-space: initial;}
			.ansBut{position: absolute;width: 100%;text-align: center;left: 0;bottom: 10%;}
			.ansBut button{margin: 0 5%; background-color: #e62019; color: #fff; border: none; line-height: 1.3; padding: 6px 14px;  font-size: 15px;}
			.aClick3:active{background-color: #e1adab;}*/
			.answerCon img.imgSign1{width: 100%;}
			.signBtn{display: block;margin: 0 auto;width: 45%;font-size: 20px;padding: 1.5% 0 1.5%;margin-top: 5%;
				background-color: #f84342;border: none;color: #fff;box-shadow: 0 0 2px rgba(175, 166, 166, 0.85);}
			.signH3{text-align: center;margin: 2% 0;color: #555;}
			.imgSign2{margin-top: 10%;}
			.signH3 b{font-size: 28px;color: #7a350c;}
			.aClickSign:active{background-color: rgba(248, 67, 66, 0.37) !important;}
			.jingduList{padding: 0 2%;box-shadow: 0 0 2px rgba(175, 166, 166, 0.85);width: 94%;margin: 0 auto;border-radius: 3px;margin-top: 10%;}
			#gonglue{padding: 5%;padding-top: 0;color: #7a350c !important;}
			.jingduList li{padding: 5px 0;  padding-left: 20px; border-left: 1px solid #999; margin-left: 10px;position: relative;}
			.jingduList li h5{font-size: 18px;}
			.jingduList li span{position: absolute;display: inline-block;width: 15px;height: 15px;background-color: #999;left: -8px;top: 23px;
				border-radius: 50%;}
			.jingduList li.active{border-left: 1px solid #b3201f;}
			.jingduList li.active span{background-color: #b3201f;}
			.jingduList li.active h5, .jingduList li.active p{color: #b3201f;}
		</style>
	</head>

	<body style="background-color: white;padding-bottom: 0;">
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="goBack mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">签到领券</h1>
		</header>
		<script src="../../../js/statusBar.js"></script><!--状态栏-->
		<div id="isLogin" style="display: none;">
			<p>你还没有登录，登录之后才能进行签到领券活动！</p>
			<button class="aClick" id="isLoginBtn">立即登录</button>
		</div>

		<div class="answerCon" style="display: none;">
			<img class="imgSign1" src="../../../img/limitTimeAct/sign327/qiandaobeijing.jpg"/>
			<h3 class="signH3">本次累计签到 <b id="nowDay">-</b> 天</h3>
			<button class="signBtn aClickSign">点我签到</button>

			<ul id="jingduListDiv" class="jingduList">
				<div style="text-align: center;color: #999;font-size: 18px;padding: 3%;">
					加载中...
				</div>
			</ul>
			<script type="text/html" id="jingduListS">
				<%for(var i=0;i<list.length;i++){%>
					<%if(dayNum>i){%>
						<li class="active">
					<%}else{%>
						<li>
					<%}%>
						<h5><%= list[i].day%></h5>
						<p><%= list[i].msg%></p>
						<span ></span>
					</li>
				<%}%>
			</script>
			<img class="imgSign1 imgSign2" src="../../../img/limitTimeAct/sign327/qiandaoguize_01.jpg"/>
			<p id="gonglue"></p>
		</div>
	</body>
	<script src="../../../js/app.js"></script>
	<script src="../../../js/artTemplate-native.js"></script>
	<script type="text/javascript">
		mui.plusReady(function(){
			// 关闭侧滑返回功能
			var wv=plus.webview.currentWebview();
			wv.setStyle({'popGesture':'none'});
			//判断登录
			if(plus.storage.getItem('myToken')){
				mui('.answerCon')[0].style.display = 'block';
			}else{
				//监听登录
				clearInterval(time1);
				var time1 = setInterval(function(){
					if(plus.storage.getItem('myToken')){
						clearInterval(time1);
						location.reload();
					}
				},1000);

				mui.toast('请登录');
				openview({
					view:'../../login.html'
				});

				mui('#isLogin')[0].style.display = 'block';
				mui('#isLoginBtn')[0].onclick = function(){
					openview({
						view:'../../login.html'
					});
				}
			}

			var oldToken = plus.storage.getItem('oldToken'),
	 			cityNum = plus.storage.getItem('cityNum'),
	 			myuserid = plus.storage.getItem('userid');
 			var mymacId = plus.device.uuid;

 			var showInfo = function(){
 				mui.ajax(serverUrl + '/api/index/checkingitpage', {
					data:{
						"userID":myuserid,
						"checkId":1
					},
	                type: 'post',
	                timeout: 90000,
	                headers: { "token": oldToken,'city':cityNum},
	                success: function(data, type, xhr) {
	                		console.log('签到信息',data);
	                		if(data.errno == 0){
	                			mui('#nowDay')[0].innerHTML = data.data.checkinDays;
	                			mui('#gonglue')[0].innerHTML = data.data.checkinPageData.content;
	                			var dataObj = JSON.parse(data.data.checkinPageData.eventRules);
	                			mui('#jingduListDiv')[0].innerHTML = template('jingduListS',{list:dataObj,dayNum:data.data.checkinDays});
	                		}else{
	                			mui.toast(data.errmsg);
	                		}

	                },
	                error: function(xhr, type, errorThrown) {
	                    	console.log('提交题目验证 响应失败');
	                }
	            });
 			};
			//显示信息
 			showInfo();
            //点击签到
			mui('.signBtn')[0].onclick = function(){
				plus.nativeUI.showWaiting();
				mui.ajax(serverUrl + '/api/index/checkingitcard', {
					data:{
						"userID":myuserid,
						"checkId":1,
						"macId":mymacId
					},
	                type: 'post',
	                timeout: 90000,
	                headers: { "token": oldToken,'city':cityNum},
	                success: function(data, type, xhr) {
	                		plus.nativeUI.closeWaiting();
	                		console.log('点击签到',data);
	                		if(data.errno == 0){
	                			showInfo();
	                			mui.alert(data.data || data.errmsg || '成功打卡一次！');
	                		}else{
	                			mui.alert(data.errmsg || '打卡失败！');
	                		}

	                },
	                error: function(xhr, type, errorThrown) {
	                		plus.nativeUI.closeWaiting();
	                    	console.log('点击签到 响应失败');
	                }
	            });
			}


		})
	</script>

</html>