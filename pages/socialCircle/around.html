<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>附近</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/config.css"/>

	</head>
	<style type="text/css">
		.baocun img{width:20px;vertical-align: middle;}
		.QAhead{background-color:white;text-align:center;margin-bottom: 10px;}
		.QAhead span{position:relative;display:inline-block;margin:0 10px;padding:0 5px;height:50px;color:#343434;font-size:16px;line-height:50px}
		.QAhead span.active{color:#f93a38}
		.QAhead span:after{position:absolute;bottom:0;left:50%;width:0;height:1px;background-color:#f31414;content:""}
		.QAhead span.active:after{left:0!important;width:100%!important;transition:all .3s}
		.listCon{border-bottom: 15px solid #F3F3F3;}
		.listCon p{margin-top: 15px;}
		.follow{position:relative;}
		.follow{background-color:#fff;padding:15px 10px;}
		.follow:after{position:absolute;right:10px;bottom:0;left:10px;height:1px;background:#cacaca;content:'';-webkit-transform:scaleY(.3);}
		.follow:last-child:after{height:0;}
		.fchidl{display:flex;align-items:center;justify-content:space-between;}
		.userAvator{margin-right:15px;width:3rem;height:3rem;border-radius:50%;}
		.fchidl>div{display:flex;vertical-align:middle;text-align:left;font-size:15px;align-items:center;}
		.text{color:#999;}
		#maskInfo{z-index:99999;position:fixed;top:0;left:0;width:100%;bottom:0;background-color:rgba(0,0,0,.5)}
		.ruleCt{position:absolute;padding-right:15px;background-color:#fff;top:50%;left:10%;width:80%;-webkit-transform: translateY(-50%);height: auto;padding:15px 5px;border-radius:3px;bottom: auto;}
		.closemaskb{left:50%;text-align: center;}
		.sexs,.age{padding: 20px 0;text-align: center;}
		.sexs span,.age span{display: inline-block;background: url(../../img/makeFriend/uncke.png) no-repeat;background-size: 100% 100%;background-position: left top;width: 80px;text-align:center;margin: 5px;padding: 4px 0;}
  		.sexs span.checked,.age span.checked{display: inline-block;background: url(../../img/makeFriend/cke.png) no-repeat;background-size: 100% 100%;background-position: left top;width: 80px;text-align:center;margin: 5px;padding: 4px 0;color: #f93a38;}
		.DTcontent{overflow: hidden;}
		.dynamicPic{float: left;position: relative;overflow: hidden;border-right: 2px solid #fff;}
		.dynamicPic1{width: 70%;padding-top: 68%;}
		.dynamicPic2{width: 50%;padding-top: 48%;}
		.dynamicPic3{width: 33%;padding-top: 31%;}
		.dynamicPic img{width: 100%;}
		.dynamicPic span{display: inline-block;position: absolute;top: 2%;left: 2%;width: 96%;height: 96%;background-color: #F3F3F3;overflow: hidden;}

	</style>

	<body style="background-color: #F3F3F3;">

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize back"></a>
			<h1 class="mui-title findUser">附近</h1>
			<a href="javascript:;" style="line-height: 50px;" class="mui-pull-right baocun"><img src="../../img/makeFriend/filter.png"/></a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
			<div class="QAhead" style="position: -webkit-sticky; position:sticky; top: 70px;z-index: 9;">
				<span class="active aClick">附近的人</span>
				<span class="aClick">附近的动态</span>
			</div>

			<div class="circleContain" style="display: block;"></div><!--盒子二-->
			<div class="circleContain" style="display: none;"></div><!--盒子一-->
    		<script type="text/html" id="listDataS">
				<div class="listCon">
					<%if(typeNum == 0){%>
						<%if(dataList.length>20){%>
							<%for(var i=0;i<20;i++){%>
								<%if(dataList[i].user_id){%>
									<div class="follow" onclick="goCircleIndex(<%=dataList[i].user_id%>)">
										<div class="fchidl">
											<div>
												<img data-src="<%=dataList[i].avatar%>" onerror="../../img/10.png" src="../../img/morentouxiang.jpg" class="userAvator mr25 loadPics"/>
												<div>
													<%=dataList[i].nickname%>
													<div class="disablecl ft12">
														<%if(dataList[i].userExplain){%>
															<%=dataList[i].userExplain%>
														<%}%>
													</div>
												</div>
											</div>
											<div class="disablecl ft12">
												<!--5km-->
								           </div>
										</div>
									</div>
								<%}%>
							<%}%>
						<%}else{%>
							<%for(var i=0;i<dataList.length;i++){%>
								<%if(dataList[i].user_id){%>
									<div class="follow" onclick="goCircleIndex(<%=dataList[i].user_id%>)">
										<div class="fchidl">
											<div>
												<img data-src="<%=dataList[i].avatar%>" onerror="../../img/10.png" src="../../img/morentouxiang.jpg" class="userAvator mr25 loadPics"/>
												<div>
													<%=dataList[i].nickname%>
													<div class="disablecl ft12">
														<%if(dataList[i].userExplain){%>
															<%=dataList[i].userExplain%>
														<%}%>
													</div>
												</div>
											</div>
											<div class="disablecl ft12">
												<!--5km-->
								           </div>
										</div>
									</div>
								<%}%>
							<%}%>
						<%}%>

					<%}else{%>
						<%for(var i=0;i<dataList.length;i++){%>
							<div class="follow">
								<div class="fchidl">
									<div>
										<img onclick="goCircleIndex(<%=dataList[i].user_id%>)" data-src="<%=dataList[i].avatar%>" src="../../img/morentouxiang.jpg" class="userAvator mr25 loadPics"/>
										<div>
											<%=dataList[i].nickname%>
											<div class="disablecl ft12">
											<%= dataList[i].create_time%>  <span style="color: #5d86b2;"><%= dataList[i].read%></span>阅读
											</div>
										</div>
									</div>
									<div class="butright">

						           	</div>
								</div>
								<div class="DTcontent" onclick="DTdetail(<%=dataList[i].id%>,<%=dataList[i].user_id%>)">
									<p class="ft14 maincl overTwo"><%= dataList[i].content%></p>
									<%if(dataList[i].pic && dataList[i].pic.length>0){%>
										<%for(var j=0;j<dataList[i].pic.length;j++){%>
											<%if(dataList[i].pic.length == 1){ %>
												<div class="dynamicPic dynamicPic1">
													<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList[i].pic[j].picImg%>" data-preview-src="" data-preview-group="<%=i%>" /></span>
												</div>
											<%}else if(dataList[i].pic.length == 2){%>
												<div class="dynamicPic dynamicPic2">
													<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList[i].pic[j].picImg%>" data-preview-src="" data-preview-group="<%=i%>" /></span>
												</div>
											<%}else{%>
												<div class="dynamicPic dynamicPic3">
													<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList[i].pic[j].picImg%>" data-preview-src="" data-preview-group="<%=i%>" /></span>
												</div>
											<%}%>
										<%}%>
									<%}%>
								</div>
							</div>
						<%}%>
					<%}%>

				</div>
			</script>
			<div class="upload text-center text-xs gray" id="upload"><img src='../../img/balls.svg' /></div><!--加载中效果-->

			<!--遮罩-->
			<div id="maskInfo" style="display: none;">
				<div class="ruleCt">
					<div class="ft16 fttc">性别</div>
					<div class="sexs">
						<span class="checked" data-gender=''>不限</span><span data-gender='1'>男</span><span data-gender='2'>女</span>
					</div>
					<div class="ft16 fttc">年龄</div>
					<div class="age">
						<span class="checked" data-age='0-0'>不限</span><span data-age='18-23'>18-23</span><span data-age='24-29'>24-29</span><span data-age='30-34'>30-34</span><span data-age='35-50'>35以上</span>
					</div>
					<div class="closemaskb">
						<button type="button" class="mui-btn mar10 closemask2" >取消</button>
						<button type="button" class="mui-btn mui-btn-danger mar10 closemaskSure" >确定</button>

					</div>

				</div>
			</div>
		</div>
		<div id='container' style="display:none"></div>

	</body>

<script type="text/javascript" src="../../js/jquery.min.js"></script>
<script src="../../js/mui.min.js"></script>
<script src="../../js/app.js"></script>
<script src="../../js/artTemplate-native.js"></script>
<script src="../../js/mui.zoom.js"></script>
<script src="../../js/mui.previewimage.js"></script>
<!--<link rel="stylesheet" href="http://cache.amap.com/lbs/static/main1119.css"/>-->
<!--<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=608d75903d29ad471362f8c58c550daf"></script>-->
<!--<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>-->
	<script type="text/javascript">
		var Latitude,Longitude,xFactor='',yFactor='';
		//获取地理位置
		 var map, geolocation;
	    //加载地图，调用浏览器定位服务
//	    map = new AMap.Map('container', {
//	        resizeEnable: false
//	    });
//	    map.plugin('AMap.Geolocation', function() {
//	        geolocation = new AMap.Geolocation({
//	            enableHighAccuracy: true,//是否使用高精度定位，默认:true
//	            timeout: 15000,          //超过10秒后停止定位，默认：无穷大
//	            buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
//	            zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
//	            buttonPosition:'RB'
//	        });
//	        map.addControl(geolocation);
//	        geolocation.getCurrentPosition();
//	        AMap.event.addListener(geolocation, 'complete', onComplete);//返回定位信息
//	        AMap.event.addListener(geolocation, 'error', onError);      //返回定位出错信息
//	    });
	    //解析定位结果
	    function onComplete(data) {
//		    	Latitude = data.position.getLat();//纬度
//		    	Longitude = data.position.getLng();//经度
//		    	shopData(0,age,gender);//默认推荐
	    }
		function onError(data) {
//  	 		console.error('定位失败');
    	 		//定位失败取 缓存中 mui自己的 定位数据
//  	 		var longLat = JSON.parse(plus.storage.getItem('longLat'));
// 			Latitude = longLat[0];//纬度
//		    	Longitude = longLat[1];//经度
//		    	shopData(0,age,gender);//默认推荐
	   	}
		mui.plusReady(function(){
			var longLat = JSON.parse(plus.storage.getItem('longLat'));
			Latitude = longLat[1] || '29.569775';//纬度
		    	Longitude = longLat[0] || '106.493343';//经度
		    	shopData(0,age,gender);//默认推荐
		})


		var flag0 = 0,flag1 = 0,flag2 = 0,aroundType = 0,age='',gender='';//是否   第一次点击
		var SH0 = 0,SH1  = 0,SH2  = 0; /*保存的状态栏高度*/
		var listCon = document.getElementsByClassName('QAhead')[0].getElementsByTagName('span');
		var listSon = document.getElementsByClassName('circleContain'); /*内容盒子*/
		[].forEach.call(listCon,function(ele,index){
			ele.onclick = function(){
				if(!ele.className.indexOf('active')>-1){
					[].forEach.call(listCon,function(ele2){
						ele2.className = '';
					})
					ele.className = 'active aClick';
					$('.circleContain').css('display','none')
				    $('.circleContain').eq(index).css('display','block');

				    if(index == 0){//附近的人
				    	aroundType = 0;
						if(flag0==0){
							shopData(index,age,gender);
						}else{
							$(window).scrollTop(SH0);
						}
					}else if(index == 1){//附近的动态
						aroundType = 1;
						if(flag1==0){
							shopData(index,age,gender);
						}else{
							$(window).scrollTop(SH1);
						}
					}

				}
			}
		})

		function shopData(typeNum,age,gender){
			if(typeNum == 0){
				flag0++;
			}else if(typeNum == 1){
				flag1++;
			}
			mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
			mui.plusReady(function(){
				//地球半径
//				alert(Latitude)
				var R = 6371.393;
				var girthY = R * 2 * Math.PI;
				var girthX = Math.cos(Latitude / 180 * Math.PI) * girthY ;
				//x轴转换因子
				xFactor = girthX / 360;
				//y轴转换因子
				yFactor = girthY / 360;
				console.log(Latitude+'-- '+Longitude+'-- '+xFactor+'-- '+yFactor);
				var cityNum = plus.storage.getItem('cityNum'),
					oldToken = plus.storage.getItem('oldToken'),
				    myuserid = plus.storage.getItem('userid');
				//到主页
				window.goCircleIndex = function(id){
					if(plus.storage.getItem('myToken')){
						if(id == myuserid){
							openview({
					    		view:'mycircleIndex.html',
					    		id:'mycircleIndex'
					    	})
						}else{
							openview({
					    		view:'elsecircleIndex.html',
					    		id:'elsecircleIndex',
					    		extrasobj:{userId:id}
					    	})
						}
					}else{
						mui.toast('请登录');
						openview({
							view:'../login.html'
						});
					}
			    }

			    if(typeNum == 0){
				    	var dataJson = {
				    		'latitude':Latitude,'yFactor':yFactor,'longitude':Longitude,'xFactor':xFactor,'type':'member','gender':gender,'age':age
				    	};
			    }else{
				    	var dataJson = {
				    		'latitude':Latitude,'yFactor':yFactor,'longitude':Longitude,'xFactor':xFactor,'type':'news','gender':gender,'age':age
				    	};
			    }
//			    plus.nativeUI.showWaiting();
				mui.ajax(serverUrl+'/api/friends/thingsfromyournear', {
					data:dataJson,
					dataType: 'json',
					type: 'post',
					timeout: 30000,
					headers: {"token": oldToken,'city': cityNum},
					success: function(data, type, xhr) {
						console.error('附近列表'+typeNum, data);
						if(data.errno == 0) {
							if(!data.data.length){
								mui("#upload")[0].innerHTML = "没有数据 !";
							}else{
								var dataObj = {};
								for(var i = 0 ;i<data.data.length;i++){
									if(!data.data[i].username){
										if(data.data[i].nickname && data.data[i].nickname !='null'){
												if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data[i].nickname)){
													data.data[i].nickname = data.data[i].nickname.substring(0,3)+"****"+data.data[i].nickname.substring(7,11)
												}
											}else{
												data.data[i].nickname = '匿名'
											}

										}else{
											data.data[i].nickname = data.data[i].username;
										}
									if(data.data[i].avatar && data.data[i].avatar!='null'){
										if(JSON.parse(data.data[i].avatar)[0].picImg.indexOf('http') == -1){
											data.data[i].avatar = serverimgUrl + JSON.parse(data.data[i].avatar)[0].picImg;
										}else{
											data.data[i].avatar = JSON.parse(data.data[i].avatar)[0].picImg;
										}
									}else{
										data.data[i].avatar = '../../img/10.png'
									}

								  	if(data.data[i].pic && data.data[i].pic!='null'){
										data.data[i].pic = JSON.parse(data.data[i].pic);
										if(data.data[i].pic.length > 0){
											for(var k = 0; k<data.data[i].pic.length;k++){
												if(data.data[i].pic[k].picImg.indexOf('http') == -1){
	                                                data.data[i].pic[k].picImg = serverimgUrl + data.data[i].pic[k].picImg;
	                                            }
											}
										}

									}

								 	if(data.data[i].create_time){
								 		var dt = new Date(data.data[i].create_time).getTime();
										data.data[i].create_time = getDateDiff(dt);
								 	}
									if(!data.data[i].read){
										data.data[i].read = 0
									}else if((data.data[i].read / 1000)>1){
										data.data[i].read = parseInt(data.data[i].read / 1000) +'K+'
									}

								}


								dataObj.dataList = data.data;
								dataObj.typeNum = typeNum;
								document.getElementsByClassName("circleContain")[typeNum].innerHTML = template("listDataS", dataObj);
								mui("#upload")[0].innerHTML = "";
								plus.nativeUI.closeWaiting();
								lazyLoad(true,50);//懒加载

							}
						}else{
							mui("#upload")[0].innerHTML = "";
							console.error('附近列表'+typeNum, data);
							plus.nativeUI.closeWaiting();
							mui.toast('当前网络不好,请重试');
						}
					},
					error: function(xhr, type, errorThrown) {
						console.error('交友列表,响应失败');
						mui("#upload")[0].innerHTML = "";
						plus.nativeUI.closeWaiting();
						mui.toast('当前网络不好,请重试');

					}
				});
			})
		}

		//动态详情1
		function DTdetail(id,userid){
			openview({
				view:'circleListInfo.html',
				extrasobj:{
					infoid: id,
					UserId:userid,
				}
			})
		}


	    //筛选
	 	$('.baocun').click(function(){
			$('#maskInfo').fadeIn(200);
		})

		$('.ruleCt').click(function(){
			event.stopPropagation()
		})
		$('#maskInfo,.closemask2').click(function(){
			event.preventDefault()
			$('#maskInfo').fadeOut(200);
			$('.sexs span,.age span').removeClass('checked');
			$('.sexs').find('span').eq(0).addClass('checked');
			$('.age').find('span').eq(0).addClass('checked');

		})
		//执行筛选
		$('.closemaskSure').click(function(){
			event.preventDefault()
			$('#maskInfo').fadeOut(200);
			shopData(aroundType,age,gender);
		})

		$('.sexs span').click(function(){
			$(this).siblings().removeClass('checked');
			$(this).addClass('checked');
			gender = $(this).attr('data-gender');
		})

		$('.age span').click(function(){
			$(this).siblings().removeClass('checked');
			$(this).addClass('checked');
			ageRange = $(this).attr('data-age').split('-');
			age =JSON.stringify({min:ageRange[0],max:ageRange[1]})
		})

		//发布时间判断
		var minute = 1000 * 60;
		var hour = minute * 60;
		var day = hour * 24;
		var halfamonth = day * 15;
		var month = day * 30;
		function getDateDiff(dateTimeStamp){
			var now = new Date().getTime();
			var diffValue = now - dateTimeStamp;
			var monthC =diffValue/month;
			var weekC =diffValue/(7*day);
			var dayC =diffValue/day;
			var hourC =diffValue/hour;
			var minC =diffValue/minute;
			if(monthC>=1){
			 result=parseInt(monthC) + "月前";
			 }
			 else if(weekC>=1){
			 result=parseInt(weekC) + "周前";
			 }
			 else if(dayC>=1){
			 result=parseInt(dayC) +"天前";
			 }
			 else if(hourC>=1){
			 result=parseInt(hourC) +"小时前";
			 }
			 else if(minC>=1){
			 result=parseInt(minC) +"分钟前";
			 }else{
			 result="刚刚";
			 }
			return result;
		}
			mui.previewImage();
	</script>
	<script type="text/javascript">
		//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
		//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
		mui.plusReady(function () {
			var startTime, endTime, stayTime, flagback = 0;
			startTime = new Date().getTime();
			var old_back = mui.back;
			//改写返回键返回的函数，返回时传页面停留时间
			mui.back = function(){
				endTime = new Date().getTime();//返回时间
				stayTime = Math.ceil((endTime - startTime) / 1000);
				console.log('购物中心'+stayTime);
				plus.statistic.eventDuration( "HIfeiendNearby", stayTime);
				//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				old_back();
			}
			plus.webview.currentWebview().addEventListener( "popGesture", function(){
				flagback++;
				if(flagback == 1){
					endTime = new Date().getTime();
					stayTime = Math.ceil((endTime - startTime) / 1000);
					plus.statistic.eventDuration( "HIfeiendNearby", stayTime);
					//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				}
			}, false );
		});
	</script>

</html>