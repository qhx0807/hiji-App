<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>动态详情</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/config.css"/>

	</head>
	<style type="text/css">
		.baocun{text-align:right;}
		.baocun img{vertical-align:middle;width: 20px;}
		.listCon{border-bottom: 10px solid #f3f3f3;}
		.listCon p{padding:10px 0 0}
		.follow{position:relative;}
		.follow{background-color:#fff;padding:15px 10px;}
		.follow:after{position:absolute;right:10px;bottom:0;left:10px;height:1px;background:#cacaca;content:'';-webkit-transform:scaleY(.3);}
		.follow:last-child:after{height:0;}
		.fchidl{display:flex;align-items:center;justify-content:space-between;}
		.userAvator{margin-right:10px;width:2.5rem;height:2.5rem;border-radius:50%;}
		.userAvator3{margin-right:10px;width:2rem;height:2rem;border-radius:50%;}
		.fchidl>div{display:flex;vertical-align:middle;text-align:left;font-size:15px;align-items:center;}
		.text{color:#999;}
  		.flexrr{display: flex;justify-content: space-between;align-items: center;padding: 15px 0;}
  		.flexrr>div img{width: 20px;vertical-align: middle;}
  		.cmtall img{width: 25px;margin-right: 5px;}
  		.cmtflex{display: flex;justify-content: space-between;align-items: center;}
  		.ctc span{color: #fb7e23;}
  		ul{list-style: none;padding: inherit;margin: 0;}
		.jubao{background-color: white;bottom: 0!important;position: absolute;right: 0;left: 0;}
		.jubao li a{padding: 18px;line-height: 15px;text-align: center;border-bottom: 1px solid #EEEEEE;display: block;color: black;}
		.jubao li:last-child a{color: rgb(153,153,153);}
	   	.diybtn{background: url(../../img/makeFriend/follow.png) no-repeat;background-size: 100% 100%;background-position: left top;color: white;padding: 4px 22px;}
  		.diybtn2{background: url(../../img/makeFriend/unfollw.png) no-repeat;background-size: 100% 100%;background-position: left top;color: #31c58b;padding: 4px 22px;}
		.yhm{width:calc((100vw - 50px)/3);width:-webkit-calc((100vw - 50px)/3);width:-moz-calc((100vw - 50px)/3);height: calc((100vw - 20px)/3);height: -webkit-calc((100vw - 20px)/3);height: -moz-calc((100vw - 20px)/3);margin-left: 5px;margin-top:10px ;}
		.giveBk{background: url(../../img/makeFriend/give.png) no-repeat;background-size: 100% 100%;background-position: left top;color: #31c58b;padding: 6px 25px;color: white;}
		.fchidl2{display: flex;align-items:top;}
		.fchidl2 .butright{flex-grow: 1;}
		.fchidl2 .btop{display: flex;justify-content: space-between;align-items: center;}
		.fchidl3 .btop{display: flex;justify-content: flex-start!important;align-items: center;}
		.opbot{display: flex;padding: 10px;align-items:center;position: fixed;bottom: 0;left: 0;right: 0;background-color: white;box-shadow: 0px 1px 1px 1px #EEEEEE;}
		.writecmt{flex-grow: 1;background: url(../../img/makeFriend/cmtbor.png) no-repeat bottom;padding: 5px;max-height: 80px;overflow-y: scroll;}
		.opbot img{width: 28px;margin: 0 5px;}
		/*为空时显示 element attribute content*/
		.writecmt:empty:before{
		    content: attr(placeholder);
		    color:#999;
		}
		/*焦点时内容为空*/
		/*.writecmt:focus:before{
		    content:none;
		}*/
		.follow .maincl{letter-spacing: 0.4px;line-height: 1.5;}
		.follow b{font-weight: 600;color: #FD6363;}
		.fchidl3{padding: 10px 10px;border-left: 1px solid #ccc;}
		.DTcontent{overflow: hidden;}
		.dynamicPic{float: left;position: relative;overflow: hidden;border-right: 2px solid #fff;}
		.dynamicPic1{width: 70%;padding-top: 68%;}
		.dynamicPic2{width: 50%;padding-top: 48%;}
		.dynamicPic3{width: 33%;padding-top: 31%;}
		.dynamicPic img{width: 100%;}
		#maskInfo{z-index:99999;position:fixed;top:0;left:0;width:100%;bottom:0;background-color:rgba(0,0,0,.5)}
		.jubao{background-color: white;}
		.jubao li a{padding: 18px;line-height: 15px;text-align: center;border-bottom: 1px solid #EEEEEE;display: block;color: black;}
		.jubao li:last-child a{color: rgb(153,153,153);}
		.dynamicPic span{display: inline-block;position: absolute;top: 2%;left: 2%;width: 96%;height: 96%;background-color: #F3F3F3;overflow: hidden;}
		i:active{color: red;}
	</style>

	<body style="background-color: white;">

		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize back"></a>
			<h1 class="mui-title findUser">详情</h1>
			<a href="javascript:;" style="line-height: 50px;" class="mui-pull-right baocun goanswer"><img src="../../img/center/moreGray.png"/></a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">

    		<div class="listCon" id="listInfoS"></div><!--内容-->
			<script type="text/html" id="listDataS">
				<div class="follow">
					<div class="fchidl">
						<div>
							<img src="<%=dataList.avatar%>" id="Myavator" onclick="goCircleIndex(<%=dataList.userid%>)" class="userAvator mr25"/>
							<div>
								<span id="myNickename"><%=dataList.nickname%></span> <div class="disablecl ft12"> <%=dataList.create_time%>  <span style="color: #5d86b2;"><%=dataList.read%></span>阅读 </div>
							</div>
						</div>
						<div class="butright isFollow">
							<div class="diybtn2">
								聊天
							</div>
			           </div>
					</div>

					<div class="DTcontent">
						<p class="ft15 maincl leirong" style="-webkit-user-select: text;"><%=dataList.content%></p>
						<%if(dataList.picS && dataList.picS.length){%>
							<%for(var j=0;j<dataList.picS.length;j++){%>
								<%if(dataList.picS.length == 1){ %>
									<div class="dynamicPic dynamicPic1">
										<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList.picS[j]%>" data-preview-src="" data-preview-group="1"/></span>
									</div>
								<%}else if(dataList.picS.length == 2){%>
									<div class="dynamicPic dynamicPic2">
										<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList.picS[j]%>" data-preview-src="" data-preview-group="1"/></span>
									</div>
								<%}else{%>
									<div class="dynamicPic dynamicPic3">
										<span><img onload="imgHeight(this)" class="loadPics picOp" data-src="<%=dataList.picS[j]%>" data-preview-src="" data-preview-group="1"/></span>
									</div>
								<%}%>
							<%}%>
						<%}%>
					</div>

					<div class="flexrr">
						<div class="disablecl ft14">
							<img src="../../img/makeFriend/corn.png"/> 感谢您的赏脸阅读
						</div>
						<div class="disablecl ft14 giveBk" data-id="<%=dataList.userid%>">
							<img src="../../img/makeFriend/cornw.png"/> 赏
						</div>
					</div>
				</div>
			</script>
		 	<!--评论-->
			<div class="follow cmtflex">
				<div style="text-align: center;line-height: 0.8;">
					<div class="ft14">评论</div>
					<img style="width: 30px;margin: 0;" src="../../img/makeFriend/cmt.png"/>
				</div>
			</div>
			<div id="curShow"></div>
		 	<script type="text/html" id="cmtTpl">

		 		<%for(var i=0;i<list.length;i++){%>
					<%if(!list[i].commontid){%>
						<div class="follow ft12">
							<div class="fchidl2">
								<div class="ctc" onclick="goCircleIndex(<%=list[i].userid%>)">
									<img src="<%=list[i].avatar%>" class="userAvator loadPics"/>
								</div>
								<div class="butright">
									<div class="ft12 btop">
					            		<b class="ft14"><%=list[i].nickname%></b> <span class="disablecl"><%=list[i].create_time%></span>
					            	</div>
					            	<div class="maincl ft14" style="-webkit-user-select: text;" data-toName="<%=list[i].nickname%>" data-userId="<%=list[i].userid%>" data-cmtId="<%=list[i].id%>"><%=list[i].commont%></div>
					           </div>
							</div>
						</div>
						<%}else{%>

							<div class="follow ft12">
	                            <div class="fchidl2">
	                                <div class="ctc" onclick="goCircleIndex(<%=list[i].userid%>)">
	                                    <img src="<%=list[i].avatar%>" class="userAvator loadPics"/>
	                                </div>
	                                <div class="butright">
	                                    <div class="ft12 btop">
	                                        <b class="ft14"><%=list[i].nickname%></b> <span class="disablecl"><%=list[i].create_time%></span>
	                                    </div>
	                                    <div class="maincl ft14" data-toName="<%=list[i].nickname%>" style="-webkit-user-select: text;" data-userId="<%=list[i].userid%>" data-cmtId="<%=list[i].id%>"><%=list[i].commont%></div>
	                                    <div class="cmtChild" data-toUserId="<%=list[i].touserid%>" data-toCmtId="<%=list[i].commontid%>"></div>
	                               </div>
	                            </div>
	                        </div>

							<%}%>
					<%}%>
		 	</script>
			 <!--子评论-->
            <script type="text/html" id="cmtChildTpl">

                <%for(var i=0;i<list.length;i++){%>

                        <div class="fchidl2 fchidl3">
                            <div class="ctc" onclick="goCircleIndex(<%=list[i].userid%>)">
                                <img src="<%=list[i].avatar%>" class="userAvator3 loadPics"/>
                            </div>
                            <div class="butright">
                                <div class="ft12 btop">
                                    <b><%=list[i].nickname%></b>
                                </div>
                                <div class="maincl ft12"><%=list[i].commont%></div>
                           </div>
                        </div>
                    <%}%>

            </script>

		</div>



		<!--操作表-->
		<div id="maskInfo" style="display: none;">
		    <!-- 可选择菜单 -->
		    <ul class="jubao">
		      <li class="ownclose">
		        <a href="javascript:;" onclick="doJubao()">加入黑名单</a>
		      </li>
		      <li class="ownclose">
		        <a href="javascript:;" onclick="doJubao()">举报</a>
		      </li>
		      <li class="ownDel" style="display:none">
		        <a href="javascript:;" onclick="doDel()">删除</a>
		      </li>
		      <li>
		        <a href="javscript:;" class="closeMask" >取消</a>
		      </li>
		    </ul>
		</div>

		<!--底部评论-->
		<div class="opbot">
			<div style="-webkit-user-select: text;" class="writecmt ft14" placeholder="写评论" contenteditable="true" ></div>
			<div id='cmtedup' class="ft14 maincl">
				发送
				<!--<img src="../../img/makeFriend/message.png" alt="" />-->
			</div>
			<div>
				<img id="doLike" src="../../img/makeFriend/zan.png" alt="" />
			</div>
			<div class="shareitBtn">
				<img src="../../img/makeFriend/share.png" alt="" />
			</div>
		</div>
	 </body>
	<script type="text/javascript" src="../../js/jquery.min.js"></script>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js"></script>
	<script src="../../js/mui.zoom.js"></script>
	<script src="../../js/mui.previewimage.js"></script>
	<script src="../../js/artTemplate-native.js"></script>

	<script type="text/javascript">
		mui.plusReady(function(){
			var cityNum = plus.storage.getItem('cityNum'),
			    oldToken = plus.storage.getItem('oldToken'),
				myuserid = plus.storage.getItem('userid'),
				infiId = plus.webview.currentWebview().infoid,
				toCmt = plus.webview.currentWebview().isCmt,
				newsUserId = plus.webview.currentWebview().UserId,
				delc = plus.webview.currentWebview().delc,
				commontid = '',touserid='';
			if(toCmt){
				window.document.body.scrollTop = document.body.scrollHeight;
				//自动弹出输入法
				var nativeWebview, imm, InputMethodManager;
				var initNativeObjects = function() {
					if(mui.os.android) {
						var main = plus.android.runtimeMainActivity();
						var Context = plus.android.importClass("android.content.Context");
						InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
						imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
					} else {
						nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
					}
				};
				var showSoftInput = function() {
					if(mui.os.android) {
						imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
					} else {
						nativeWebview.plusCallMethod({
							"setKeyboardDisplayRequiresUserAction": false
						});
					}
					//此处可写具体逻辑设置获取焦点的input
					setTimeout(function() {
						$('.writecmt').focus();
					}, 0);
				};
				initNativeObjects();
				showSoftInput();

			}
			//删除自己的帖子
			if(delc==1 && newsUserId == myuserid){
				$('.ownDel').css('display','block');
				$('.ownclose').css('display','none')
			}
			window.goCircleIndex = function(id){
				if(plus.storage.getItem('myToken')){
					if(id == myuserid){
						openview({
				    		view:'mycircleIndex.html',
				    		id:'mycircleIndex'
				    	})
					}else{
						openview({
				    		view:'elsecircleIndex.html',
				    		id:'elsecircleIndex',
				    		extrasobj:{userId:id}
				    	})
					}
				}else{
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}
		    }
			window.doJubao= function(){

				if(plus.storage.getItem('myToken')){
					jubao(infiId,newsUserId,myuserid,cityNum,oldToken)
				}else{
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}
			}
			window.doDel= function(){
				if(plus.storage.getItem('myToken')){
					plus.nativeUI.showWaiting();
					mui.ajax(serverUrl+'/api/friends/deletenews',{
						data:{userId:myuserid,newsId:infiId},
						type:'post',
						timeout:10000,
						headers:{"token":oldToken,"city":cityNum},
						success:function(data){
							console.log('删除返回'+JSON.stringify(data));
							if(data.errno == 0){
								plus.nativeUI.closeWaiting();
								mui.toast('删除成功');
								var page = plus.webview.getWebviewById('mycircleIndex');
									mui.fire(page,'refreshcl');
								setTimeout(function(){
									plus.webview.currentWebview().close();
								},500)
							}else{
								mui.toast('删除失败, 请重试');
							}
						},
						error:function(xhr,type,errorThrown){
							mui.toast('响应失败  !');
						}
					});
				}else{
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}
			}
			mui.ajax(serverUrl + '/api/friends/newsinfo/newsId/'+infiId+'/userid/'+myuserid, {
				dataType: 'json',
				type: 'get',
				timeout: 8000,
				headers: {"token": oldToken,'city': cityNum},
				success: function(data, type, xhr) {
					console.log('动态详情', data);
					if(data.errno == 0) {
						var dataObj = {}, nowArray = data.data;

						if(nowArray.avatar && nowArray.avatar!='null'){
							if(JSON.parse(nowArray.avatar)[0].picImg.indexOf('http') == -1){
								nowArray.avatar = serverimgUrl + JSON.parse(nowArray.avatar)[0].picImg;
							}else{
								nowArray.avatar = JSON.parse(nowArray.avatar)[0].picImg
							}
						}else{
							nowArray.avatar = '../../img/10.png'
						}

						if(nowArray.nickname && nowArray.nickname !='null'){
							if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(nowArray.nickname)){
								nowArray.nickname = nowArray.nickname.substring(0,3)+"****"+nowArray.nickname.substring(7,11)
							}
						}else{
							nowArray.nickname = '匿名'
						}
						if(!nowArray.read){
							nowArray.read = 0
						}else if((nowArray.read / 1000)>1){
							nowArray.read = parseInt(nowArray.read / 1000) +'K+'
						}

						var dt = new Date(nowArray.create_time).getTime();
						nowArray.create_time = getDateDiff(dt);


						//整理内容图片
						var nowArray2 = JSON.parse(nowArray.pic);
						if(nowArray2.length){
							var picS = [];
							for(var k = 0 ;k<nowArray2.length;k++){
								picS.push(nowArray2[k].picImg);
							}
							nowArray.picS = picS;
						}
						//判断是否点赞
						if(data.errmsg && data.errmsg.isLike==1){
							$('#doLike').attr('src','../../img/makeFriend/yizan.png');
						}else{
							$('#doLike').attr('src','../../img/makeFriend/zan.png');
						}
						dataObj.dataList = data.data;
						document.getElementById("listInfoS").innerHTML = template("listDataS", dataObj);
						$('.diybtn').click(function(){
							var curL = $(this);
					    		//关注
					    		if(plus.storage.getItem('myToken')){
									followBack(curL,newsUserId,'put');
							}else{
								mui.toast('请登录');
								openview({
									view:'../login.html'
								});
							}
					    	})
						//显示链接颜色
						var textCon = document.getElementsByClassName('leirong')[0].innerHTML;
						var urlRegExp = new RegExp("((https|http|ftp|rtsp|mms|www)?:\/*\/*)[^\u4E00-\u9FA5]+");
						if(urlRegExp.exec(textCon) != null){
							var urlReplace = urlRegExp.exec(textCon)[0];
							var endUrl = '<i style="color:#aa4848;text-decoration:underline;word-break:break-all">'+urlReplace+'(点击打开链接)</i>';
							textCon = textCon.replace(urlReplace,endUrl);
							document.getElementsByClassName('leirong')[0].innerHTML = textCon;
						}

						if(newsUserId == myuserid){
							$('.isFollow').css('display','none')
						}
						//举报
						$('.goanswer').click(function(){
							event.stopPropagation();
							$('#maskInfo').fadeIn(200);
						})

						$('#maskInfo li').click(function(){
							event.stopPropagation()
						})
						$('#maskInfo,.closeMask').click(function(){
							event.preventDefault()
							$('#maskInfo').fadeOut(200);
						})

						//打赏
						$('.giveBk').click(function(){
				    		event.preventDefault();
				    		if(plus.storage.getItem('myToken')){
								var acceptid = $(this).attr('data-id');
									openview({
										view:'../answerBoard/reward.html',
										id:'reward',
										extrasobj:{newsId:infiId,acceptId:acceptid}
									})
							}else{
								mui.toast('请登录');
								openview({
									view:'../login.html'
								});
							}

						})
						/*分享*/
						mui('.shareitBtn')[0].onclick = function(){
							var thumbs = '';
							if(nowArray2.length){
								thumbs = nowArray2[0].picImg;
							}
							var msg = {
								title:mui('.leirong')[0].innerHTML,
								content:mui('.leirong')[0].innerHTML,
								href:fxUrl+'socialCircle/circleListInfo.html?infoid='+infiId+'&UserId='+newsUserId,
								thumbs:[thumbs],
								pictures:[thumbs]
							};
							showSfun1(msg);
						}

						//判断是否关注
						mui.ajax(serverUrl+'/api/friends/likeusers',{
							data:{"userId":myuserid},
							type:'post',
							timeout:8000,
							headers:{"token":oldToken,"city":cityNum},
							success:function(data,type,xhr){
								console.log('获取数据返回',data);
								if(data.errno == 0){
									if(data.data.ILikeUsers && data.data.ILikeUsers.length){
										var m = 0;
										[].forEach.call(data.data.ILikeUsers,function(ele,index){

											if(ele.user_id == newsUserId){
												m++;
												if(newsUserId != myuserid){
													$('.diybtn2').css('display','block');
													$('.diybtn').css('display','none');
												}else{
													$('.diybtn2').css('display','none');
													$('.diybtn').css('display','none');
												};
												return;
											}

										})
										if(m==0){
											$('.diybtn').css('display','block');
										}
										//聊天
										$('.diybtn2').click(function(){
											if(plus.storage.getItem('myToken')){
												mui.ajax(serverUrl+'/api/useraccount/userinfo',{
													data:{"userid":plus.storage.getItem('userid')},
													type:'post',
													timeout:10000,
													headers:{"token":oldToken},
													success:function(data,type,xhr){
														console.log('获取用户数据返回',data);
														if(data.errno == 0){
															var nowArray = data.data[0];
															var myavatar;
		                            						//整理头像格式
															if(nowArray.avatar && nowArray.avatar!='null'){
																if(JSON.parse(nowArray.avatar)[0].picImg.indexOf('http') == -1){
																	myavatar = serverimgUrl + JSON.parse(nowArray.avatar)[0].picImg;
																}else{
																	myavatar = JSON.parse(nowArray.avatar)[0].picImg;
																}
															}else{
																myavatar= '../../img/10.png';
															}
		                            						openview({
												 				view:'friendChat.html',
												 				extrasobj:{'toUserId':newsUserId,'myAvatar':myavatar,'mynickname':$('#myNickename').html()}
												 			})
														}
													},
													error:function(xhr,type,errorThrown){
														console.log('获取用户数据,响应失败');
													}
												});

											}else{
												mui.toast('请登录');
												openview({
													view:'../login.html'
												});
											}

								    	})

									}else{
										$('.diybtn').css('display','block');
									}
								}else{
									console.log(data.errmsg);
								}
							},
							error:function(xhr,type,errorThrown){
								console.log('获取数据,响应失败');
							}
						});

						lazyLoad(true);//懒加载
					}else{
						mui.toast('当前网络不好,请重试');
					}
				},
				error: function(xhr, type, errorThrown) {
					console.error('交友列表,响应失败');
					mui.toast('当前网络不好,请重试');
				}
			});

			//评论
			getCmt();
			function getCmt(){
				mui.ajax(serverUrl + '/api/friends/newscomment/newsId/'+infiId, {
					dataType: 'json',
					type: 'get',
					timeout: 8000,
					headers: {"token": oldToken,'city': cityNum},
					success: function(data, type, xhr) {
						console.log('评论详情', data);

						if(data.errno == 0) {
							var cmtArray = data.data;
							if(cmtArray && cmtArray.length>0){

									for(var i = 0;i<cmtArray.length;i++){
										if(!cmtArray[i].nickname){
                                            cmtArray[i].nickname =  '匿名'
                                        }else{
											if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(cmtArray[i].nickname)){
												cmtArray[i].nickname = cmtArray[i].nickname.substring(0,3)+"****"+cmtArray[i].nickname.substring(7,11)
											}
										}

										if(cmtArray[i].avatar && cmtArray[i].avatar!='null'){
											if(JSON.parse(cmtArray[i].avatar)[0].picImg.indexOf('http') == -1){
												cmtArray[i].avatar = serverimgUrl + JSON.parse(cmtArray[i].avatar)[0].picImg;
											}else{
												cmtArray[i].avatar = JSON.parse(cmtArray[i].avatar)[0].picImg
											}
										}else{
											cmtArray[i].avatar = '../../img/10.png'
										}

										var dt = new Date(cmtArray[i].create_time).getTime();
										cmtArray[i].create_time = getDateDiff(dt);
									}
									$('#curShow').html(template('cmtTpl',{list:cmtArray}));
									//回复 或 评论
								    	$('.butright .maincl').click(function(){
								    		event.stopPropagation();
								    		var toName = $(this).attr('data-toName'),
								    			touserid = $(this).attr('data-userId');
								    			commontid = $(this).attr('data-cmtId');
								    			$('.writecmt').focus();
	   										$('.writecmt').attr('placeholder','回复:'+toName);
	   									 	$('.writecmt').attr('id',touserid);
	   									 	$('.writecmt').attr('data-id',commontid);
								    	})
 									 //子评论
                                    $('.cmtChild').each(function(){
                                        var curCmt = $(this);
                                        var curUserId = curCmt.attr('data-toUserId');
                                        var curCmtId = curCmt.attr('data-toCmtId');
                                        mui.ajax(serverUrl + '/api/friends/newscomment/newsId/'+infiId, {
                                            dataType: 'json',
                                            type: 'get',
                                            timeout: 8000,
                                            headers: {"token": oldToken,'city': cityNum},
                                            success: function(data, type, xhr) {
                                                console.error('评论详情', data);

                                                if(data.errno == 0) {
                                                    var cmtArray = data.data;
                                                    var childArray = [];
                                                    if(cmtArray && cmtArray.length>0){
                                                        for(var i = 0;i<cmtArray.length;i++){
                                                            if(!cmtArray[i].nickname){
                                                                cmtArray[i].nickname =  '匿名'
                                                            }else{
																if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(cmtArray[i].nickname)){
																	cmtArray[i].nickname = cmtArray[i].nickname.substring(0,3)+"****"+cmtArray[i].nickname.substring(7,11)
																}
															}

                                                            if(cmtArray[i].avatar && cmtArray[i].avatar!='null'){
                                                                if(JSON.parse(cmtArray[i].avatar)[0].picImg.indexOf('http') == -1){
                                                                    cmtArray[i].avatar = serverimgUrl + JSON.parse(cmtArray[i].avatar)[0].picImg;
                                                                }else{
                                                                    cmtArray[i].avatar = JSON.parse(cmtArray[i].avatar)[0].picImg
                                                                }
                                                            }else{
                                                                cmtArray[i].avatar = '../../img/10.png'
                                                            }

                                                            var dt = new Date(cmtArray[i].create_time).getTime();
                                                            cmtArray[i].create_time = getDateDiff(dt);
                                                            if(cmtArray[i].id == curCmtId && curUserId == cmtArray[i].userid){
                                                                childArray.push(cmtArray[i])
                                                            }
                                                        }
                                                        console.log('子评论',childArray)
                                                        curCmt.html(template('cmtChildTpl',{list:childArray}));
                                                     }

                                                }else{
                                                    mui.toast('当前网络不好,请重试');
                                                }
                                            },
                                            error: function(xhr, type, errorThrown) {
                                                console.error('评论列表,响应失败');
                                                mui.toast('当前网络不好,请重试');
                                            }
                                        });
                                    })

							}else{
								$('#curShow').html('<img src="../../img/nocmt.png" style="width: 100px;display: block;margin: auto;"/><br/><div class="maincl" style="text-align: center;padding: 10px;font-size:13px;color: #888;">快来抢沙发</div>');
							}

						}else{
							mui.toast('当前网络不好,请重试');
						}
					},
					error: function(xhr, type, errorThrown) {
						console.error('评论列表,响应失败');
						mui.toast('当前网络不好,请重试');
					}
				});
			}
			$('#cmtedup').click(function(){
				if(plus.storage.getItem('myToken')){
					if($('.writecmt').text() != ''){
		    			var cur = $('.writecmt');
		    			var commont = cur.text(),
		    				touserid = $('.writecmt').attr('id'),
		    				commontid = $('.writecmt').attr('data-id');
		    			mui.ajax(serverUrl + '/api/friends/newscomment', {
		    				data:{newsId:infiId,userid:myuserid,touserid:touserid,commont:commont,commontid:commontid},
							dataType: 'json',
							type: 'POST',
							timeout: 8000,
							headers: {"token": oldToken,'city': cityNum},
							success: function(data, type, xhr) {
								console.error('评论详情', data);

								if(data.errno == 0) {
					    			cur.html('');
					    			mui.toast('评论成功');
				    				$('.writecmt').attr('placeholder','');
									 $('.writecmt').attr('id','');
									 $('.writecmt').attr('data-id','');
					    			getCmt();
								}else{
									mui.toast('当前网络不好,请重试');
								}
							},
							error: function(xhr, type, errorThrown) {
								console.error('评论列表,响应失败');
								mui.toast('当前网络不好,请重试');
							}
						});


		    		}else{
		    			$('.writecmt').focus();
		    		}
				}else{
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}


	    	})


			//点赞
			$('#doLike').click(function(){
				if(plus.storage.getItem('myToken')){
					var curThis = $(this);
					if(curThis.attr('src') == '../../img/makeFriend/zan.png'){
						likeThis(curThis,infiId,newsUserId,cityNum,myuserid,oldToken,'POST','../../img/makeFriend/yizan.png')
					}else{
						likeThis(curThis,infiId,newsUserId,cityNum,myuserid,oldToken,'DELETE','../../img/makeFriend/zan.png')
					}
				}else{
					mui.toast('请登录');
					openview({
						view:'../login.html'
					});
				}
			})

		})

		//发布时间判断
		var minute = 1000 * 60;
		var hour = minute * 60;
		var day = hour * 24;
		var halfamonth = day * 15;
		var month = day * 30;
		function getDateDiff(dateTimeStamp){
			var now = new Date().getTime();
			var diffValue = now - dateTimeStamp;
			var monthC =diffValue/month;
			var weekC =diffValue/(7*day);
			var dayC =diffValue/day;
			var hourC =diffValue/hour;
			var minC =diffValue/minute;
			if(monthC>=1){
			 result=parseInt(monthC) + "月前";
			 }
			 else if(weekC>=1){
			 result=parseInt(weekC) + "周前";
			 }
			 else if(dayC>=1){
			 result=parseInt(dayC) +"天前";
			 }
			 else if(hourC>=1){
			 result=parseInt(hourC) +"小时前";
			 }
			 else if(minC>=1){
			 result=parseInt(minC) +"分钟前";
			 }else{
			 result="刚刚";
			 }
			return result;
		}
		document.addEventListener("tap",function(event){
			var name = event.target.innerText;
			var urlRegExp = new RegExp("((https|http|ftp|rtsp|mms|www)?:\/*\/*)[^\u4E00-\u9FA5]+");
			if(urlRegExp.exec(name) != null){
				var pipeiurl = urlRegExp.exec(name);
				openview({
					view:'linkurl.html',
					id: "linkurl",
					extrasobj: {
						bannerUrl: pipeiurl[0]
					}
				})
			}
		})

	</script>
	<script type="text/javascript">

 		mui.previewImage();

	</script>
	<script type="text/javascript">
		//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
		//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
		mui.plusReady(function () {
			var startTime, endTime, stayTime, flagback = 0;
			startTime = new Date().getTime();
			var old_back = mui.back;
			//改写返回键返回的函数，返回时传页面停留时间
			mui.back = function(){
				endTime = new Date().getTime();//返回时间
				stayTime = Math.ceil((endTime - startTime) / 1000);
				console.log('购物中心'+stayTime);
				plus.statistic.eventDuration( "HIfeiendDynamic", stayTime);
				//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				old_back();
			}
			plus.webview.currentWebview().addEventListener( "popGesture", function(){
				flagback++;
				if(flagback == 1){
					endTime = new Date().getTime();
					stayTime = Math.ceil((endTime - startTime) / 1000);
					plus.statistic.eventDuration( "HIfeiendDynamic", stayTime);
					//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				}
			}, false );
		});
	</script>

</html>