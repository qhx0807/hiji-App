<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>编辑资料(交友)</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" type="text/css" href="../../css/config.css"/>
		<style type="text/css">
			#userMessContainer{margin-top: 50px;
			}
			i{ont-style: normal;
			}
			i.container{position: relative;
			}
			i.imgContainer .upload{position: absolute;
				top:0;left:0;bottom:0;right:0;
				z-index:999;
			}
			#main{margin-bottom: 100px;
			}
			select{display: inline-block !important;
				float:right !important;
				font-size: 14px !important;
				margin-top:10px;
			}
			input{border:none !important;
			}
			.box-s{padding-left:5%;
			}
			.muibackdrop{width:80%;
				height:100px;
				padding:15px 50px;
				line-height: 30px;
				position: absolute;
				top:20%;
				left:10%;
				border:1px solid #F53C42;
				background: #ffffff;
			}
			.saveMessage{color:#FFFFFF;
				margin-right: 20px;
				line-height: 50px;
				font-size: 14px;
			}
			.muibackdrop{display: none;
			}
			.selectbtn{float: right !important;
				width: 17%;
				margin: 0;
			}
			.data ul li .shuru{margin-bottom: 0;
			}
			.data ul li img {
			    width: 100px;
			    max-height: none;
			}
			.wx_type_img{position: relative;
			}
			.wx_type_img input#imgUpload{margin: 0;cursor: pointer;position: absolute;top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				opacity: 0;
				filter: alpha(opacity=0);
			}
			#imgUpload{display: none;
			}
			.plist ul li{
				border-bottom: none;

			 	border-bottom: 10px solid #F3F3F3;
			}

			.renting-footer{height: 50px;}
			.data ul li .shuru{
				line-height: 14px;
			}
			.data ul li .shuru::placeholder{
				padding-top:4px;
			}
			.diybut{color: #999;background:url(../../img/makeFriend/cc.png) no-repeat;background-size: 100% 100%;background-position: left top;width: 70px;text-align: center;padding: 8px 0;display: inline-block;margin-right: 5px;margin-bottom: 5px;}
			.diybuted{background:url(../../img/makeFriend/dd.png) no-repeat;color: white;background-size: 100% 100%;background-position: left top;width: 70px;text-align: center;padding: 8px 0;display: inline-block;margin-right: 5px;margin-bottom: 5px;}

		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">编辑资料</h1>
		    <a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun" id="Preservation">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
	    	<div class="plist clearfloat data" id="userMessContainer">
				<ul>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">昵称</p>
							<input type="text" class="fr shuru" name="" id="nkname" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">个性签名</p>
							<input type="text" class="fr shuru" name="" id="explain" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">性别</p>
			    			<select class="mui-btn mui-btn-block selectbtn" id="Nextbtn" dir="rtl">
								<option value="item-1">保密</option>
								<option value="item-2">男</option>
								<option value="item-2">女</option>
							</select>
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">星座</p>
							<input type="text" class="fr shuru" name="" id="horoscope" placeholder="填写" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">年龄</p>
							<input type="number" class="fr shuru" name="" id="age" placeholder="填写" />
						</a>
					</li>

					<li class="clearfloat touxiang">
						<a>
							<p>更换背景图片</p>
							<label style="display: block;">
								<span>
									<div class="text-center gray" id="preview"><img onclick="galleryImgsSelected()" id="mypic1" src="../../img/answer/editset.png"/></div>
								</span>
								<!--<input type="file" accept="image/png,image/gif,image/jpg,image/jpeg" id="imgUpload" name="img[]" class="upload-add">-->
							</label>
						</a>
					</li>
					<li class="clearfloat touxiang">
						<a>
							<p>个性标签</p>
							<div id="psLabel">

							</div>

						</a>
					</li>

				</ul>
			</div>
	    </div>


	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script type="text/javascript">
		mui.plusReady(function(){
			var myuserid = plus.storage.getItem('userid');
			var cityNum = plus.storage.getItem('cityNum');
			var oldToken = plus.storage.getItem('oldToken');
			//显示既有信息
			mui.ajax(serverUrl+'/api/friends/friendhome/userId/'+myuserid,{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":cityNum},
				success:function(data,type,xhr){
					console.log('交友编辑资料 显示既有信息',data);
					if(data.errno == 0){
						if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data.username)){
							data.data.username = data.data.username.substring(0,3)+"****"+data.data.username.substring(7,11)
						}

						if(data.data.bgImg && JSON.parse(data.data.bgImg).length>0){
							$('#mypic1').attr('src',JSON.parse(data.data.bgImg)[0].picImg)
						}

						if(data.data.userExplain && data.data.userExplain!='null'){
							$('#explain').val(data.data.userExplain)
						}
						if(data.data.age){
							$('#age').val(data.data.age)
						}

						if(data.data.horoscope && data.data.horoscope!='null'){
							$('#horoscope').val(data.data.horoscope)
						}
//						显示昵称
						if(data.data.username && data.data.username != ' '){
								$('#nkname').val(data.data.username)
						}
						//显示性别
						switch (data.data.gender){//Nextbtn
							case '1':
							mui('#Nextbtn')[0].getElementsByTagName('option')[1].selected = true;
							break;
							case '2':
							mui('#Nextbtn')[0].getElementsByTagName('option')[2].selected = true;
							break;
							case '4'|| null:
							mui('#Nextbtn')[0].getElementsByTagName('option')[0].selected = true;
							break;
						}

					}else{
						console.log(data.errmsg);
					}
				},
				error:function(xhr,type,errorThrown){
					console.log('获取用户数据,响应失败');
				}
			});
			//获取标签
			mui.ajax(serverUrl+'/api/friends/lable',{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":cityNum},
				success:function(data,type,xhr){
					console.log('获取系统总标签',data);
					if(data.errno == 0){
						var dataObj=data.data;
						if(dataObj && dataObj.length){
							[].forEach.call(dataObj,function(ele){
								if(ele.lableName && ele.lableName != 'null'){
									$('#psLabel').append('<div data-id="'+ele.id+'" class="diybut">'+ele.lableName+'</div> ')
								}
							})

							mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
								type:'get',
								timeout:8000,
								headers:{"token":oldToken,"city":cityNum},
								success:function(data,type,xhr){
									console.log('获取用户标签',data);
									if(data.errno == 0){
										var dataObj=data.data;
										if(dataObj && dataObj.length){
											[].forEach.call(dataObj,function(ele){
												[].forEach.call($('.diybut'),function(ele2,index){
													if(ele2.innerText==ele.lableName){
														$('.diybut').eq(index).addClass('diybuted');
													}
												})
											})
										}

									}else{
										console.log(data.errmsg);
									}
								},
								error:function(xhr,type,errorThrown){
									console.log('获取用户数据,响应失败');
								}
							});

						}

					}else{
						console.log(data.errmsg);
					}

		            $('.diybut').click(function(){
		                if($('.diybuted').length>5){
		                    if($(this).hasClass('diybuted')){
		                        var spanId = $(this).attr("data-id");
		                        //删除标签
		                        var curSp = $(this);
		                        mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
									data:{lableID:spanId},
									type:'delete',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},
									success:function(data,type,xhr){

										console.log('删除标签',data);
										if(data.errno == 0){
		                        			curSp.removeClass('diybuted');
		                        			mui.toast('操作成功');
										}else{
											//mui.toast('获取用户信息失败');
											console.log(data.errmsg);
											mui.toast('操作失败');
										}

									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
										mui.toast('操作失败');
									}
								});

		                    }else{
		                        alert('最多只能选6个标签');
		                    }
		                    return;
		                }else{
		                    var spanId = $(this).attr("data-id");
		                    if($(this).hasClass('diybuted')){
		                    	var curSp = $(this);

		                        //删除标签
		                        mui.ajax(serverUrl+'/api/friends/userlable',{
									data:{lableID:spanId,userId:myuserid},
									type:'DELETE',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},
									success:function(data,type,xhr){
										console.log('获取用户数据返回',data);
										if(data.errno == 0){
		                       			 	curSp.removeClass('diybuted');
		                       			 	mui.toast('操作成功');
										}else{
											//mui.toast('获取用户信息失败');
											console.log(data.errmsg);
											mui.toast('操作失败');
										}

									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
										mui.toast('操作失败');
									}
								});

		                    }else{
		                    	var curSp = $(this);
		                    	//新增标签
		                        mui.ajax(serverUrl+'/api/friends/userlable/userId/'+myuserid,{
									data:{lableID:spanId,userId:myuserid},
									type:'POST',
									timeout:8000,
									headers:{"token":oldToken,"city":cityNum},
									success:function(data,type,xhr){
										console.log('获取用户数据返回',data);
										if(data.errno == 0){
											curSp.addClass('diybuted');
											mui.toast('操作成功');
										}else{
											//mui.toast('获取用户信息失败');
											console.log(data.errmsg);
											mui.toast('操作失败');
										}

									},
									error:function(xhr,type,errorThrown){
										console.log('获取用户数据,响应失败');
										mui.toast('操作失败');
									}
								});

		                    }
		                }
		            })


//					$('.diybut').click(function(){
//						if($('.diybuted').length>6){
//							mui.toast('最多只能添加6个标签哦')
//						}else{
//							mui.prompt('','请输入标签名','添加签名',['确认','取消'],function(e) {
//								if(e.index == 0) {
//									if(e.value=='' || e.value==' '){
//										return false;
//									}else{
//										//新增标签
//										mui.ajax(serverUrl+'/api/friends/userlable',{
//											data:{lableName:e.value,userId:myuserid},
//											type:'post',
//											timeout:8000,
//											headers:{"token":oldToken,"city":cityNum},
//											success:function(data,type,xhr){
//												console.log('获取用户数据返回',data);
//												if(data.errno == 0){
//													mui.toast('新增成功');
//													$('#psLabel').append('<div data-lableid="'+data.data.id+'" class="diybuted">'+e.value+'</div> ')
//
//												}else{
//													//mui.toast('获取用户信息失败');
//													console.log(data.errmsg);
//												}
//												$('#goLabel').click(function(){
//													openview({
//														view:'friendSet.html',
//														id:'friendSet'
//													})
//												})
//
//											},
//											error:function(xhr,type,errorThrown){
//												console.log('获取用户数据,响应失败');
//											}
//										});
//									}
//								}
//							},'div')
//						}
//					})


				},
				error:function(xhr,type,errorThrown){
					console.log('获取用户数据,响应失败');
				}
			});

			//修改

		})//显示既有信息 和 标签修改 上传 结束

//		var Apic ='';
//		function galleryImgsSelected(){//从相册中选择图片
//		    plus.gallery.pick( function(e){
//
//		    	for(var i in e.files){
//		    		if(0!=e.files[i].indexOf("file://")){
//						e.files[i]="file://"+e.files[i];
//					}
//		    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';
//		    		var endpic = e.files[i].split('.')[0]+"/"+nowpic;
//		    		plus.zip.compressImage({//压缩操作
//						src:e.files[i],
//						dst:endpic,
//						overwrite:true,
//						quality:30
//					},
//					function(obj) {
//						if(!obj.target.indexOf("file://")>-1){obj.target="file://"+obj.target;}
//						Apic = obj.target;
//						mui('#mypic1')[0].src = obj.target;
//					},function(error) {
//						mui.toast('图片获取错误，请重试');
//				});
//		    	}
//		    }, function ( e ) {
//		    },{filter:"image",multiple:true,maximum:1,system:false,onmaxed:function(){
//				plus.nativeUI.alert('只能选择1张图片');
//		    }});
//		}

		/*选择图片*/
		var Apic = [];//图片存放数组
		var lfs=null;// 保留上次选择图片列表
		var time1 = null;
		function galleryImgsSelected(){//从相册中选择图片
			mui.plusReady(function(){
			    plus.gallery.pick( function(e){
			    	Apic = [];
			    	lfs=e.files;
			    	clearInterval(time1);
			    	var indexNum = 0;
			    	var indexMax = e.files.length - 1;
			    	e.files.forEach(function(){
			    		mui('#mypic1')[0].src  = '../../img/Spinner.svg';
			    	})
			    	time1 = setInterval(function(){
			    		console.log(time1);
			    		if(0!=e.files[indexNum].indexOf("file://")){
							e.files[indexNum]="file://"+e.files[indexNum];//图片地址
						}
			    		if(indexNum == indexMax){//全部压缩完毕
			    			clearInterval(time1);
							time1 = null;
			    		}
			    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';//随机字符串
			    		var endpic = e.files[indexNum].split('.')[0]+"/" +nowpic;
			    		//压缩方法
		    			plus.zip.compressImage({
							src:e.files[indexNum],
							dst:endpic,
							overwrite:true,
							quality:30
						},
						function(obj) {
							console.log(obj)
							Apic.push(endpic);
							showImg(endpic,indexNum);
						},function(error) {
							mui.toast('图片获取错误，请重试');
						});
			    		indexNum ++;

			    	},800)
			    }, function ( e ) {
			    },{filter:"image",multiple:true,maximum:1,selected:lfs,system:false,onmaxed:function(){//保存选择记录
			    }});
				function showImg(url,indexNum){//显示图片
					if(0!=url.indexOf("file://")){
						url="file://"+url;
					}
					mui('#mypic1')[0].src  = url;
				}
			})
		}
		//从相册中选择图片结束

		//上传数据(不含标签)
		mui('#Preservation')[0].addEventListener('tap',function(){
			plus.nativeUI.showWaiting('保存中 ...',{width:'100px',height:'80px'});
			var explain = mui('#explain')[0].value || '';
			var horoscope = mui('#horoscope')[0].value || '';
			var age = $('#age').val() || '';
			var Nextbtnval = document.getElementById("Nextbtn").options[window.document.getElementById("Nextbtn").selectedIndex].text;
			var username = $('#nkname').val();

			mui.plusReady(function(){
				var myuserid = plus.storage.getItem('userid');
				var cityNum = plus.storage.getItem('cityNum');
				var oldToken = plus.storage.getItem('oldToken');

				releaseData();
			 	//发送数据
			 	function releaseData(){
					var task = plus.uploader.createUpload(serverUrl+'/api/friends/friendhome',
						{ method:"POST"},
						function(back,status){
							if(status == 200){
								console.log(back.responseText);
								var dataobj = JSON.parse(back.responseText);
								if(dataobj.errno == 0){
									//触发跳转页面刷新
									var parentPage =plus.webview.getWebviewById('mycircleIndex');
										mui.fire(parentPage,'refresh');
									var time2 = setTimeout(function(){
										plus.nativeUI.closeWaiting();//关闭等待框
										plus.webview.currentWebview().close();
										mui.toast('修改成功');
									},500)
	    						}else{
	    							plus.nativeUI.closeWaiting();//关闭等待框
	    							mui.toast('修改失败，请重试！');
	    							plus.nativeUI.closeWaiting();
	    						}
							}else{
								plus.nativeUI.closeWaiting();//关闭等待框
								mui.toast('当前网络不好，请重试！');
							}

						}
					);
					var hanziX = ['男','女','密'];
					var shuziX = [1,2,4];
					task.setRequestHeader('token',oldToken);
					task.setRequestHeader('city',cityNum);

					if(Apic.length){task.addFile(Apic[0], {key:'bgImg'})}
					task.addData('age',age);
			        task.addData('username',username);
			        task.addData('userId',myuserid);
			        task.addData('horoscope',horoscope);
			        task.addData('gender',shuziX[hanziX.indexOf(Nextbtnval[Nextbtnval.length-1])].toString());
			        task.addData('userExplain',explain);

					task.start();

			 	}
			 	//发送数据结束

			})
		})


	</script>


</html>
