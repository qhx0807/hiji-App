<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>交友</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.css" />
		<link rel="stylesheet" type="text/css" href="../../css/config.css" />
		<link rel="stylesheet" type="text/css" href="../../css/makeFhtml.css" />
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/app.js"></script>
		<script src="../../js/artTemplate-native.js"></script>
	</head>
	<style type="text/css">
		.searchIcon {
			width: 18px;
			margin-top: 15px;
			margin-right: 6px;
			margin-left: 15px;
		}

		.mui-bar-nav {
			box-shadow: none !important;
			z-index: 400;
		}

		.QAhead {
			position: fixed;
			background-color: #fff;
			width: 100%;
			z-index: 300;
			box-shadow: 0 0px 2px rgba(175, 166, 166, 0.85);
		}

		.listSon {
			margin-top: 35px;
		}

		.QAhead span {
			margin: 0 3%;
		}

		.circleName {
			font-size: 14px;
			padding: 8px;
			padding-bottom: 0px;
			color: #444;
		}

		.circleName span {
			position: relative;
			top: -2px;
			color: #888;
		}

		.circleName span b {
			font-weight: normal;
			margin-left: 10%;
		}

		.circleImg {
			position: relative;
		}

		.circleImg a {
			position: absolute;
			bottom: 7px;
			right: 12px;
			color: #fff;
			font-size: 14px;
		}

		.circleImg a img {
			width: 16px;
			margin-bottom: -3px;
			margin-right: 2px;
		}

		#upload {
			min-height: 38px;
			padding-top: 0;
		}

		#upload img {
			padding: 0 !important;
			margin: 0;
			width: 32px;
		}
	</style>

	<body style="background-color: white;padding-bottom: 0;">
		<header class="mui-bar mui-bar-nav fineB" id="header">
			<a class="goBack mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
			<h1 class="mui-title">交友</h1>
			<img class="search searchIcon mui-pull-right" src="../../img/answer/search.png" />
			<!--<img src="../../img/makeFriend/userCenter.png" class="mui-pull-right friendCenter" style="width:20px;margin-top: 15px; margin-right: 6px;"/>-->
		</header>
		<script src="../../js/statusBar.js"></script>

		<div id="main">

			<div class="QandA">
				<div class="QAhead">
					<span class="active aClick">推荐</span>
					<span class="aClick">女神</span>
					<span class="aClick">男神</span>
				</div>
				<div id="listOldDiv">
					<div id="listConW1" class="middleI listSon" style="display: block;">
						<!--推荐-->
						<div class="circleContain" id="listData0" style="overflow: hidden;"></div>
					</div>
					<div id="listConW2" class="middleI listSon" style="display: none;">
						<!--女神-->
						<div class="circleContain" id="listData1" style="overflow: hidden;"></div>
					</div>
					<div id="listConW3" class="middleI listSon" style="display: none;">
						<!--男神-->
						<div class="circleContain" id="listData2" style="overflow: hidden;"></div>
					</div>

					<script type="text/html" id="listDataS">
						<%for(var i=0;i<dataList.length;i++){%>
						<div class="circleBox" onclick="openDetail(<%=dataList[i].user_id%>)">
							<!--<div class="circleImg" style="background: url(<%=dataList[i].avatar%>) 0 0 no-repeat;background-size: cover;">-->
							<div class="circleImg">
								<img class="img1 picOp loadPics" onload="imgHeight(this)" data-src="<%=dataList[i].avatar%>" src="" />

							</div>

							<div class="circleName">
								<%=dataList[i].nickname%>
								<a style="float: right;" onclick="zan(this,<%=dataList[i].user_id%>)" >
									<%if(dataList[i].yizan == 1){%>
										<img style="width: 20px;vertical-align:middle;margin-right: 3px;" src="../../img/mainHtml/yizan.png" />
									<%}else{%>
										<img style="width: 20px;vertical-align:middle;margin-right: 3px;" src="../../img/mainHtml/weizan.png" />
									<%}%>
									<span><%=dataList[i].likes%></span>
								</a><br /> <span><%=dataList[i].age%></span> </div>
						</div>
						<%}%>
					</script>
					<div class="upload text-center text-xs gray" id="upload"><img src='../../img/balls.svg' /></div>
				</div>
			</div>
		</div>
		<!--遮罩1-->
		<div id="maskInfo1" class="maskInfo" style="display: none;z-index:9999;">
			<img src="../../img/mainHtml/mclose.svg" class="closeMs" />
			<div class="ruleCt" style="padding-bottom: 50px;padding: 0;">
				<img src="../../img/mainHtml/mask8.png" style="border-radius: 3px;width: 100%;height: 100%;" onclick='goCoupon()' />
			</div>
		</div>
		<!--遮罩2-->

		<div id="maskInfo2" class="maskInfo" style="display: none;z-index:9998;">
			<img src="../../img/chahao.png" class="closeMs" />
			<div class="ruleCt" style="padding-bottom: 50px;">
				<div style="overflow-y: scroll;height: 100%;margin-bottom: 50px;">
					<div class="ft16 fttc" style="text-align: center;">首页弹窗2</div>
					<ol class="ft14 disablecl ruleol">
					</ol>
				</div>
				<button type="button" class="mui-btn mui-btn-danger mar10 closemask">查看</button>

			</div>
		</div>
		<!--遮罩3-->

		<div id="maskInfo3" class="maskInfo" style="display: none;z-index:9997;">
			<img src="../../img/chahao.png" class="closeMs" />
			<div class="ruleCt" style="padding-bottom: 50px;">
				<div style="overflow-y: scroll;height: 100%;margin-bottom: 50px;">
					<div class="ft16 fttc" style="text-align: center;">首页弹窗3</div>
					<ol class="ft14 disablecl ruleol">
					</ol>
				</div>
				<button type="button" class="mui-btn mui-btn-danger mar10 closemask">查看</button>

			</div>
		</div>

		<script type="text/javascript">
			$('.ruleCt').click(function() {
				event.stopPropagation()
			})
			$('#maskInfo1,.closemm').click(function() {
				event.preventDefault()
				$('#maskInfo1').fadeOut(200);
			})
			$('#maskInfo2').click(function() {
				event.preventDefault()
				$('#maskInfo2').fadeOut(200);
			})
			$('#maskInfo3').click(function() {
				event.preventDefault()
				$('#maskInfo3').fadeOut(200);
			})
			$('.closeMs').click(function() {
				event.stopPropagation();
				$(this).parent().fadeOut(200);
			})

			$('.friendCenter').click(function() {
				if(plus.storage.getItem('myToken')) {
					openview({
						view: 'mycircleIndex.html',
						id: 'mycircleIndex',
					})
				} else {
					mui.toast('请登录');
					openview({
						view: '../login.html'
					});
				}

			})

			function goCoupon() { /**/
				event.stopPropagation();

				if(plus.storage.getItem('myToken')) {
					$('#maskInfo1').fadeOut(200);
					openview({
						view: 'friendSet.html',
						id: "friendSet",
					});
				} else {
					mui.toast('请登录');
					openview({
						view: '../login.html'
					});
				}

			}
			mui.plusReady(function() {
				var cityNum = plus.storage.getItem('cityNum'),
					oldToken = plus.storage.getItem('oldToken'),
					myuserid = plus.storage.getItem('userid');
				/*弹框*/
				mui.ajax(serverUrl + '/api/index/showmodal', {
					type: 'post',
					timeout: 10000,
					headers: {
						"token": oldToken,
						'city': cityNum
					},
					success: function(data, type, xhr) {
						plus.nativeUI.closeWaiting();
						console.log('首页弹窗', data)
						if(data.errno == 0) {
							if(data.data.friendIndex && data.data.friendIndex.length) {
								mui.each(data.data.friendIndex, function(index, item) {
									if(item == 1 && plus.storage.getItem('$step') != 7 ) {
										$('#maskInfo' + (index + 1)).show()
									} else {
										$('#maskInfo' + (index + 1)).hide()
									}
								})
							}
						}
					},
					error: function(xhr, type, errorThrown) {
						console.log('首页弹窗', type)
						console.log('响应失败');
						plus.nativeUI.closeWaiting();
					}
				});
				
				//获取已经点赞人数
				mui.ajax(serverUrl + '/api/friends/likesforperson', {
					data:{userId:myuserid,getLikes:1},
					type: 'post',
					timeout: 10000,
					headers: {
						"token": oldToken,
						"city": cityNum
					},
					success: function(data, type, xhr) {
						console.log('点赞列表', data);
						
						if(data.errno == 0) {
							if(data.data.data && data.data.data.length){
								plus.storage.setItem('zanList',JSON.stringify(data.data.data))			
							}else{
								plus.storage.removeItem('zanList')
							}
						console.log('缓存点赞',JSON.parse(plus.storage.getItem('zanList')))
							
						}else{
							mui.toast(data.errmsg)
						}

					},
					error: function(xhr, type, errorThrown) {
						console.error('点赞他人,响应失败');
					}
				});
			})
		</script>
		<script type="text/javascript">
			var flag0 = 0,
				flag1 = 0,
				flag2 = 0; //是否   第一次点击
			var SH0 = 0,
				SH1 = 0,
				SH2 = 0; /*保存的滚动条高度*/
			var listCon = document.getElementsByClassName('QAhead')[0].getElementsByTagName('span'); //按钮
			var listSon = document.getElementsByClassName('listSon'); /*内容盒子*/
			[].forEach.call(listCon, function(ele, index) { /*点击切换tab*/
				ele.onclick = function() { //点击tab切换
					if(!ele.className.indexOf('active') > -1) {
						[].forEach.call(listCon, function(ele2) {
							ele2.className = '';
						})
						ele.className = 'active aClick';

						[].forEach.call(listSon, function(ele3) {
							ele3.style.display = 'none';
						})
						listSon[index].style.display = 'block';

						if(index == 0) { //推荐
							if(flag0 == 0) {
								shopData(index, 0, 1);
							} else {
								$(window).scrollTop(SH0);
							}
						} else if(index == 1) { //女神
							if(flag1 == 0) {
								shopData(index, 0, 0);
							} else {
								$(window).scrollTop(SH1);
							}
						} else if(index == 2) { //男神
							if(flag2 == 0) {
								shopData(index, 0, 0);
							} else {
								$(window).scrollTop(SH2);
							}
						}
					}
				}
			})
			/*铺数据*/
			shopData(0, 0, 1); //默认推荐

			function shopData(typeNum, gender, suggest) {
				var Spagenum = 2; //实到页数
				var Ypagenum = 1; //应到页数
				var currentPage = 1,
					numsPerPage = 6;
				if(typeNum == 0) {
					flag0++;
					var dataJson = {
						'recommend': suggest,
						'numsPerPage': numsPerPage,
						'currentPage': currentPage,
						'orderType': 'ASC',
						'orderField': 'resommendOnHomeIndex'
					}
				} else if(typeNum == 1) {
					flag1++;
					var dataJson = {
						'recommend': suggest,
						'gender': 2,
						'numsPerPage': numsPerPage,
						'currentPage': currentPage,
						'orderType': 'ASC',
						'orderField': 'resommendOnHomeIndex'
					}
				} else if(typeNum == 2) {
					flag2++;
					var dataJson = {
						'recommend': suggest,
						'gender': 1,
						'numsPerPage': numsPerPage,
						'currentPage': currentPage,
						'orderType': 'ASC',
						'orderField': 'resommendOnHomeIndex'
					}
				}
				mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
				mui.plusReady(function() {
					var cityNum = plus.storage.getItem('cityNum'),
						oldToken = plus.storage.getItem('oldToken'),
						myuserid = plus.storage.getItem('userid');
						
					mui.ajax(serverUrl + '/api/friends/friendslist', {
						data: dataJson,
						dataType: 'json',
						type: 'post',
						timeout: 8000,
						headers: {
							"token": oldToken,
							'city': 1
						},
						success: function(data, type, xhr) {
							console.error('交友列表' + typeNum, data);
							if(data.errno == 0) {
								if(!data.data.data.length) {
									mui("#upload")[0].innerHTML = "当前城市没有数据 !";
								} else {
									var dataObj = {};
									var yizan = JSON.parse(plus.storage.getItem('zanList')) || [];
									for(var i = 0; i < data.data.data.length; i++) { //整理头像格式
										if(data.data.data[i].avatar) {
											if(data.data.data[i].avatar.indexOf("[") > -1) {
												if(JSON.parse(data.data.data[i].avatar)[0].picImg.indexOf('http') == -1) {
													data.data.data[i].avatar = serverimgUrl + JSON.parse(data.data.data[i].avatar)[0].picImg;
												} else {
													data.data.data[i].avatar = JSON.parse(data.data.data[i].avatar)[0].picImg;
												}
											} else {
												if(data.data.data[i].avatar.picImg.indexOf('http') == -1) {
													data.data.data[i].avatar = serverimgUrl + data.data.data[i].avatar.picImg;
												} else {
													data.data.data[i].avatar = data.data.data[i].avatar.picImg;
												}
											}
										} else {
											data.data.data[i].avatar = 'https://b-ssl.duitang.com/uploads/item/201501/23/20150123103002_zMeAw.jpeg';
										}
										if(!data.data.data[i].likes || data.data.data[i].likes == 'null') {
											data.data.data[i].likes = 0;
										}
										if(data.data.data[i].username) {
											data.data.data[i].nickname = data.data.data[i].username;
										} else {
											if(data.data.data[i].nickname && data.data.data[i].nickname != 'null') {
												if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data.data[i].nickname)) {
													data.data.data[i].nickname = data.data.data[i].nickname.substring(0, 3) + "****" + data.data.data[i].nickname.substring(7, 11)
												}
											} else {
												data.data.data[i].nickname = '匿名'
											}
										}

										if(!data.data.data[i].age || data.data.data[i].age == 'null' || data.data.data[i].age == ' ') {
											data.data.data[i].age = '年龄保密'
										} else {
											data.data.data[i].age = data.data.data[i].age + '岁'
										}
										for(var j = 0 ;j < yizan.length;j++){
											if(yizan[j].toUserId == data.data.data[i].user_id){
												data.data.data[i].yizan=1;
											}
										}
									}
									dataObj.dataList = data.data.data;
									document.getElementsByClassName("circleContain")[typeNum].innerHTML = template("listDataS", dataObj);
									mui("#upload")[0].innerHTML = "";
									lazyLoad(true, 50); //懒加载

									$(window).scroll(function() {
										if(document.getElementsByClassName("listSon")[typeNum].style.display == 'block') { //判断是否是 当前显示的盒子
											var scrollTop = $(this).scrollTop();
											if(typeNum == 0) {
												SH0 = $(this).scrollTop();
											} else if(typeNum == 1) {
												SH1 = $(this).scrollTop();
											} else if(typeNum == 2) {
												SH2 = $(this).scrollTop();
											}
											var scrollHeight = $(document).height();
											var windowHeight = $(this).height();
											if(scrollTop + windowHeight == scrollHeight) {
												if(Spagenum <= data.data.totalPages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页

													mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
													Ypagenum++; //满足加载情况,应到页数+1
													console.log('发起请求,实到' + Spagenum + '页');
													console.log('发起请求,应到' + Ypagenum + '页');
													if(typeNum == 0) {
														flag0++;
														var dataJson = {
															'recommend': suggest,
															'numsPerPage': numsPerPage,
															'currentPage': Spagenum,
															'orderType': 'ASC',
															'orderField': 'resommendOnHomeIndex'
														}
													} else if(typeNum == 1) {
														flag1++;
														var dataJson = {
															'recommend': suggest,
															'gender': 2,
															'numsPerPage': numsPerPage,
															'currentPage': Spagenum,
															'orderType': 'ASC',
															'orderField': 'resommendOnHomeIndex'
														}
													} else if(typeNum == 2) {
														flag2++;
														var dataJson = {
															'recommend': suggest,
															'gender': 1,
															'numsPerPage': numsPerPage,
															'currentPage': Spagenum,
															'orderType': 'ASC',
															'orderField': 'resommendOnHomeIndex'
														}
													}
													mui.ajax(serverUrl + '/api/friends/friendslist', {
														data: dataJson,
														dataType: 'json',
														type: 'post',
														timeout: 8000,
														headers: {
															"token": oldToken,
															'city': 1
														},
														success: function(data) {
															console.error('交友列表续' + typeNum, data);
															if(data.errno == 0) {
																var dataObj = {};
																var yizan = JSON.parse(plus.storage.getItem('zanList')) || [];
																
																for(var i = 0; i < data.data.data.length; i++) {
																	if(data.data.data[i].avatar) {
																		if(data.data.data[i].avatar.indexOf("[") > -1) {
																			if(JSON.parse(data.data.data[i].avatar)[0].picImg.indexOf('http') == -1) {
																				data.data.data[i].avatar = serverimgUrl + JSON.parse(data.data.data[i].avatar)[0].picImg;
																			} else {
																				data.data.data[i].avatar = JSON.parse(data.data.data[i].avatar)[0].picImg;
																			}
																		} else {
																			if(data.data.data[i].avatar.picImg.indexOf('http') == -1) {
																				data.data.data[i].avatar = serverimgUrl + data.data.data[i].avatar.picImg;
																			} else {
																				data.data.data[i].avatar = data.data.data[i].avatar.picImg;
																			}
																		}
																	} else {

																		data.data.data[i].avatar = 'https://b-ssl.duitang.com/uploads/item/201501/23/20150123103002_zMeAw.jpeg';
																	}
																	if(!data.data.data[i].likes || data.data.data[i].likes == 'null') {
																		data.data.data[i].likes = 0;
																	}
																	if(data.data.data[i].username) {
																		data.data.data[i].nickname = data.data.data[i].username;
																	} else {
																		if(data.data.data[i].nickname && data.data.data[i].nickname != 'null') {
																			if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(data.data.data[i].nickname)) {
																				data.data.data[i].nickname = data.data.data[i].nickname.substring(0, 3) + "****" + data.data.data[i].nickname.substring(7, 11)
																			}
																		} else {
																			data.data.data[i].nickname = '匿名'
																		}
																	}
																	if(!data.data.data[i].age || data.data.data[i].age == 'null' || data.data.data[i].age == ' ') {
																		data.data.data[i].age = '年龄保密'
																	} else {
																		data.data.data[i].age = data.data.data[i].age + '岁'
																	}
																	for(var j = 0 ;j < yizan.length;j++){
																		if(yizan[j].toUserId == data.data.data[i].user_id){
																			data.data.data[i].yizan=1;
																		}
																	}
																}
																dataObj.dataList = data.data.data;
																document.getElementsByClassName("circleContain")[typeNum].innerHTML += template("listDataS", dataObj);
																lazyLoad(false, 50); //懒加载
															}
															mui("#upload")[0].innerHTML = " ";
															Spagenum++; //加载成功,当前页+1
															console.log('成功+1,实到' + Spagenum);
															console.log('成功+1,应到' + Spagenum);
														},
														error: function(xhr, type, errorThrown) {
															Ypagenum--; //失败是应到-1
															mui.toast("当前网络不好请重试");
															mui("#upload")[0].innerHTML = "";
														}
													});
												} else if(Spagenum == data.data.totalPages + 1) { //当前页不小于等于总页数时请求下一页
													mui("#upload")[0].innerHTML = "到底了";
												}
											}
										}
									});

								}
							} else {
								mui.toast('当前网络不好,请重试');
							}
						},
						error: function(xhr, type, errorThrown) {
							console.error('交友列表,响应失败');
							mui.toast('当前网络不好,请重试');
						}
					});

					//判断是否上传交友照片
					mui.ajax(serverUrl + '/api/friends/photography/userId/' + myuserid + '/currentPage/1/numsPerPage/4', {
						type: 'get',
						timeout: 8000,
						headers: {
							"token": oldToken,
							"city": cityNum
						},
						success: function(data, type, xhr) {
							console.log('交友照片', data);
							if(data.errno == 0) {
								if(data.data.data && data.data.data.length > 0) {
									$('#maskTc').css('display', 'none')
								} else {
									$('#maskTc').css('display', 'block')
								}
							}
						},
						error: function(xhr, type, errorThrown) {
							console.error('获取交友照片,响应失败');
						}
					});
				})
			}

			//搜索
			$('.search').click(function() {
				openview({
					view: 'searchHuman.html'
				})
			})

			//打开他人主页
			function openDetail(id) {
				mui.plusReady(function() {
					var myuserid = plus.storage.getItem('userid');
					if(plus.storage.getItem('myToken')) {
						if(myuserid == id) {
							openview({
								view: "mycircleIndex.html",
								create: true,
								id: 'mycircleIndex',
								extrasobj: {
									userId: id
								}
							})
						} else {
							openview({
								view: "elsecircleIndex.html",
								id: 'elsecircleIndex',
								extrasobj: {
									userId: id
								}
							})
						}

					} else {
						mui.toast('请登录');
						openview({
							view: '../login.html'
						});
					}
				})
			}
			//点赞
			function zan(obj,userId){
				event.stopPropagation();
				var cur = $(obj);
				mui.plusReady(function() {
					var myuserid = plus.storage.getItem('userid'),
					    cityNum = plus.storage.getItem('cityNum'),
						oldToken = plus.storage.getItem('oldToken');
					if(plus.storage.getItem('myToken')) {
						mui.ajax(serverUrl + '/api/friends/likesforperson', {
							data:{userId:myuserid,toUserId:userId},
							type: 'post',
							timeout: 10000,
							headers: {
								"token": oldToken,
								"city": cityNum
							},
							success: function(data, type, xhr) {
								console.log('点赞他人', data);
								if(data.errno == 0) {
									var haszan = parseInt(cur.find('span').html())+1;
									cur.find('span').html(haszan)
									cur.find('img').attr('src','../../img/mainHtml/yizan.png')
									 mui.toast(data.data.errmsg)
								}else{
									mui.toast(data.errmsg)
								}
							},
							error: function(xhr, type, errorThrown) {
								console.error('点赞他人,响应失败');
							}
						});
					} else {
						mui.toast('请登录');
						openview({
							view: '../login.html'
						});
					}
				})
			}
		</script>
		<script type="text/javascript">
			//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
			//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
			mui.plusReady(function() {
				var startTime, endTime, stayTime, flagback = 0;
				startTime = new Date().getTime();
				var old_back = mui.back;
				//改写返回键返回的函数，返回时传页面停留时间
				mui.back = function() {
					endTime = new Date().getTime(); //返回时间
					stayTime = Math.ceil((endTime - startTime) / 1000);
					console.log('购物中心' + stayTime);
					plus.statistic.eventDuration("HIfeiendMake", stayTime);
					//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
					old_back();
				}
				plus.webview.currentWebview().addEventListener("popGesture", function() {
					flagback++;
					if(flagback == 1) {
						endTime = new Date().getTime();
						stayTime = Math.ceil((endTime - startTime) / 1000);
						plus.statistic.eventDuration("HIfeiendMake", stayTime);
						//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
					}
				}, false);
			});
		</script>
	</body>

</html>