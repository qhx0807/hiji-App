<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>编辑资料</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<style type="text/css">
			#userMessContainer{margin-top: 50px;
			}
			i{ont-style: normal;
			}
			i.container{position: relative;
			}
			i.imgContainer .upload{position: absolute;
				top:0;left:0;bottom:0;right:0;
				z-index:999;
			}
			#main{margin-bottom: 100px;
			}
			select{display: inline-block !important;
				float:right !important;
				font-size: 14px !important;
				margin-top:10px;
			}
			input{border:none !important;
			}
			.box-s{padding-left:5%;
			}
			.muibackdrop{width:80%;
				height:100px;
				padding:15px 50px;
				line-height: 30px;
				position: absolute;
				top:20%;
				left:10%;
				border:1px solid #F53C42;
				background: #ffffff;
			}
			.saveMessage{color:#FFFFFF;
				margin-right: 20px;
				line-height: 50px;
				font-size: 14px;
			}
			.muibackdrop{display: none;
			}
			.selectbtn{float: right !important;
				width: 17%;
				margin: 0;
			}
			.data ul li .shuru{margin-bottom: 0;
			}
			.data ul li img {height: 50px;
			    width: 50px;
			    border-radius: 50%;
			}
			.wx_type_img{position: relative;
			}
			.wx_type_img input#imgUpload{margin: 0;cursor: pointer;position: absolute;top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				opacity: 0;
				filter: alpha(opacity=0);
			}
			#imgUpload{display: none;
			}
			.plist ul li{
				border-bottom: none;
			}
			 .plist ul li:first-child a:after{
			 	height: 0;
			 	}
			.plist ul li a:after{
				content: '';
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(.5);
			}
			.renting-footer{height: 50px;}
			.data ul li .shuru{
				line-height: 14px;
			}
			.data ul li .shuru::placeholder{
				padding-top:4px;
			}
			.mui-bar-nav{box-shadow: none !important;}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav fineB">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">编辑资料</h1>
		    <a href="javascript:;" style="line-height: 50px;color:white;" class="fr baocun" id="Preservation">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
	    	<div class="plist clearfloat data" id="userMessContainer">
				<ul>
					<li class="clearfloat touxiang">
						<a>
							<p class="fl">头像</p>
							<label>
								<span class="fr">
									<div class="text-center gray" id="preview"><img id="imghead" onclick="galleryImgsSelected()" src="../../img/answer/editset.png" width="50" height="50"></div>
								</span>
							</label>
						</a>
					</li>
					<!--<li class="clearfloat touxiang aClick">
						<p class="fl">头像</p>
						<div class="text-center gray fr" id="preview"><img id="imghead" src="http://hiji.hifete.com:6789/Upload/useraccount/avatar/With-Continental-Comedy-Charlie-Chaplin-Head-portrait-design-Linen-cotton-pillow-decoration-hotels-Clubhouse-office-sofa.jpg_640x640.jpg" width="50" height="50"></div>
					</li>-->
					<li class="clearfloat">
						<a href="#">
							<p class="fl">昵称</p>
							<input type="text" class="fr shuru" name="" id="mynickname" placeholder="点击编辑" />
						</a>
					</li>

					<li class="clearfloat">
						<a href="#">
							<p class="fl">性别</p>
			    			<select class="mui-btn mui-btn-block selectbtn" id="Nextbtn" dir="rtl">
								<option value="item-1">保密</option>
								<option value="item-2">男</option>
								<option value="item-2">女</option>
							</select>
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">身份证号码</p>
							<input type="text" class="fr shuru" name="" id="IDcard" placeholder="点击编辑" />
						</a>
					</li>
				</ul>
			</div>
	    </div>
	    <div style="margin-top: -90px;text-indent: 20px;">
	    	<p style="font-size: 12px;">注: 在跨境优品中购买商品必需填写身份证号。</p>
	    </div>
		<div class="muibackdrop">
			<div class="mui-input-row">
				<h5>请选择性别</h5>
				<select name="genderChoose" class="mui-pull-right mui-input">
					<option value="男">男</option>
					<option value="女">女</option>
				</select>
			</div>
		</div>
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<!--<script src="../../js/jquery.min.js"></script>-->
	<script type="text/javascript">
		var idnum = 0;
		mui.plusReady(function(){

			var myuserid = plus.storage.getItem('userid');
			var oldtoken = plus.storage.getItem('oldToken');
			//显示既有信息
			mui.ajax(serverUrl+'/api/useraccount/userinfo',{
				data:{"userid":myuserid},
				type:'post',
				timeout:10000,
				headers:{"token":oldtoken},
				success:function(data){
					console.log('获取用户数据返回',data);
					if(data.errno == 0){
						if(data.data[0].avatar && data.data[0].avatar.indexOf('http')>-1){ //显示头像
							if(JSON.parse(data.data[0].avatar)[0].picImg.indexOf('http')>-1){
								var imgurl = JSON.parse(data.data[0].avatar)[0].picImg;
							}else{
								var imgurl = serverimgUrl + JSON.parse(data.data[0].avatar)[0].picImg;
							}
							mui('#imghead')[0].src = imgurl;
						}
						//显示昵称
						if(data.data[0].nickname){
							if(data.data[0].nickname.indexOf('null') == -1){
								mui('#mynickname')[0].value =data.data[0].nickname;
							}
						}
						//显示ID
						if(data.data[0].id_card && data.data[0].id_card!=' '){
							idnum = data.data[0].id_card;
							mui('#IDcard')[0].value = data.data[0].id_card.substr(0, 1) +'****************'+ data.data[0].id_card.substr(-1);
						}
						//显示性别
						switch (data.data[0].gender){//Nextbtn
							case '1':
							mui('#Nextbtn')[0].getElementsByTagName('option')[1].selected = true;
							break;
							case '2':
							mui('#Nextbtn')[0].getElementsByTagName('option')[2].selected = true;
							break;
							case '4'|| null:
							mui('#Nextbtn')[0].getElementsByTagName('option')[0].selected = true;
							break;
						}
					}else{
						mui.toast('获取信息失败');
						console.log(data.errmsg);
					}
					plus.nativeUI.closeWaiting();
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui.toast('响应失败 ');
				}
			});
		})

		/*选择图片*/
		var Apic = [];//图片存放数组
		var lfs=null;// 保留上次选择图片列表
		var time1 = null;
		function galleryImgsSelected(){//从相册中选择图片
			mui.plusReady(function(){
			    plus.gallery.pick( function(e){
			    	Apic = [];
			    	lfs=e.files;
			    	clearInterval(time1);
			    	var indexNum = 0;
			    	var indexMax = e.files.length - 1;
			    	e.files.forEach(function(){
			    		mui('#imghead')[0].src  = '../../img/Spinner.svg';
			    	})
			    	time1 = setInterval(function(){
			    		console.log(time1);
			    		if(0!=e.files[indexNum].indexOf("file://")){
							e.files[indexNum]="file://"+e.files[indexNum];//图片地址
						}
			    		if(indexNum == indexMax){//全部压缩完毕
			    			clearInterval(time1);
							time1 = null;
			    		}
			    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';//随机字符串
			    		var endpic = e.files[indexNum].split('.')[0]+"/" +nowpic;
			    		//压缩方法
		    			plus.zip.compressImage({
							src:e.files[indexNum],
							dst:endpic,
							overwrite:true,
							quality:30
						},
						function(obj) {
							console.log(obj)
							Apic.push(endpic);
							showImg(endpic,indexNum);
						},function(error) {
							mui.toast('图片获取错误，请重试');
						});
			    		indexNum ++;

			    	},800)
			    }, function ( e ) {
			    },{filter:"image",multiple:true,maximum:1,selected:lfs,system:false,onmaxed:function(){//保存选择记录
			    }});
				function showImg(url,indexNum){//显示图片
					if(0!=url.indexOf("file://")){
						url="file://"+url;
					}
					mui('#imghead')[0].src  = url;

				}
			})
		}
		//从相册中选择图片结束


		//保存数据
		mui('#Preservation')[0].addEventListener('tap',function(){
			plus.nativeUI.showWaiting('保存中 ...',{width:'100px',height:'80px'});
			var mynickname = mui('#mynickname')[0].value || null;
			var Nextbtnval = document.getElementById("Nextbtn").options[window.document.getElementById("Nextbtn").selectedIndex].text;

			mui.plusReady(function(){
				var myuserid = plus.storage.getItem('userid');
				var oldtoken = plus.storage.getItem('oldToken');
				var cityNum = plus.storage.getItem('cityNum');
				if(mui('#IDcard')[0].value.indexOf('****')>-1){
					var IDnum = idnum;
				}else{
					var IDnum = mui('#IDcard')[0].value;
				}

				var reg_ID = /^[1-9]\d{7}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}$|^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/;
				if(IDnum == ''){
					releaseData();
				}else{
					if(reg_ID.test(IDnum)){
						releaseData();
					}else{
						plus.nativeUI.closeWaiting();//关闭等待框
						mui.toast('请输入合法证件号');
					}
				}

				//发送数据
			 	function releaseData(){
					var task = plus.uploader.createUpload(serverUrl+'/api/useraccount/updateuserdata',
						{ method:"POST"},
						function(back,status){
							if(status == 200){
								console.log(back.responseText);
								var dataobj = JSON.parse(back.responseText);
								if(dataobj.errno == 0){
									mui.toast('修改成功');
	    							//触发跳转页面刷新
									mui.fire(plus.webview.getWebviewById('center.html'),'refresh');
									if(plus.webview.getWebviewById('market-order')){
										mui.fire(plus.webview.getWebviewById('market-order'),'refresh2');
									}
									if(plus.webview.getWebviewById('center')){
										mui.fire(plus.webview.getWebviewById('center'),'refresh2');
									}
									var time2 = setTimeout(function(){
										plus.webview.currentWebview().close();
									},500)
	    						}else{
	    							plus.nativeUI.closeWaiting();//关闭等待框
	    							mui.toast('发布失败，请重试！');
	    							plus.nativeUI.closeWaiting();
	    						}
							}else{
								plus.nativeUI.closeWaiting();//关闭等待框
								mui.toast('当前网络不好，请重试！');
							}

						}
					);
					var hanziX = ['男','女','密'];
					var shuziX = [1,2,4];
					task.setRequestHeader('token',oldtoken);
					task.setRequestHeader('city',cityNum);

					if(Apic.length){task.addFile(Apic[0], {key:'avatar'})}

					task.addData('userid',myuserid);
			        task.addData('nickname',mynickname);
			        task.addData('gender',shuziX[hanziX.indexOf(Nextbtnval[Nextbtnval.length-1])].toString());
			        task.addData('IDCard',IDnum);

					task.start();

			 	}
			 	//发送数据结束

			})
		})
		//新的图片上传方法




	</script>


</html>
