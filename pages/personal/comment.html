<!doctype html>
<html lang="en" class="feedback">

	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>评价晒单</title>
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/feedback.css" />
	</head>
	<style type="text/css">
		.mui-icon-star {
			font-size: 26px;
			color: #f53c42!important;
		}
		
		.mui-icon-star-filled {
			font-size: 26px;
			color: #f53c42 !important;
		}
		
		.mui-bar>h1,
		a {
			color: whtie!important;
		}
		
		.mui-bar .mui-btn-link {
			color: white;
			background-color: none!important;
		}
		
		.mui-title,
		.mui-icon {
			line-height: 50px!important;
		}
		
		.vm {
			margin-top: 1.5rem;
		}
		
		.vm img {
			margin-right: 0.5rem;
		}
		
		.vm>* {
			vertical-align: middle;
			display: inline;
		}
		
		.uppics {
			border-bottom: none;
		}
		
		.mui-bar .mui-title {
			font-size: 15px;
		}
		
		#submit {
			font-size: 15px;
		}
		/*图片上传*/
		
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		.clearfix:after {
			content: "";
			display: block;
			clear: both;
		}
		
		.uppics {
			text-align: center;
			overflow-y: hidden;
			background-color: #fff;
			;
		}
		
		.uppics div.onepic {
			height: 120px;
			padding: 0 !important;
			padding-top: 31px !important;
			font-size: 14px;
		}
		
		.uppics div.onepic img {
			width: 50px;
		}
		
		.uppics div.onepic input {
			width: 0px;
			height: 0px;
			position: relative;
			top: 15px;
			left: 28px;
			outline: none;
		}
		
		#uppics2 {
			text-align: left;
			white-space: nowrap;
			overflow-x: scroll;
		}
		
		#uppics2 div {
			display: inline-block;
			width: 120px;
			height: 120px;
			vertical-align: middle;
			position: relative;
			text-align: center;
			padding: 10px;
			background-color: #eee;
			margin-right: 6px;
		}
		
		#uppics2 .onepic {
			width: 120px;
			background-color: #eee;
		}
		
		#uppics2 .picimg {
			width: 100%;
		}
		
		.picimg1 {
			width: 25px;
			position: absolute;
			right: 0px;
			top: 2px;
		}
		
		.timeinput {}
		
		.timeinputdiv {
			width: 50%;
			float: left;
		}
		
		.data ul li span {
			color: #555;
		}
		/*图片上传*/
		
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		.clearfix:after {
			content: "";
			display: block;
			clear: both;
		}
		
		.uppics {
			text-align: center;
			overflow-y: hidden;
			background-color: #fff;
			;
		}
		
		.uppics div.onepic {
			height: 120px;
			padding: 0 !important;
			padding-top: 31px !important;
			font-size: 14px;
		}
		
		.uppics div.onepic img {
			width: 50px;
		}
		
		.uppics div.onepic input {
			width: 0px;
			height: 0px;
			position: relative;
			top: -10px;
			left: 28px;
			outline: none;
		}
		
		#uppics2 {
			text-align: left;
			white-space: nowrap;
			overflow-x: scroll;
		}
		
		#uppics2 div {
			display: inline-block;
			width: 120px;
			height: 120px;
			vertical-align: middle;
			position: relative;
			text-align: center;
			padding: 10px;
			background-color: #eee;
			margin-right: 6px;
		}
		
		#uppics2 .onepic {
			width: 120px;
			background-color: #eee;
		}
		
		#uppics2 .picimg {
			width: 100%;
		}
		
		.picimg1 {
			width: 25px;
			position: absolute;
			right: 0px;
			top: 2px;
		}
		
		.timeinput {}
		
		.timeinputdiv {
			width: 50%;
			float: left;
		}
		
		.data ul li span {
			color: #555;
		}
		/*免责申明同意*/
		
		.disclaimer {
			line-height: 50px;
			padding-left: 5%;
			margin-top: 10px;
		}
		
		.disclaimer p {
			color: #f53c42;
			font-size: 14px;
			text-align: center;
			width: 100%;
		}
		
		.gray {
			color: #999 !important;
		}
		
		.timeinput {}
		
		.timeinputdiv {
			width: 50%;
			float: left;
		}
		
		.data ul li span {
			color: #555;
		}
		/*.data ul li p{display: none;}.data ul li .shuru{width: 100%;}.plist ul li{border: none;}
		    .afterI:after{content: '';display: block;height: 1px;background-color: rgba(0,0,0,0.1);-webkit-transform: scaleY(.5);}
		    .afterI2:before{content: '';display: block;height: 1px;background-color: rgba(0,0,0,0.1);-webkit-transform: scaleY(.5);position: relative;top: 50px;}
		    .ui-alert{width: 100% !important;height: 50px;}*/
		
		.hasManyCitytwo .baocun {
			font-size: 15px;
			margin: 0;
		}
		
		.hasManyCitytwo .header-tit {
			font-size: 15px;
			left: 49%;
		}
		
		.mui-bar-nav.mui-bar .mui-icon {
			margin-left: -2px;
		}
		
		.showCityPicker222 {
			width: 37%;
			margin-top: 11px;
			padding: 6px 0;
			border: none;
		}
		
		.shijianp {
			position: relative;
		}
		
		.shijianp:after {
			content: "~";
			position: absolute;
			top: 14px;
			font-size: 25px;
			right: 36%;
			color: #777;
		}
		
		#showCityPicker4 {
			position: absolute;
			right: 10px;
			line-height: 49px;
			border: none;
			padding: 0;
			text-align: right;
			width: 75%;
			background-color: rgba(0, 0, 0, 0);
			color: #000;
		}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: white;"></a>
			<button id="submit" class="mui-btn mui-btn-link mui-pull-right" style="line-height: 50px;color: coral;" onclick="sendCom()">发送</button>
			<h1 class="mui-title" style="color: #666;line-height: 50px;">评价晒单</h1>
		</header>
		<script src="../../js/statusBar.js"></script>
		<!--状态栏-->
		<div class="mui-content">
			<div class="mui-content-padded">
				<div class="vm">
					<img style="width:5rem;vertical-align: middle;" alt="" id="comPic" />
					<span>评分</span>
					<div class="icons mui-inline" style="margin-left: 6px;vertical-align: middle;display: inline;">
						<i data-index="1" class="mui-icon mui-icon-star"></i>
						<i data-index="2" class="mui-icon mui-icon-star"></i>
						<i data-index="3" class="mui-icon mui-icon-star"></i>
						<i data-index="4" class="mui-icon mui-icon-star"></i>
						<i data-index="5" class="mui-icon mui-icon-star"></i>
					</div>
				</div>

			</div>
			<div style="margin: 10px;">
				<div class="row mui-input-row">
					<textarea id='comment' class="mui-input-clear question" placeholder="请文明用语，恶意乱发图文将被删帖并扣除奖励"></textarea>
				</div>

				<div style="display: none;">图片(选填,提供问题截图,总大小10M以下)</div>
				<div id='image-list' class="image-list" style="display: none;"></div>
			</div>
			<!--上传图片-->
			<div class="uppics clearfix" style="margin-top: 50px;">
				<div class="onepic">
					<input type="file" accept="image/png,image/gif,image/jpeg,image/jpg" id="file_input" />
					<img src="../../img/zhaoxiangji.svg">
					<p>添加照片</p>
				</div>
			</div>
			<!--上传图片结束-->
		</div>
		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/feedback.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/app.js" type="text/javascript"></script>
		<script type="text/javascript">
			//选择图片
			var onepic = document.getElementsByClassName('onepic')[0];
			var uppics = document.getElementsByClassName('uppics')[0];
			var p = document.getElementById('p');
			var time1 = null;
			var Apic = []; //存放图片数组
			var Indexes = 0; //当前删除
			onepic.onclick = function() {
				var file_input = document.getElementById('file_input');
				if(Apic.length <= 4) {
					if(Apic.length == 4) {
						file_input.style.display = 'none';
					} else {
						file_input.style.display = 'inline-block';
					}
					uppics.id = 'uppics2';
					var imgnode = document.createElement("div");
					clearInterval(time1);
					time1 = setInterval(function() {
						console.log('加载中');
						if(file_input.files[0]) {
							clearInterval(time1);
							var reader = new FileReader();
							Apic.push(file_input.files[0]);
							var picname = file_input.files[0].name;
							reader.readAsDataURL(file_input.files[0]);
							reader.onload = function(e) {
								imgnode.innerHTML = '<img class="picimg1 ' + picname + '" src="../../img/shanchu.svg"/><img class="picimg" src="' + this.result + '"/>';
								document.getElementsByClassName('picimg1')[Indexes].onclick = function() {
									this.parentNode.parentNode.removeChild(this.parentNode);
									var dename = this.className.slice(8);
									for(var i = 0; i < Apic.length; i++) {
										if(Apic[i].name == dename) {
											Apic.splice(i, 1);
										}
									}
									Indexes--;
								}
								Indexes++;
							}
							uppics.appendChild(imgnode);
							file_input.value = '';
						}
					}, 500)
				} else {
					file_input.style.display = 'none';
					mui.toast('最多选择五张');
				}
			}
			//选择图片结束

			//点击发送
			function sendCom() {
				mui.plusReady(function() {
					var myuserid = plus.storage.getItem('userid');
					var orderId = plus.webview.currentWebview().orderId;
					var oldToken = plus.storage.getItem('oldToken');
					var pageid = plus.webview.currentWebview().pageid;
					var goodsid = plus.webview.currentWebview().goodid;
					var storeid = plus.webview.currentWebview().stroId;
					var seller_comment = $('#comment').val();
					var grade_star = $('.mui-icon-star-filled').length;
					//提交评价

					if(grade_star == 0) {
						mui.toast('还未评分哦~')
					} else if(seller_comment.length <= 5) {
						mui.toast('请输入至少5个字的评价哦~')
					} else {

						//触发跳转页面刷新
						plus.nativeUI.showWaiting('跳转中 ...', {
							width: '100px',
							height: '80px'
						}); //显示等待框
						//发送数据

						var formD = new FormData();
						console.log(Apic);
						for(var j = 0; j < Apic.length; j++) {
						 
							formD.append('pic', Apic[j]);
						}
						
						formD.append('orderid', orderId);
						formD.append('goodsid', goodsid);
						formD.append('stroeid', storeid);
						formD.append('userid', myuserid);
						formD.append('seller_comment', seller_comment);
						//							formD.append('seller_comment',seller_comment);
						formD.append('grade_star', grade_star);
						var xhr = new XMLHttpRequest();
						xhr.open('POST', serverUrl + '/api/mall/comment');
						xhr.onreadystatechange = function() {
							if(xhr.readyState === 4) {
								if(xhr.status === 200) {
									console.log('爱购',xhr.responseText);
									
									var dataobj = JSON.parse(xhr.responseText);
									console.log(dataobj);
									if(dataobj.errno == 0) {
										mui.toast('发布成功');
										plus.nativeUI.closeWaiting();

										mui.fire(plus.webview.getWebviewById('personal/sc-order.html'), 'refreshAd'); //打开指定页面
										mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');
										var time1 = setTimeout(function() {

											mui.fire(plus.webview.getWebviewById(pageid), 'refresh')
											plus.webview.currentWebview().close(); //关闭当前页面

										}, 1000)

									} else {
										mui.toast('发布失败');
									}
								}
							}
						}
						xhr.setRequestHeader("token", oldToken);
						xhr.send(formD);
					}
				})
				//							var goodsid = eval("("+data.data[0].goods_data+")").goodsData[0].goodsId;
				//							var storeid = JSON.stringify(eval("("+data.data[0].goods_data+")")[0].goodsData[0].storeid);

			}
		</script>
	</body>

</html>