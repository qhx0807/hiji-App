<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>编辑拼车</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/reset.css">
		<link href="../../css/mui.picker.min.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
		
		<style type="text/css">
			.data ul li i{
				position: absolute;
				right: 10px;
			}
			.data ul li .shuru{
				margin-bottom: 0;
			}
			.chooseAd{
				text-align: left !important;
			}
			.mui-bar-nav{
				box-shadow: none;
			}
			.mui-bar{
				height: 50px;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			.hasManyCitytwo .baocun{
				font-size: 0.12rem;
				
			}
			.toggle--off{
				background-color: #f53c42 !important;
			}
			
			.mui-btn {
				font-size: 16px;
				padding: 8px;
				margin: 3px;
			}
		 
			.data ul li span{
				line-height: 49px;
			}
			.timetip{
				position: relative;
			}
			.timetip:after{
				position: absolute;
				content: '过期自动下架';
				font-size: 12px;
				left: 100px;
			}
			.ui-alert{
				color: #999;
				padding: 0;
				line-height: 50px;
				text-align: left;
				float: right;
				width: 76%;
				font-size: 16px;
			}
			.data ul li .shuru{
				line-height: 16px;
				text-align: left;
				width: 76%;
				height: 49px;
			}
			.data ul li{
				height: 50px;
			}
			.plist ul li{
				border-bottom: 1px solid #efeff4;
			}
			.address-btn{
				border-top: none;
				border-bottom: none;
				margin-top: 4%;
			}
			.add-address .textare{
				border-bottom: none;color: #666;
			}
			.mobile{
				margin: 50px 0 0 0;
			}
			
			 
			#container{
				margin-bottom: 30px;
			}
			/*图片上传*/
	    	*{margin: 0;padding: 0;box-sizing: border-box;} 
	    	.clearfix:after {content: ""; display: block; clear:both;}
	    	.uppics{overflow-y: hidden;padding: 10px;background: #F3F3F3;}
	    	.uppics div.onepic{height: 120px;padding: 0 !important;padding-top: 31px !important;font-size: 14px;}
		    .uppics div.onepic img{width: 50px;} 
		    .uppics div.onepic input{width: 0px;height: 0px;position: relative;top:15px;left:28px;outline: none;}
		    #uppics2{text-align: left;white-space: nowrap;overflow-x: scroll;}
		    #uppics2 div{display: inline-block;width: 120px;height:120px;vertical-align: middle;position: relative;text-align: center;padding: 10px;
		    background-color: #eee;margin-right: 6px;}
		    #uppics2 .onepic{width: 120px;background-color: #eee;} 
		    #uppics2 .picimg{width: 100%;}
		    .picimg1{width: 25px;position: absolute;right: 0px;top: 2px;}
		    .timeinput{}
		    .timeinputdiv{width: 50%;float: left;}
		    .data ul li span{color: #555;}
		    
		    /*免责申明同意*/
		   	.disclaimer{
				line-height: 50px;
				padding-left: 5%;
				margin-top: 10px;
		   	}
		   	.disclaimer p{
		   		color: #f53c42;
		   		font-size: 14px;
		   		text-align: center;
		   		width: 100%;
		   	}
		   	.gray{
		   		color: #999 !important;
		   	}
		    .timeinput{} 
		    .timeinputdiv{width: 50%;float: left;} 
		    .data ul li span{color: #555;} 
		     
		   
		   .hasManyCitytwo .baocun{font-size: 15px;margin: 0;}
		    .hasManyCitytwo .header-tit{font-size: 15px;left: 49%;}
		    .mui-bar-nav.mui-bar .mui-icon{margin-left: -2px;}
		    .showCityPicker222{width: 37%;margin-top: 11px;padding: 6px 0;border: none;}
		     
		   #showCityPicker4,#showCityPicker3{
				position: absolute;
				right: 10px;
				line-height: 49px;
				border: none;
				padding: 0;
				text-align: right;
				width: 75%;
				background-color: rgba(0,0,0,0);
				color: #000;
			}
		.diyButton2{background:url(../../img/localLife/info.png) no-repeat;background-position:left top;background-size:100% 100%;padding:22px 12px;font-size: 14px;color: #999;}
		.diyButton2 span{color: #5394f2;}
		.baocun img{width: 40%;}
		#Releasebtn{border: none;background-color: #f63d41;color: white;font-size: 16px;padding: 10px 90px;margin: 20px auto 0;display: block;}
    	/*为空时显示 element attribute content*/
		/*#goTime:empty:before{
		    content: attr(placeholder);
		    color:#999;
		}
		#goTime:blur:before{
		    content:none;
		    color:#999;
		}*/
		/*焦点时内容为空*/
		#goTime:focus:before{
		    content:none;
		}
		</style>
	</head>

	<body style="background-color: white;">
		<!--header star-->
	  
		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">编辑拼车</h1>  
		</header>
		
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="uppics clearfix" style="margin-top: 50px;">
	        <div class="diyButton2 activecl goanswer" onclick="disclaimer()">
        		<span>免责申明：</span>本平台只是提供信息发布平台，并不确保信息真实性，由信息发布者之间自行建立拼车关系，平台不对安全、公平、诚信等负责，由拼车人员自行判断。
        	</div>
	   </div> 
		<div id="container" style="margin-top:-40px">
		    <div id="main" class="mui-clearfix add-address">
		    	<div id="thisAddLi"></div>
		    	<div class="plist clearfloat data">
					<ul>
						<li class="clearfloat" id="Bclass2">
							<a href="javascript:;" id="mapAddress">
								<p class="fl">拼车类型</p>
								<button id='showCityPicker4' type='button'><span class="mui-icon mui-icon-arrowdown"></span></button>
								<div id='cityResult4' class="ui-alert">请选择拼车类型</div>
							</a>
						</li> 
					 
						<li class="clearfloat">
							<a class="afterI timetip">
								<p class="fl">出发时间</p>
								<input type="text" class="fr shuru" id="goTime" data-time = '' value="" placeholder="选择出发时间" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI">
								<p class="fl">时间补充</p>
								<input type="text" class="fr shuru" name="" id="Bname" value="2017/09/09" placeholder="选填" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI">
								<p class="fl">电话</p>
								<input type="number" class="fr shuru" name="" id="Bphone" value="" placeholder="请输入电话" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI afterI2">
								<p class="fl">出发地</p>
								<input type="text" class="fr shuru" name="" id="start" value="" placeholder="请输入出发地" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI afterI2">
								<p class="fl">目的地</p>
								<input type="text" class="fr shuru" name="" id="end" value="" placeholder="请输入目的地" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI afterI2">
								<p class="fl">途径</p>
								<input type="text" class="fr shuru" name="" id="zcall" value="" placeholder="途径地点" />
							</a>
						</li>
						<li class="clearfloat">
							<a class="afterI afterI2">
								<p class="fl">人数/座位</p> 
								<button id='showCityPicker3' type='button'><span class="mui-icon mui-icon-arrowdown"></span></button>
								<div id='Result3' class="ui-alert">请选择人数/座位</div>
								<!--<input type="number" class="fr shuru Ynull" name="" id="peoples" value="" min="1" max="10" placeholder="至少1人最多6人" />-->
							</a>
						</li>
						<!--<li class="clearfloat" id="priceC" style="display: none;">
							<a class="afterI afterI2">
								<p class="fl">价格</p>
								<input type="text" onkeyup="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'')}else{this.value=this.value.replace(/\D/g,'')}"  
                                    onafterpaste="if(this.value.length==1){this.value=this.value.replace(/[^1-9]/g,'0')}else{this.value=this.value.replace(/\D/g,'')}" class="fr shuru" name="" id="price" value="" placeholder="一口价" />
							</a>
						</li>-->
						<textarea name="" rows="4" id="Binfo" placeholder="备注" class="textare box-s Ynull"></textarea>
						 
					</ul>
				</div> 
		    </div>
		    <button id="Releasebtn">发布拼车信息</button>
		</div>
<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/mui.min.js"></script>
<script src="../../js/app.js"></script>
<script src="../../js/mui.picker.min.js"></script>
<script src="../../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
<script src="../../js/timedata.js" type="text/javascript" charset="utf-8"></script>
<script>
//点击免责申明
function disclaimer(){
	openview({
		view:'../localLife/disclaimer.html'
	})
}</script>

<script type="text/javascript">

	var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则
	mui.plusReady(function(){ 
		//上传部分
		var oldToken = plus.storage.getItem('oldToken');
		var cityNum = plus.storage.getItem('cityNum');
		var	myuserid = plus.storage.getItem('userid');
		var ctype = plus.webview.currentWebview().ctype;
		var cid = plus.webview.currentWebview().cid;
		mui.ajax(serverUrl+'/api/localservice/transport/type/'+ctype+'/userId/'+myuserid,{
				type:'get',
				timeout:8000,
				headers:{"token":oldToken,"city":cityNum},	              				
				success:function(data,type,xhr){
					console.log('获取数据返回',data);
					plus.nativeUI.closeWaiting();
					if(data.errno == 0){
						if(data.data && data.data.length){
							[].forEach.call(data.data,function(ele,index){
								var gotime = ele.goTime;
								ele.goTime = ele.goTime.replace('T',' ');
								var date = new Date(ele.goTime/1000 *1000);
									Y = date.getFullYear() + '/';
									M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '/';
									D = date.getDate() + ' 下午';
									h = date.getHours()-8;
									if(h<0){
										h = h+12
									}
									h = h + ':';
									m = date.getMinutes();
									s = date.getSeconds(); 
									console.log(Y+M+D+h+m+s); //呀麻碟
									ele.goTime = Y+M+D+h+m;

								var dt2 = new Date(ele.createTime);
								var date2 = [
								  [dt2.getFullYear(), dt2.getMonth() + 1, dt2.getDate()].join('-'),
								  [dt2.getHours(), dt2.getMinutes(), dt2.getSeconds()].join(':')
								].join(' ').replace(/(?=\b\d\b)/g, '0'); // 正则补零
								ele.createTime = date2;
								if(ele.id == cid){
									if(ctype == 2){
										$('#cityResult4').html('车找人')
									}else{
										$('#cityResult4').html('人找车')
									}
									$('#goTime').val(ele.goTime);
									$('#goTime').attr('data-time',gotime);
									if(ele.timeSupplement){
										$('#Bname').val(ele.timeSupplement)
									}
									if(ele.phoneNumber){
										$('#Bphone').val(ele.phoneNumber)
									}
									if(ele.startPlace){
										$('#start').val(ele.startPlace)
										
									}
									if(ele.endPlace){
										$('#end').val(ele.endPlace)
									}
								 
									if(ele.pathLocation){
										$('#zcall').val(ele.pathLocation.slice('-'))
										
									}
									if(ele.persons){
										$('#Result3').html(ele.persons)
									}
									if(ele.other){
										$('#Binfo').val(ele.other)
									}
									
								}
							}) 
						 	
							 
						}
					}else{
						console.log(data.errmsg); 
					}
				},
				error:function(xhr,type,errorThrown){
					console.log('获取数据,响应失败');
				}
			});
		$('#goTime').click(function(){
			var time = $(this).val()
			$(this).attr('type','datetime-local');
//			if($(this).val() == ''){
//				$(this).attr('type','text');
//				$(this).val(time)
//			}
		})
		mui('#Releasebtn')[0].onclick = function(){ 
			if($('#cityResult4').html() == '请选择拼车类型'){
				mui.toast('请选择拼车类型');
			}else if(!$('#goTime').val() || $('#goTime').val() == ' '){ 
				mui.toast('请选择出发时间'); 
			}else if(!reg_phone.test(mui('#Bphone')[0].value)){
				mui.toast('请输入正确的手机号');
				mui('#Bphone')[0].focus();
			}else if(!$('#start').val() || $('#start').val() == ' '){ 
				mui.toast('请输入出发地点'); 
			}else if(!$('#end').val() || $('#end').val() == ' '){ 
				mui.toast('请输入目的地'); 
			}else if(mui('#Result3')[0].innerHTML == "请选择人数/座位"){
				mui.toast('请选择人数/座位');
			}else{
				var typeId,goTime,timeSupplement='',phoneNumber,startPlace,endPlace='',persons,other='',price,pathLocation='';
				if($('#cityResult4').html() == '人找车'){
					typeId = 1;
				}else{
					typeId = 2;
				}  
				if($('#goTime').attr('type') == 'text'){
					goTime = $('#goTime').attr('data-time'); 
				}else{
					var ltime = $('#goTime').val();
					goTime = new Date(ltime).getTime()
				}

//				alert(goTime)
//				alert('shijian '+(new Date(goTime).getTime())/1000);
				timeSupplement = $('#Bname').val();
				phoneNumber = mui('#Bphone')[0].value;
				startPlace = $('#start').val();
				endPlace = $('#end').val();
				persons = mui('#Result3')[0].innerHTML;
				other = $('#Binfo').val();
				pathLocation = $('#zcall').val();
				if(pathLocation && pathLocation!=' '){
					pathLocation = startPlace+'-'+pathLocation+'-'+endPlace;
				}else{
					pathLocation = startPlace+'-'+endPlace;
				}
				if($('#priceC').length>0){
					price = $('#price').val();
				}
				plus.nativeUI.showWaiting();
				mui.ajax(serverUrl+'/api/localservice/transport',{
					data:{
						id:cid,
						type:typeId,
						userId:myuserid,
						goTime:goTime,
						timeSupplement:timeSupplement,
						phoneNumber:phoneNumber,
						startPlace:startPlace,
						endPlace:endPlace,
						pathLocation:pathLocation,
						persons:persons,
						other:other,
						price:0
					},
					type:'PUT',
					timeout:8000,
					headers:{"token":oldToken,"city":cityNum},	              				
					success:function(data,type,xhr){
						console.log('获取数据返回',data);
						plus.nativeUI.closeWaiting();
						if(data.errno == 0){
							plus.nativeUI.closeWaiting();
							mui.toast('发布成功');
							setTimeout(function(){
								var page = plus.webview.getWebviewById('carpool');
								var mpage = plus.webview.getWebviewById('myCarPool');
								mui.fire(page,'refreash');
								mui.fire(mpage,'refreash');
								plus.webview.currentWebview().close();
							},500)
						}else{
							console.error(data.errmsg); 
						}
					},
					error:function(xhr,type,errorThrown){
						console.log('获取数据,响应失败');
					}
				});
			}
			
		}
	})
	 
</script>
<script>
	(function($, doc) {
		$.init();
		$.ready(function() {
			//分类选择
			var userPicker = new $.PopPicker();
			userPicker.setData([{
				text: '车找人'
			}, {
				text: '人找车'
			}]);
			var showUserPickerButton = doc.getElementById('showCityPicker4');
			var userResult = doc.getElementById('cityResult4');
			showUserPickerButton.addEventListener('tap', function(event) {
				userPicker.show(function(items) {
					 
					userResult.innerText = items[0].text;
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
			}, false);
			
			//人数选择
			var userPicker2 = new $.PopPicker();
			userPicker2.setData([{
				text: '1'
			}, {
				text: '2'
			}, {
				text: '3'
			}, {
				text: '4'
			}, {
				text: '5'
			}, {
				text: '6'
			}]);
			var PickerButton = doc.getElementById('showCityPicker3');
			var Result = doc.getElementById('Result3');
			PickerButton.addEventListener('tap', function(event) {
				userPicker2.show(function(items) {
					Result.innerText = items[0].text;
					 
				});
			}, false);
		});
	})(mui, document);
</script>

	</body>

</html>