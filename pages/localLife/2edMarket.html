<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>跳蚤市场</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/common.css">
		<link rel="stylesheet" type="text/css" href="../../css/index.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../css/reset.css">
		<link rel="stylesheet" href="../../css/config.css">
		
		<style type="text/css">
			.dealcard{margin: 0 !important;}
			.dealcard .dealcard-img img{
				height: 70px;
				overflow: hidden; 
			}
		 	.shoucang .iconfont{
				font-size: 18px;
			}
			.dealcard .title, .dealcard .price{
				margin-top: 20px;
				font-size: 12px;
			}
			.coupon p{
				margin: 10px 0 3px;
				
			}
			.dealcard .brand { 
			    overflow: hidden;
			    text-overflow: ellipsis;
			    white-space: nowrap;
			    line-height: 30px;
			}
			#thePlus{
				position: fixed;
				bottom: 10px;
				left: 50%;
				display: block;
				margin-left: -25px;
				font-size: 50px;
				background-color: #f53c42;
				color: #fff;
				border-radius: 50%;
				box-shadow: 0 0 10px #555;
			}
			.branddiv{display: -webkit-box;
				-webkit-box-orient: vertical;
				-webkit-line-clamp: 2;
				overflow: hidden;}
			.dealcard .title{margin-top: 0;}
			.dealcard .coupon span {
			    bottom: 6px;color: #f53c42;
			}
			.imgbox{background: none !important;}
			.dealcard dd{margin-bottom: 0;padding: 10px 15px;padding-bottom: 0;}
			.dealcard dd{border: none;}
			.dealcard dd:last-child:after{
				height: 0px;
			} 
			.dealcard dd:after{
				content: '';
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(.5);
			}
			.dealcard dd a{padding-bottom: 13px;}
			div.screening>ul{border: none;}
			div.screening>ul>li{border-left: none!important;padding-right: 3%;}
			.dealcard .coupon{border: none;}
			.coupon p, .dealcard .coupon{margin: 0;}
			#thePlus2{font-size: 16px;margin-top: 1px;}
			.typespan{
				border: 1px solid #f53c42;
			    border-radius: 5px;
			    font-size: 9px;
			    padding: 1px 2px;
			    color: #f53c42;
			    font-weight: 100;
			    display: inline-block;
			    float: right;
			    margin-right: 4px;
			}
			.dealcard-waimai {
			    padding-top: 35px !important;
			}
			header.mui-bar-nav{box-shadow: none !important;}
			.grade-eject>ul>li, .Category-eject>ul>li, .Sort-eject>ul>li{border-bottom: none!important;position: relative;}
			.grade-eject>ul>li:after, .Category-eject>ul>li:after, .Sort-eject>ul>li:after{content: '';
				display: block;
				height: 1px;
				background-color: #eee;
				-webkit-transform: scaleY(.5);right: 5px;}
			div.screening>ul>li{
				background: url(../../img/localLife/xiala.png) no-repeat 68% center;
    			background-size: 12%;
			}
			.grade-w-roll{top: 105px!important;}
			 .follow{
				position: relative;
				background-color: white; 
				padding:18px 15px 15px; 
			}  
			 .follow:after{
			 	position: absolute;
			 	content: '';
			 	height: 1px;
			 	left: 10px;
			 	right: 10px;
				-webkit-transform: scaleY(.3);
				background: #CACACA;
				bottom: 0;
			 }
			 .follow:last-child:after{ 
			 	height: 0px; 
			 }
			 
			.fchidl{
				display: flex;
				align-items: center;
				justify-content: space-between; 
			}  
			.userAvator{  
				width: 30px;
				height: 30px;   
				border-radius: 50%;
				margin-right: 15px;
			} 
			.fchidl>div{
				vertical-align: middle;
				display: flex;
			    font-size: 15px;	
			    text-align: left; 
			    align-items: center;
			 }
			 .text{
			 	color: #999;
			 }  
			.diyButton{background: url(../../img/answer/bouttonbr.png) no-repeat ;background-position: left top;background-size: 100% 100%;text-align: center;width: 60px;height: 25px;line-height: 25px;}
			.listCon p{padding: 10px 0px 0px 0px;} 
			.answerImf{width:calc((100vw - 50px) / 4);width:-webkit-calc((100vw - 50px) / 4);width:-moz-calc((100vw - 50px) / 4);height:calc((100vw - 50px) / 4);height:-webkit-calc((100vw - 50px) / 4);height:-moz-calc((100vw - 50px) / 4);border-radius:3px;display: inline-block;overflow: hidden;background-color: #eee;float: left;margin-right: 5px;margin-top: 5px;}
			.anImg{width: 100%;} 
			div.screening>ul>li:last-child{display: none;}
			div.screening>ul>li{width: 50% !important;}
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav fineB" id="header">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">跳蚤市场</h1>
		    <a class="fr mui-icon" id="thePlus2">发布</a>
		</header>
		
		 <div class="screening fineB" id="screeningdiv" style="top: 50px;">
		    <ul>
		        <li class="Brand">类别</li>
		        <li class="Regional">价格</li>
		        <li class="Sort">个人</li>
		    </ul>
		</div>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div class="Category-eject">
		    <ul class="Category-w" id="Categorytw" style="height: auto;">
		        <li onclick="Loading('',0,9999999)">全部</li>
		        <li onclick="Loading(1,0,9999999,'','','','price');">机械</li>
		        <li onclick="Loading(2,0,9999999,'','','','price');">数码</li>
		        <li onclick="Loading(3,0,9999999,'','','','price');">家具</li>
		        <li onclick="Loading(4,0,9999999,'','','','price');">服装</li>
		        <li onclick="Loading(5,0,9999999,'','','','price');">文体\户外</li>
		        <li onclick="Loading(6,0,9999999,'','','','price');">手机</li>
		        <li onclick="Loading(7,0,9999999,'','','','price');">办公设备</li>
		        <li onclick="Loading(8,0,9999999,'','','','price');">代步工具</li>
		        <li onclick="Loading(9,0,9999999,'','','','price');">母婴</li>
		        <li onclick="Loading(10,0,9999999,'','','','price');">宠物</li>
		        <li onclick="Loading(11,0,9999999,'','','','price');">家电</li>
		        <li onclick="Loading(12,0,9999999,'','','','price');">其它</li>
		        
		    </ul>
		</div>
		<div class="grade-eject">
		    <ul class="grade-w" id="gradew" style="height: auto;">
		        <li onclick="Loading('',0,9999999)">全部</li>
		        <li onclick="Loading('',0,100);">100元以下</li>
		        <li onclick="Loading('',100,300);">100-300元</li>
		        <li onclick="Loading('',300,500);">300-500元</li>
		        <li onclick="Loading('',500,9999999);">500元以上</li>
		    </ul>
		</div>
		<!-- End grade -->
		<!-- Category -->
		<!--<div class="Sort-eject Sort-height">
		    <ul class="Sort-Sort" id="Sort-Sort" style="height: auto;max-height: calc(100vh * 0.8);overflow: scroll;">
		        <li onclick="Loading(1,10,'','','','','price')">全部</li>
		        <li onclick="Loading(1,10,'','','',1,'price')">个人</li>
		        <li onclick="Loading(1,10,'','','',0,'price')">商家</li>
		    </ul>
		</div>-->
		<!-- End Category -->
		<div id="container">
			<div id="main">
				<section class="dealcard-waimai">
					<dl class="dealcard listCon" id="infolistdiv">
						<!--列表loading-->
						<div id="loadingdiv" style="text-align: center;font-size: 14px;height:30px;background-color: #f2f1ee;
							line-height: 30px;color: #666;-webkit-transition: all .3s;">  
							<img style="width: 25px;margin-top: -3px;" src="../../img/loading2.svg"/> 拼命加载中...
						</div>
						<!--列表loading结束-->
					</dl>
					<script type="text/html" id="infolist">
						<%for(var i=0;i<dataList.length;i++){%>
							
							<div class="follow" onclick="opendetails(<%=dataList[i].id%>,<%=dataList[i].user_id%>)"> 
								<div class="fchidl">
									<div>
										<img class="userAvator mr25 loadPics" src="../../img/send.png" data-src="<%=dataList[i].avatar%>" />
										<div> <%=dataList[i].nickname%> </div>
									</div> 
									<div class="butright">
						            	<div class="diyButton activecl goanswer">￥<%=dataList[i].price%></div>
						           </div> 
								</div>  
								<p class="ft14 maincl" style="margin-bottom: 10px;"><%=dataList[i].content%></p> 
							 	
						 		
						 		<%if(dataList[i].picS){%>
									<%for(var j=0;j<dataList[i].picS.length;j++){%>
										<div class="answerImf">
											<img onload="imgHeight(this)" data-src="<%=dataList[i].picS[j]%>" class="anImg loadPics picOp" src=""/>
								 		</div>	
									<%}%>
								<%}%>
								<div style="clear: both;"></div>
							</div> 
						<%}%>	 
					</script>
				</section>
				<div class="upload text-center text-xs gray" id="upload"></div>
				<div id="nulldiv" style="padding-top: 20%;text-align:center;font-size: 14px;color: #999;display: none;">
					<img style="width: 30%;margin-bottom: 5%; " src="../../img/unllfabu.svg"/>
					<br />
					没有相关信息
				</div>
			</div>
			<div class="listCon"> <!--新的列表-->
				
			</div>
		</div>
		
		<!--发布-->
		<!--<a href="javascript:;"><span class="mui-icon mui-icon-plus" id="thePlus"></span></a>-->
	</body>
	<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="../../js/jquery.flexslider-min.js"></script>
	<script src="../../js/other.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/mui.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/app.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript">
	var Spagenum = 2;//实到页数
	var Ypagenum = 1;//应到页数 
	Loading('',0,9999999);//加载数据,包括上滑加载
	//添加刷新监听
	document.addEventListener('refresh', function() {
		Loading('',0,9999999);//加载数据,包括上滑加载
		
	})
	//加载方法
	function Loading(goodsType,price1,price2){
		document.getElementById("infolistdiv").innerHTML = loadstr;
		mui('#nulldiv')[0].style.display = 'none';
		$('.Category-eject').removeClass('grade-w-roll');
		$('.Sort-eject').removeClass('grade-w-roll');
		$('.grade-eject').removeClass('grade-w-roll');
		mui.plusReady(function(){
		var oldToken = plus.storage.getItem('oldToken'),cityNum = plus.storage.getItem('cityNum');
		mui.ajax(serverUrl+'/api/friends/newslist',{   									
			data:{
				'numsPerPage':6,
				'currentPage':1,
				'orderType':'DESC',
				'orderField':'create_time',
				'typeId':4,
				'isUsed':1,
				'goodsType':goodsType,
				'price':JSON.stringify({"min":price1,"max":price2})
			},
			dataType:'json',//服务器返回json格式数据
			type:'post',//HTTP请求类型 
			timeout:10000,//超时时间设置为10秒；	
			headers: {"token": oldToken,'city': cityNum},
			success:function(data){
				console.log('列表返回',data);
				if(data.errno == 0){
					var dataobj = {};
					var nowArray = data.data.data;
					for(var j = 0 ;j<nowArray.length;j++){
						//整理头像格式
						if(nowArray[j].avatar && nowArray[j].avatar!='null'){
							if(JSON.parse(nowArray[j].avatar)[0].picImg.indexOf('http') == -1){
								nowArray[j].avatar = serverimgUrl + JSON.parse(nowArray[j].avatar)[0].picImg;
							}else{
								nowArray[j].avatar = JSON.parse(nowArray[j].avatar)[0].picImg
							}
						}else{
							nowArray[j].avatar = '../img/10.png'
						}
									
						if(nowArray[j].nickname && nowArray[j].nickname !='null'){
							if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(nowArray[j].nickname)){
								nowArray[j].nickname = nowArray[j].nickname.substring(0,3)+"****"+nowArray[j].nickname.substring(7,11)
							}
						}else{
							nowArray[j].nickname = '匿名'
						}
						//整理内容图片格式
						var nowArray2 = JSON.parse(nowArray[j].pic);
						if(nowArray2.length){
							var picS = [];
							for(var k = 0 ;k<nowArray2.length;k++){
								picS.push(nowArray2[k].picImg);
							}
							nowArray[j].picS = picS;
						}
					}
					
					dataobj.dataList = data.data.data; 
					//获取并渲染用户信息
					var html=template("infolist",dataobj);
					document.getElementById("infolistdiv").innerHTML += html;
					if(data.data.totalPages){
						mui("#upload")[0].innerHTML = " ";
					}else{
						mui("#upload")[0].innerHTML = ""; 
						mui('#nulldiv')[0].style.display = 'block';
					}
					lazyLoad(true,10);
					
					//滚动到底部加载
					$(window).scroll(function(){
					　　var scrollTop = $(this).scrollTop();
					　　var scrollHeight = $(document).height();
					　　var windowHeight = $(this).height();
					　　if(scrollTop + windowHeight == scrollHeight){
							if(Spagenum<=data.data.totalPages && Spagenum==Ypagenum+1){//当前页小于等于总页数时请求下一页
								mui("#upload")[0].innerHTML = "<img src='../../img/balls.svg' />";
								Ypagenum++;//满足加载情况,应到页数+1
								console.log('发起请求,实到'+Spagenum+'页');									
								console.log('发起请求,应到'+Ypagenum+'页');
								mui.ajax(serverUrl+'/api/friends/newslist',{   									
									data:{
										'numsPerPage':6,
										'currentPage':Spagenum,
										'orderType':'DESC',
										'orderField':'create_time',
										'typeId':4,
										'isUsed':1,
										'goodsType':goodsType,
										'price':JSON.stringify({"min":price1,"max":price2})
									},
									dataType:'json',//服务器返回json格式数据
									type:'post',//HTTP请求类型 
									timeout:10000,//超时时间设置为10秒；	
									headers: {"token": oldToken,'city': cityNum},
									success:function(data){
										if(data.errno == 0){
											var dataobj = {};
											var nowArray = data.data.data;
											for(var j = 0 ;j<nowArray.length;j++){
												//整理头像格式
												if(nowArray[j].avatar && nowArray[j].avatar!='null'){
													if(JSON.parse(nowArray[j].avatar)[0].picImg.indexOf('http') == -1){
														nowArray[j].avatar = serverimgUrl + JSON.parse(nowArray[j].avatar)[0].picImg;
													}else{
														nowArray[j].avatar = JSON.parse(nowArray[j].avatar)[0].picImg
													}
												}else{
													nowArray[j].avatar = '../img/10.png'
												}
															
												if(nowArray[j].nickname && nowArray[j].nickname !='null'){
													if(/^(\(\d{3,4}\)|\d{3,4}-|\s)?\d{7,14}$/.test(nowArray[j].nickname)){
														nowArray[j].nickname = nowArray[j].nickname.substring(0,3)+"****"+nowArray[j].nickname.substring(7,11)
													}
												}else{
													nowArray[j].nickname = '匿名'
												}
												//整理内容图片格式
												var nowArray2 = JSON.parse(nowArray[j].pic);
												if(nowArray2.length){
													var picS = [];
													for(var k = 0 ;k<nowArray2.length;k++){
														picS.push(nowArray2[k].picImg);
													}
													nowArray[j].picS = picS;
												}
											}
											
											dataobj.dataList = data.data.data;
											//获取并渲染用户信息
											var html=template("infolist",dataobj);
											document.getElementById("infolistdiv").innerHTML += html;
											lazyLoad(true,10);
										}
										mui("#upload")[0].innerHTML = " ";
										Spagenum++;//加载成功,当前页+1
										console.log('成功+1,实到'+Spagenum);
										console.log('成功+1,应到'+Spagenum);
									},
									error:function(xhr,type,errorThrown){
										Ypagenum--;//失败是应到-1
										mui.toast("当前网络不好请重试");
										mui("#upload")[0].innerHTML = "";
									}
								});
							}else if(Spagenum == data.data.totalPages+1){//当前页不小于等于总页数时请求下一页
								mui("#upload")[0].innerHTML = "到底了";
							}
				　　         }
					});//加载下一部分结束
				}else{
					mui("#upload")[0].innerHTML = ""; 
					mui('#nulldiv')[0].style.display = 'block';
				}
				closeLoad();//关闭列表loading
			},
			error:function(xhr,type,errorThrown){
				closeLoad();//关闭列表loading
				mui("#upload")[0].innerHTML = ""; 
				mui('#nulldiv')[0].style.display = 'block';
			}
		});
		});	
	}
		
	
	
//发布按钮
mui('#thePlus2')[0].onclick = function(){
	if(plus.storage.getItem('myToken')){ 
		openview({
		 	view:'new_ershou.html',  
		})
	}else{//没登陆直接打开登录页面
		mui.toast('请登录');
		openview({
			view:'../login.html'
		});
	}
}
//跳转详情
function opendetails(id,userid){ 
	openview({
		view:'FleaInfo.html',
		extrasobj:{
			infoid: id,
			UserId:userid,
		}
	})
}
</script>
<script type="text/javascript">
		//天天特价  discountGoods, 领嗨豆  getHIdou, 团购  groupBuying, 本地生活 localLife, 跨境优品   loveToGogoods, 电影 movie,
		//充值缴费   payment,  为民服务  serveForPeople,  购物中心 shopCenter, 注册  signUp, 特色馆 specialBar
		mui.plusReady(function () {
			var startTime, endTime, stayTime, flagback = 0;
			startTime = new Date().getTime();
			var old_back = mui.back;
			//改写返回键返回的函数，返回时传页面停留时间 
			mui.back = function(){
				endTime = new Date().getTime();//返回时间
				stayTime = Math.ceil((endTime - startTime) / 1000);   
				console.log('购物中心'+stayTime); 
				plus.statistic.eventDuration( "localLifeErshou", stayTime);
				//计算事件，计算出返回时在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				old_back(); 
			}
			plus.webview.currentWebview().addEventListener( "popGesture", function(){
				flagback++;
				if(flagback == 1){
					endTime = new Date().getTime();
					stayTime = Math.ceil((endTime - startTime) / 1000);  
					plus.statistic.eventDuration( "localLifeErshou", stayTime);
					//计算事件，计算出苹果右滑返回后在该页面停留的时间差值，除以六万获得停留分钟数，发送给友盟后台
				}
			}, false );
		});
	</script> 
</html>